---
title: 6.Spring Cloud
---

# ç›®å½•

## ä¸€ã€Spring Cloud ä¸å¾®æœåŠ¡ä½“ç³»æ¦‚è§ˆ

- å•ä½“æ¶æ„çš„æ¼”è¿›å›°å¢ƒä¸å¾®æœåŠ¡çš„å‡ºç°
- ä»€ä¹ˆæ˜¯ Spring Cloudï¼Ÿä¸ Spring Boot çš„å…³ç³»ï¼Ÿ
- ä¸¤å¤§ä¸»çº¿ï¼šNetflix ä½“ç³» vs Alibaba ä½“ç³»
- å¾®æœåŠ¡å…­å¤§æ ¸å¿ƒæ¨¡å—æ¦‚è§ˆï¼šæœåŠ¡æ³¨å†Œã€é…ç½®ã€è°ƒç”¨ã€ç½‘å…³ã€å®¹é”™ã€é“¾è·¯è¿½è¸ª
- Spring Cloud vs Dubboï¼ŸSpring Cloud è¿˜é¦™å—ï¼Ÿ
- å¾®æœåŠ¡çš„éƒ¨ç½²ã€è¿ç»´å’Œæµ‹è¯•æˆæœ¬å¸¦æ¥çš„æŒ‘æˆ˜

------

## äºŒã€æœåŠ¡æ³¨å†Œä¸é…ç½®ä¸­å¿ƒï¼šNacos æ·±åº¦å®æˆ˜

- ä¸ºä»€ä¹ˆå›½å†…åŸºæœ¬éƒ½ç”¨ Nacosï¼Ÿå¯¹æ¯” Eureka / Consul
- Nacos ä¸¤å¤§è§’è‰²ï¼šæ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒ
- æœåŠ¡æ³¨å†Œä¸å‘ç°åŸç†
- é…ç½®çƒ­æ›´æ–°æœºåˆ¶ï¼ˆ@RefreshScopeã€é•¿è½®è¯¢ã€Pushï¼‰
- å¤šç¯å¢ƒéš”ç¦»ï¼šå‘½åç©ºé—´ + Group ç®¡ç†è§„èŒƒ
- é…ç½®æƒé™ç®¡ç†ã€åŠ å¯†ç­–ç•¥ï¼ˆKMSã€SM4ï¼‰
- YAML é…ç½®æ‹†åˆ†ã€å…¬å…±é…ç½®æŠ½å–å®è·µ
- å®æˆ˜ï¼šæœ¬åœ°å¼€å‘ â†’ dev æµ‹è¯•ç¯å¢ƒ â†’ ç”Ÿäº§é…ç½®è§„èŒƒ
- é¢è¯•å¿…é—®ï¼šNacos æ˜¯å¦‚ä½•è¿›è¡Œå¥åº·æ£€æŸ¥å’Œæƒé‡è·¯ç”±çš„ï¼Ÿ

------

## ä¸‰ã€æœåŠ¡è°ƒç”¨ä¸è´Ÿè½½å‡è¡¡ï¼šFeign + LoadBalancer å®æˆ˜

- ä¸ºä»€ä¹ˆè¯´ Feign æ˜¯æœåŠ¡é—´é€šä¿¡çš„â€œJava æ ‡å‡†å§¿åŠ¿â€ï¼Ÿ
- Spring Cloud LoadBalancerï¼šæ–°ä¸€ä»£å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨
- Feign è¯·æ±‚æµç¨‹å…¨é“¾è·¯è§£æ
- Feign è¯·æ±‚å‚æ•°ã€Headerã€Token ä¼ é€’é—®é¢˜
- Feign ä¸­ç»Ÿä¸€å¼‚å¸¸å¤„ç†æ–¹æ¡ˆ
- è¶…æ—¶é‡è¯•ã€ç†”æ–­é™çº§çš„é…ç½®ä¸å®è·µ
- è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆåŸºäºç‰ˆæœ¬/æƒé‡/åŒºåŸŸï¼‰
- é¢è¯•å¿…é—®ï¼šFeign æ€ä¹ˆå®ç°è´Ÿè½½å‡è¡¡ï¼Ÿæ”¯æŒå“ªäº›åè®®ï¼Ÿåº•å±‚æ˜¯æ€ä¹ˆå‘è¯·æ±‚çš„ï¼Ÿ

------

## å››ã€æœåŠ¡å®¹é”™ä¸é™æµä¿æŠ¤ï¼šSentinel å®æˆ˜æŒ‡å—

- Sentinel æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå®ƒæ¯” Hystrix æ›´é€‚åˆä¸­å›½äº’è”ç½‘ä¸šåŠ¡ï¼Ÿ
- ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›ï¼šæµæ§ã€ç†”æ–­ã€é™çº§
- @SentinelResource æ³¨è§£è¯¦è§£
- Feign + Sentinelï¼šfallback å’Œ blockHandler åŒºåˆ«
- çƒ­ç‚¹å‚æ•°é™æµã€é“¾è·¯é™æµã€ç³»ç»Ÿä¿æŠ¤æœºåˆ¶
- è‡ªå®šä¹‰é™æµè§„åˆ™ / è§„åˆ™æŒä¹…åŒ–ï¼ˆæ•´åˆ Nacosï¼‰
- Sentinel æ§åˆ¶å°éƒ¨ç½²ã€è§„åˆ™æ¨é€ã€é›†ç¾¤é™æµ
- Sentinel ä¸ Resilience4jã€Hystrix å¯¹æ¯”
- é¢è¯•é«˜é¢‘ï¼šSentinel ä¸ºä»€ä¹ˆæ¯” Hystrix æ›´æ¨èï¼Ÿå¦‚ä½•åšçƒ­ç‚¹é™æµï¼Ÿ

------

## äº”ã€æœåŠ¡ç½‘å…³ï¼šSpring Cloud Gateway æ·±åº¦ä½¿ç”¨

- ç½‘å…³çš„è§’è‰²å®šä½ä¸è´£ä»»è¾¹ç•Œ
- Gateway æ ¸å¿ƒç»„ä»¶ï¼šRouteLocatorã€FilterChain
- è‡ªå®šä¹‰è·¯ç”±è§„åˆ™ä¸è¯·æ±‚è½¬å‘
- å…¨å±€è¿‡æ»¤å™¨å¼€å‘ï¼šToken é‰´æƒ / TraceId åŸ‹ç‚¹ / IP é»‘ç™½åå• / è¯·æ±‚æ‹¦æˆª
- ä¸ Nacos åŠ¨æ€è·¯ç”±æ•´åˆ
- ä¸ Sentinel é›†æˆé™æµï¼ˆåŸºäº URIã€IPã€Headerï¼‰
- è¯·æ±‚æ—¥å¿—æ‰“å°ã€ç»Ÿä¸€å¼‚å¸¸å“åº”æ ¼å¼
- è·¨åŸŸï¼ˆCORSï¼‰é…ç½®ä¸ç»Ÿä¸€å¼‚å¸¸æ•è·æœºåˆ¶
- ç°åº¦å‘å¸ƒç­–ç•¥è®¾è®¡ï¼ˆåŸºäº Headerã€ç”¨æˆ·æ ‡ç­¾ã€æœåŠ¡ç‰ˆæœ¬ï¼‰
- å¯¹æ¯”åˆ†æï¼šGateway vs Zuul vs nginx + JWT

------

## å…­ã€ç»Ÿä¸€é…ç½®ä¸­å¿ƒï¼šNacos Config å…¨æµç¨‹å®è·µ

- é…ç½®ä¸­å¿ƒçš„ä½œç”¨ä¸åœºæ™¯
- Nacos é…ç½®ä¸­å¿ƒç»“æ„ï¼šDataIdã€Groupã€Namespace
- é…ç½®ç»§æ‰¿ã€è¦†ç›–ä¼˜å…ˆçº§è§„åˆ™
- å…¬å…±é…ç½®æŠ½å– + ç§æœ‰é…ç½®éš”ç¦»å®è·µ
- é…ç½®çƒ­æ›´æ–°æœºåˆ¶ï¼ˆSpring Cloud Alibaba çš„æ•´åˆæ–¹å¼ï¼‰
- å¤šç¯å¢ƒéƒ¨ç½²å»ºè®®ï¼ˆdev/test/prodï¼‰
- æœ¬åœ°ç¼“å­˜æœºåˆ¶ã€å¤±è”å®¹ç¾ç­–ç•¥
- é…ç½®æƒé™ç®¡ç†ã€æ•æ„Ÿä¿¡æ¯åŠ å¯†
- Apollo ä¸ Nacos åŒºåˆ«ï¼šåˆ°åº•é€‰è°ï¼Ÿ

------

## ä¸ƒã€é“¾è·¯è¿½è¸ªï¼šSleuth + Zipkin å…¨é“¾è·¯ç›‘æ§

- ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ªï¼Ÿä¸ºä»€ä¹ˆå¾®æœåŠ¡å¿…å¤‡ï¼Ÿ
- Sleuth åŸç†ä¸ TraceId/SpanId æ³¨å…¥æµç¨‹
- ä¸ Feignã€Gatewayã€RestTemplate çš„è¿½è¸ªé›†æˆ
- Zipkin éƒ¨ç½²ä¸æ¥å…¥ï¼ŒTrace æ•°æ®æŒä¹…åŒ–
- Sleuth + Zipkin + ELK / Skywalking å¯¹æ¯”æ–¹æ¡ˆ
- TraceId ä¼ é€’ä¸æ—¥å¿— MDC å…³è”å®è·µ
- Trace ä¸¢å¤±é—®é¢˜æ’æŸ¥

------

## å…«ã€åˆ†å¸ƒå¼äº‹åŠ¡ï¼šSeata å®æˆ˜æŒ‡å—

- ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿå¾®æœåŠ¡ä¸­å¦‚ä½•è§£å†³ä¸€è‡´æ€§ï¼Ÿ
- Seata çš„ ATã€TCCã€SAGA ä¸‰ç§äº‹åŠ¡æ¨¡å¼å¯¹æ¯”
- Seata + Nacos æ³¨å†Œä¸é…ç½®æ•´åˆ
- AT æ¨¡å¼ä¸‹çš„è‡ªåŠ¨ SQL æ‹¦æˆªä¸æ•°æ®å›æ»šæœºåˆ¶
- Undo æ—¥å¿—åŸç†ã€å…¨å±€äº‹åŠ¡æµç¨‹
- ä¸ MyBatis / Spring Boot çš„æ¥å…¥é…ç½®
- å¼‚å¸¸å¤„ç†ä¸æ•°æ®ä¸€è‡´æ€§è¡¥å¿ç­–ç•¥
- é¢è¯•çƒ­ç‚¹ï¼šSeata çš„äº‹åŠ¡æµç¨‹ã€Undo æ—¥å¿—ã€è„å†™åœºæ™¯å¦‚ä½•é¿å…ï¼Ÿ

------

## ä¹ã€å¾®æœåŠ¡å®‰å…¨ä¸ç»Ÿä¸€è®¤è¯æ–¹æ¡ˆï¼ˆJWT / OAuth2ï¼‰

- å¾®æœåŠ¡ä¸‹çš„ç»Ÿä¸€è®¤è¯æŒ‘æˆ˜
- Spring Security + JWT å®ç°æ— çŠ¶æ€è®¤è¯
- Token è§£æã€åˆ·æ–°ã€è¿‡æœŸç­–ç•¥
- Token é»‘åå•ã€æƒé™ç²’åº¦æ§åˆ¶
- åŸºäºç½‘å…³çš„ç»Ÿä¸€è®¤è¯è¿‡æ»¤å™¨
- OAuth2 å¤šæ¨¡å¼æˆæƒæµç¨‹ï¼ˆå¯†ç æ¨¡å¼ã€æˆæƒç ã€å®¢æˆ·ç«¯æ¨¡å¼ï¼‰
- å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰æ–¹æ¡ˆè®¾è®¡ä¸å®ç°
- JWT + Redis + Gateway çš„å®Œæ•´è®¤è¯æ¶æ„å®è·µ

------

## åã€é¡¹ç›®æ¶æ„å®è·µä¸æ¨¡å—æ‹†åˆ†

- æ¨èé¡¹ç›®ç»“æ„ï¼ˆgateway + service + common + auth + adminï¼‰
- æ¨¡å—åŒ–å¾®æœåŠ¡æ‹†åˆ†å»ºè®®
- å…¬å…±æ¨¡å—è®¾è®¡ï¼ˆDTOã€å¼‚å¸¸ã€æƒé™ã€å“åº”å°è£…ï¼‰
- é…ç½®ç»Ÿä¸€ã€æ—¥å¿—ç»Ÿä¸€ã€å¼‚å¸¸ç»Ÿä¸€ã€æƒé™ç»Ÿä¸€å››å¤§ç»Ÿä¸€
- å¼€å‘è§„èŒƒã€å‘½åè§„èŒƒã€æ¥å£è§„èŒƒå»ºè®®
- æ¥å£æ–‡æ¡£ç®¡ç†ï¼ˆSwagger / Knife4jï¼‰

------

## åä¸€ã€éƒ¨ç½²ã€ç›‘æ§ä¸è¿ç»´å»ºè®®

- å¤šæœåŠ¡æœ¬åœ°å¼€å‘è°ƒè¯•æŠ€å·§ï¼ˆProfile + å¤šç«¯å£ï¼‰
- Docker å®¹å™¨åŒ–éƒ¨ç½²å»ºè®®
- æœåŠ¡ç›‘æ§ï¼šSpring Boot Actuator + Prometheus + Grafana
- æ—¥å¿—é‡‡é›†æ–¹æ¡ˆï¼šELK / Loki / é˜¿é‡Œ SLS
- ç°åº¦å‘å¸ƒç­–ç•¥å®è·µï¼šNacos + Gateway + æ ‡ç­¾è·¯ç”±
- é…ç½®/æœåŠ¡ä¸­å¿ƒç¾éš¾æ¢å¤ä¸é™çº§ç­–ç•¥

------

## åäºŒã€å¸¸è§é—®é¢˜ä¸é«˜é¢‘é¢è¯•é¢˜ç²¾é€‰

- Spring Cloud çš„æ•´ä½“æ¶æ„æµç¨‹å›¾èƒ½ç”»å‡ºæ¥å—ï¼Ÿ
- Feign å’Œ RestTemplate åŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆæ¨è Feignï¼Ÿ
- Sentinel æ€ä¹ˆåšåˆ°ä¸åŒç»´åº¦çš„é™æµï¼Ÿ
- å¦‚ä½•ä¿è¯é…ç½®ä¸­å¿ƒå’Œæ³¨å†Œä¸­å¿ƒé«˜å¯ç”¨ï¼Ÿ
- JWT å¦‚ä½•è®¾è®¡åˆ·æ–°æœºåˆ¶ï¼Ÿå¦‚ä½•é˜²æ­¢è¢«ç¯¡æ”¹ï¼Ÿ
- Seata çš„ Undo æ—¥å¿—ä¼šä¸ä¼šå¤ªé‡ï¼Ÿä¼šä¸ä¼šé€ æˆä¸»åº“å‹åŠ›ï¼Ÿ
- é¢è¯•åœºæ™¯é¢˜ç²¾é€‰ï¼šç°åº¦å‘å¸ƒã€çƒ­ç‚¹é™æµã€é“¾è·¯ä¸¢å¤±æ’æŸ¥â€¦â€¦

------

# ä¸€ã€Spring Cloud ä¸å¾®æœåŠ¡ä½“ç³»æ¦‚è§ˆ

## ğŸ§± å•ä½“æ¶æ„çš„æ¼”è¿›å›°å¢ƒä¸å¾®æœåŠ¡çš„å‡ºç°

åœ¨ä¼ ç»Ÿçš„ Java Web é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¹ æƒ¯æŠŠæ‰€æœ‰ä¸šåŠ¡æ¨¡å—ï¼ˆç”¨æˆ·ã€è®¢å•ã€å•†å“ã€æ”¯ä»˜ã€è¥é”€ï¼‰å…¨éƒ¨æ‰“åŒ…è¿›ä¸€ä¸ª Spring Boot å·¥ç¨‹ä¸­ï¼Œéƒ¨ç½²ä¸€å°æœåŠ¡ï¼Œè¿ç»´ç®€å•ï¼Œå¼€å‘é›†ä¸­ï¼Œ**è¿™ç§æ¶æ„æˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œå•ä½“åº”ç”¨â€**ã€‚

ä½†éšç€ä¸šåŠ¡å¤æ‚åº¦æå‡ï¼Œå•ä½“åº”ç”¨ä¼šé‡åˆ°ä»¥ä¸‹è‡´å‘½é—®é¢˜ï¼š

- **éƒ¨ç½²è‡ƒè‚¿ï¼š** æ¯æ”¹åŠ¨ä¸€ä¸ªå°åŠŸèƒ½å°±è¦é‡æ–°æ‰“åŒ…éƒ¨ç½²æ•´ä¸ªåº”ç”¨ï¼›
- **åä½œæ•ˆç‡ä½ï¼š** å¤šäººåä½œå®¹æ˜“ä»£ç å†²çªï¼ŒCI/CD æ— æ³•æ¨¡å—åŒ–åˆ†æ²»ï¼›
- **æ‰©å±•èƒ½åŠ›å·®ï¼š** æ— æ³•æŒ‰ä¸šåŠ¡çƒ­ç‚¹æ‰©å®¹ï¼ˆå¦‚æŠ¢è´­ç³»ç»Ÿåªæƒ³æ‰©å®¹è®¢å•æœåŠ¡ï¼‰ï¼›
- **æŠ€æœ¯æ ˆä¸çµæ´»ï¼š** æƒ³åœ¨æŸä¸ªæ¨¡å—ç”¨ Kotlin / Go / Node åŸºæœ¬æ— è§£ï¼›
- **ä¸Šçº¿é£é™©æé«˜ï¼š** æ•´ä½“æœåŠ¡æŒ‚äº†ï¼Œå…¨éƒ¨ä¸šåŠ¡æ²¦é™·ï¼Œæ— æ³•åšåˆ°æ•…éšœéš”ç¦»ã€‚

äºæ˜¯å¾®æœåŠ¡æ¶æ„åº”è¿è€Œç”Ÿï¼Œå®ƒå¼ºè°ƒï¼š

> **â€œä¸€ä¸ªæœåŠ¡åªåšä¸€ä»¶äº‹ï¼Œç‹¬ç«‹å¼€å‘ã€éƒ¨ç½²ã€æ‰©å±•ã€è¿ç»´â€**

å¾®æœåŠ¡ä¸æ˜¯é“¶å¼¹ï¼Œä½†åœ¨ä¸­å¤§å‹ç³»ç»Ÿé‡Œï¼Œå®ƒçš„å¥½å¤„é€æ¸å‹å€’äº†æˆæœ¬ã€‚

------

## ğŸŒ©ï¸ ä»€ä¹ˆæ˜¯ Spring Cloudï¼Ÿä¸ Spring Boot çš„å…³ç³»ï¼Ÿ

- **Spring Bootï¼š** æ˜¯ä¸€ç§â€œå¿«é€Ÿå¼€å‘åŸºç¡€è®¾æ–½â€ï¼Œå¸®åŠ©ä½ å¿«é€Ÿæ­å»ºå•ä¸ªæœåŠ¡ï¼Œè§£å†³é…ç½®ã€å¯åŠ¨å™¨ã€çƒ­éƒ¨ç½²ç­‰é—®é¢˜ï¼›
- **Spring Cloudï¼š** æ˜¯ä¸€æ•´å¥—â€œåˆ†å¸ƒå¼æœåŠ¡æ²»ç†æ¡†æ¶â€ï¼Œå¸®åŠ©ä½ ç®¡ç† **å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´çš„åä½œé—®é¢˜**ï¼Œå¦‚æ³¨å†Œä¸­å¿ƒã€é…ç½®ä¸­å¿ƒã€æœåŠ¡è°ƒç”¨ã€ç†”æ–­é™æµã€ç½‘å…³ã€å®‰å…¨ã€é“¾è·¯è¿½è¸ªç­‰ã€‚

ç®€è€Œè¨€ä¹‹ï¼š

|          | Spring Boot     | Spring Cloud           |
| -------- | --------------- | ---------------------- |
| å…³æ³¨ç‚¹   | å•ä¸ªæœåŠ¡å¼€å‘    | å¤šä¸ªæœåŠ¡çš„åä½œæ²»ç†     |
| ä½œç”¨     | ç®€åŒ–é…ç½® & å¯åŠ¨ | ç»Ÿä¸€å¾®æœåŠ¡æ¶æ„æ–¹æ¡ˆ     |
| ç±»ä¼¼æ¯”å–» | ä¸€å—ç –          | ç›–æˆ¿å­çš„å›¾çº¸ä¸ç»„ç»‡æ–¹æ¡ˆ |

> ğŸ“Œ å°ç»“ä¸€å¥è¯ï¼š**Spring Boot è§£å†³â€œå¾®æœåŠ¡æ€ä¹ˆè·‘èµ·æ¥â€ï¼ŒSpring Cloud è§£å†³â€œå¤šä¸ªæœåŠ¡æ€ä¹ˆåä½œå¾—èµ·æ¥â€ã€‚**

------

## ğŸ”¥ Netflix ä½“ç³» vs Alibaba ä½“ç³»

Spring Cloud èµ·åˆæ˜¯åŸºäº Netflix å¼€æºç»„ä»¶æ„å»ºçš„ï¼ŒåŒ…æ‹¬ï¼š

- æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼š**Eureka**
- æœåŠ¡è°ƒç”¨ï¼š**Feign**
- è´Ÿè½½å‡è¡¡ï¼š**Ribbon**
- ç†”æ–­é™çº§ï¼š**Hystrix**
- é…ç½®ä¸­å¿ƒï¼š**Spring Cloud Config**
- ç½‘å…³ï¼š**Zuul**

ä½†è¿‘å¹´ Netflix ç³»é€æ¸è¡°é€€ï¼ŒEureka åœæ›´ã€Hystrix å¼ƒç”¨ã€Ribbon è¢« LoadBalancer å–ä»£ã€‚**å›½å†…å¤§å‚æ›´å¤šè½¬å‘ Spring Cloud Alibaba ä½“ç³»**ï¼š

| åŠŸèƒ½       | Netflix ä½“ç³»    | Alibaba ä½“ç³»             |
| ---------- | --------------- | ------------------------ |
| æ³¨å†Œä¸­å¿ƒ   | Eurekaï¼ˆå¼ƒç”¨ï¼‰  | **Nacos** âœ…              |
| é…ç½®ä¸­å¿ƒ   | Spring Config   | **Nacos** âœ…              |
| æœåŠ¡è°ƒç”¨   | Feign           | Feign                    |
| ç†”æ–­é™æµ   | Hystrixï¼ˆå¼ƒç”¨ï¼‰ | **Sentinel** âœ…           |
| ç½‘å…³       | Zuulï¼ˆå¼ƒç”¨ï¼‰    | **Spring Cloud Gateway** |
| åˆ†å¸ƒå¼äº‹åŠ¡ | æ—               | **Seata** âœ…              |

> ğŸ§  **ç‚¹è¯„ï¼š** Netflix ä½“ç³»æ›´â€œå›½é™…æ ‡å‡†â€ï¼Œä½† Alibaba ä½“ç³»æ›´è´´è¿‘ä¸­å›½ä¸šåŠ¡éœ€æ±‚ï¼Œæ˜¯å¾ˆå¤šä¸­å°å‚ã€äº’è”ç½‘å…¬å¸ä¸»æµé€‰æ‹©ã€‚

------

## ğŸ§­ å¾®æœåŠ¡çš„å…­å¤§æ ¸å¿ƒæ¨¡å—å…¨æ™¯å›¾

è¦çœŸæ­£ç©è½¬å¾®æœåŠ¡ï¼Œä½ å¿…é¡»ç†è§£ä»¥ä¸‹ **å…­å¤§æ¨¡å—**ï¼š

1. **æœåŠ¡æ³¨å†Œä¸å‘ç°**ï¼ˆNacos / Eurekaï¼‰ï¼š
    æœåŠ¡ä¸Šçº¿åè‡ªåŠ¨æ³¨å†Œï¼Œæ¶ˆè´¹è€…åŠ¨æ€è·å–åœ°å€ï¼Œé¿å…ç¡¬ç¼–ç ã€‚
2. **æœåŠ¡è°ƒç”¨ä¸è´Ÿè½½å‡è¡¡**ï¼ˆFeign + LoadBalancerï¼‰ï¼š
    æœåŠ¡ä¹‹é—´ä½¿ç”¨ HTTP æ¥å£è°ƒç”¨ï¼Œå¹¶å…·å¤‡é‡è¯•ã€è¶…æ—¶ã€è´Ÿè½½ç­–ç•¥ã€‚
3. **é…ç½®ä¸­å¿ƒ**ï¼ˆNacos Config / Apolloï¼‰ï¼š
    æ‰€æœ‰æœåŠ¡çš„é…ç½®ç»Ÿä¸€ç®¡ç†ã€åŠ¨æ€åˆ·æ–°ï¼Œå‘Šåˆ« application.yml æ··ä¹±ã€‚
4. **ç½‘å…³å±‚ Gateway**ï¼š
    ç»Ÿä¸€å…¥å£ï¼Œåšé‰´æƒã€é™æµã€ç°åº¦å‘å¸ƒã€æ—¥å¿—è¿½è¸ªç­‰ã€‚
5. **å®¹é”™ä¿æŠ¤**ï¼ˆSentinelï¼‰ï¼š
    å¯¹è°ƒç”¨é“¾ä¸Šçš„å¼‚å¸¸ã€æ…¢è°ƒç”¨ã€æµé‡è¿‡è½½æä¾›ç†”æ–­é™çº§èƒ½åŠ›ã€‚
6. **é“¾è·¯è¿½è¸ª**ï¼ˆSleuth + Zipkinï¼‰ï¼š
    åœ¨å¤šæœåŠ¡è°ƒç”¨ä¸­ï¼Œæ‰“é€š TraceIdï¼Œææ¸…æ¥šæ¯ä¸ªè¯·æ±‚éƒ½å»äº†å“ªã€‚

ï¼ˆå¯æ’ä¸€å¼ å›¾ï¼šå¾®æœåŠ¡å…­å¤§ç»„ä»¶ååŒæµç¨‹å›¾ï¼‰

------

## âš”ï¸ Spring Cloud vs Dubboï¼Œè°æ›´é€‚åˆä½ ï¼Ÿ

| å¯¹æ¯”ç»´åº¦     | Spring Cloud                    | Dubbo3                                 |
| ------------ | ------------------------------- | -------------------------------------- |
| é€šä¿¡åè®®     | åŸºäº HTTP/REST                  | åŸºäº TCPï¼ˆè‡ªå®šä¹‰åè®®ï¼‰                 |
| æ³¨å†Œä¸­å¿ƒ     | Nacos / Eureka                  | Nacos / ZooKeeper                      |
| æŠ€æœ¯å­¦ä¹ æ›²çº¿ | ä½ï¼Œä¸Šæ‰‹å¿«                      | è¾ƒé«˜ï¼Œéœ€ç†è§£ RPC æ¡†æ¶åº•å±‚              |
| å¾®æœåŠ¡ç”Ÿæ€   | å®Œæ•´é—­ç¯ï¼ˆç½‘å…³ã€é™æµã€é…ç½®ç­‰ï¼‰  | ä¸“æ³¨æœåŠ¡æ²»ç†ï¼Œéœ€æ•´åˆ Spring Cloud ç”Ÿæ€ |
| å¼€å‘æ–¹å¼     | æ¥å£ + Controllerï¼ˆHTTP é£æ ¼ï¼‰  | é¢å‘æ¥å£ï¼ˆçº¯ RPC é£æ ¼ï¼‰                |
| é€‚åˆåœºæ™¯     | é€šç”¨ Web é¡¹ç›®ï¼Œäº’è”ç½‘å¾®æœåŠ¡æ¶æ„ | é«˜æ€§èƒ½å†…éƒ¨ç³»ç»Ÿã€å¤§è§„æ¨¡æœåŠ¡è°ƒç”¨åœºæ™¯     |

> ğŸ“Œ **è§‚ç‚¹ï¼š** ä¸­å°å›¢é˜Ÿã€æ±‚èŒè·³æ§½å»ºè®®ä¼˜å…ˆæŒæ¡ Spring Cloudï¼›å¦‚æœä½ åœ¨å¤§å‚ / åšä¸­é—´ä»¶ï¼ŒDubbo æ˜¯å¿…é¡»æŒæ¡çš„é«˜çº§æ­¦å™¨ã€‚

------

## ğŸ”§ å¾®æœåŠ¡çš„éƒ¨ç½²ã€è¿ç»´å’Œæµ‹è¯•æˆæœ¬æŒ‘æˆ˜

å¾®æœåŠ¡å¹¶éé“¶å¼¹ï¼Œå®ƒå¸¦æ¥çš„é—®é¢˜ä¹Ÿå¿…é¡»è®¤æ¸…ï¼š

- **éƒ¨ç½²å¤æ‚ï¼š** å•æœåŠ¡éƒ¨ç½² â†’ å¤šæœåŠ¡ç¼–æ’ï¼ˆK8s / Docker / Jenkinsï¼‰
- **è°ƒè¯•å›°éš¾ï¼š** å•ä½“æ‰“æ–­ç‚¹è°ƒè¯•å®¹æ˜“ï¼Œå¾®æœåŠ¡è¦è·¨æœåŠ¡æŸ¥æ—¥å¿—ã€çœ‹é“¾è·¯
- **é…ç½®è†¨èƒ€ï¼š** æ¯ä¸ªæœåŠ¡éƒ½æœ‰ç‹¬ç«‹é…ç½®ï¼Œéœ€ç»Ÿä¸€ç®¡ç†ä¸éš”ç¦»ç¯å¢ƒ
- **æµ‹è¯•éº»çƒ¦ï¼š** å•å…ƒæµ‹è¯• â†’ é›†æˆæµ‹è¯• â†’ å¤šæœåŠ¡æ¨¡æ‹Ÿæµ‹è¯•æ›´éš¾å†™
- **ä¾èµ–åœ°ç‹±ï¼š** ä¸€ä¸ªæœåŠ¡å‡çº§å¯èƒ½ç‰µè¿å¤šä¸ªä¾èµ–æœåŠ¡ï¼Œæ¥å£å…¼å®¹æ€§æˆä¸ºé—®é¢˜

------

## âœ… å°ç»“ï¼šSpring Cloud æ¶æ„çš„æ ¸å¿ƒå…³é”®è¯

- è§£è€¦
- è‡ªåŠ¨åŒ–
- å¾®æœåŠ¡æ²»ç†
- ç»„ä»¶ååŒ
- äº‘åŸç”Ÿå‹å¥½
- é€‚åˆâ€œä¸­å›½äº§ä¸šäº’è”ç½‘åœºæ™¯â€

------

# äºŒã€æœåŠ¡æ³¨å†Œä¸é…ç½®ä¸­å¿ƒï¼šNacos æ·±åº¦å®æˆ˜

## ğŸ§  ä¸ºä»€ä¹ˆå›½å†…åŸºæœ¬éƒ½ç”¨ Nacosï¼Ÿå¯¹æ¯” Eureka / Consul

åœ¨æœåŠ¡æ³¨å†Œä¸é…ç½®ç®¡ç†é¢†åŸŸï¼Œå›½å†…å‡ ä¹â€œä¸€è¾¹å€’â€é€‰æ‹©äº† Nacosï¼ŒèƒŒåå¹¶éå¶ç„¶ã€‚

| ç‰¹æ€§å¯¹æ¯”     | Nacos                       | Eureka              | Consul                 |
| ------------ | --------------------------- | ------------------- | ---------------------- |
| ç»´æŠ¤å›¢é˜Ÿ     | é˜¿é‡Œå·´å·´ âœ…                  | Netflixï¼ˆå·²åœæ›´ï¼‰ âŒ | HashiCorpï¼ˆå›½å¤–ï¼‰      |
| æœåŠ¡æ³¨å†Œ     | æ”¯æŒ HTTP + gRPC + DNS      | HTTPï¼Œä»…æ”¯æŒ Java   | æ”¯æŒå¤šè¯­è¨€             |
| é…ç½®ä¸­å¿ƒ     | âœ… åŸç”Ÿé›†æˆ                  | âŒ æ— é…ç½®ä¸­å¿ƒ        | æœ‰ KV é…ç½®ï¼Œä½†ç®¡ç†ç²—ç³™ |
| å¥åº·æ£€æŸ¥æœºåˆ¶ | ä¸»åŠ¨ + è¢«åŠ¨æ£€æŸ¥ã€æƒé‡é™çº§ âœ… | ä»…å®¢æˆ·ç«¯å¿ƒè·³        | å¼ºå¤§ä½†å¤æ‚             |
| UI æ§åˆ¶å°    | ç®€æ´å¼ºå¤§                    | ç®€é™‹                | ç®€æ´ä½†é…ç½®å¼±           |
| ç¤¾åŒºä¸ç”Ÿæ€   | **å›½å†…ç»å¯¹ä¸»æµ** âœ…          | åœæ­¢ç»´æŠ¤ âŒ          | å›½å¤–ä¸ºä¸»ï¼Œç¤¾åŒºä¸æ´»è·ƒ   |

> âœ… æ€»ç»“ä¸€å¥è¯ï¼š**Nacos æ˜¯å›½å†… Java å¾®æœåŠ¡é¡¹ç›®çš„é»˜è®¤é€‰é¡¹ï¼Œå°¤å…¶é€‚é… Spring Cloud Alibaba ä½“ç³»ã€‚**

------

## ğŸ“¦ Nacos çš„ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½

Nacos ä¸æ˜¯å•ä¸€ç”¨é€”å·¥å…·ï¼Œå®ƒåŒæ—¶å…·å¤‡ï¼š

1. **æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ˆService Discoveryï¼‰**ï¼š
    ç±»ä¼¼äº Eurekaã€Consulï¼Œæ”¯æŒæœåŠ¡æ³¨å†Œã€ä¸‹çº¿é€šçŸ¥ã€å®ä¾‹åˆ—è¡¨ç»´æŠ¤ã€æƒé‡è·¯ç”±ã€å¥åº·æ£€æŸ¥ã€‚
2. **é…ç½®ä¸­å¿ƒï¼ˆConfiguration Managementï¼‰**ï¼š
    ç»Ÿä¸€ç®¡ç†é…ç½®æ–‡ä»¶ï¼ˆç±»ä¼¼ Apolloï¼‰ï¼Œæ”¯æŒåŠ¨æ€åˆ·æ–°ã€ç°åº¦é…ç½®ã€YAML æ‹†åˆ†ç­‰ã€‚

ä½ å¯ä»¥åªç”¨å…¶ä¸­ä¸€ä¸ªæ¨¡å—ï¼Œä¹Ÿå¯ä»¥ä¸¤ä¸ªéƒ½ä¸Šï¼Œç”Ÿäº§ä¸Šå¾€å¾€æ˜¯â€œä¸¤è€…å…±ç”¨â€ã€‚

------

## ğŸ”„ æœåŠ¡æ³¨å†Œä¸å‘ç°åŸç†è¯¦è§£

### æœåŠ¡æä¾›è€…ï¼ˆProviderï¼‰å¯åŠ¨æµç¨‹ï¼š

- å¯åŠ¨æ—¶è¯»å– `spring.cloud.nacos.discovery.*` é…ç½®ï¼›
- å‘ Nacos æ³¨å†Œè‡ªå·±çš„ IPã€ç«¯å£ã€æœåŠ¡åï¼ˆspring.application.nameï¼‰ï¼›
- å®šæ—¶å‘é€å¿ƒè·³ï¼Œç»´æŒâ€œåœ¨çº¿çŠ¶æ€â€ï¼›
- åœæ­¢æ—¶ä¸»åŠ¨æ³¨é”€ã€‚

### æœåŠ¡æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰è°ƒç”¨æµç¨‹ï¼š

- ä½¿ç”¨ `@LoadBalanced` + RestTemplate / Feign æ¥å£å‘èµ·è°ƒç”¨ï¼›
- ç”± Nacos Discovery Client æ‹‰å–æœåŠ¡åˆ—è¡¨ï¼›
- LoadBalancer ä»å¯ç”¨å®ä¾‹ä¸­é€‰æ‹©ä¸€å°ï¼ˆè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼‰ï¼›
- å‘èµ·è¯·æ±‚ã€‚

å¯é€šè¿‡è®¿é—® `http://localhost:8848/nacos` æŸ¥çœ‹æ³¨å†Œä¸­å¿ƒçŠ¶æ€ã€‚

------

## ğŸ”¥ é…ç½®çƒ­æ›´æ–°æœºåˆ¶è¯¦è§£

### ä¸€å›¾çœ‹æ‡‚çƒ­æ›´æ–°è¿‡ç¨‹ï¼š

```text
å®¢æˆ·ç«¯ @RefreshScope Bean
    â†“
Nacos å®¢æˆ·ç«¯ SDK
    â†“
ç›‘å¬å™¨ç›‘å¬æ•°æ®å˜åŒ–ï¼ˆé»˜è®¤é•¿è½®è¯¢ï¼‰
    â†“
å˜æ›´ååˆ·æ–° Spring Environment â†’ Bean æ³¨å…¥å€¼è‡ªåŠ¨æ›´æ–°
```

### å®ç°æœºåˆ¶ï¼š

- å®¢æˆ·ç«¯é€šè¿‡é•¿è½®è¯¢ï¼ˆæˆ– UDP æ¨é€ï¼‰æ–¹å¼ç›‘å¬é…ç½®å˜æ›´ï¼›
- å½“å‘ç°é…ç½®æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘å›è°ƒé€»è¾‘ï¼›
- Spring Boot ç¯å¢ƒå˜é‡æ›´æ–° + `@RefreshScope` ä¿®é¥°çš„ Bean é‡æ–°å®ä¾‹åŒ–ï¼›
- é…ç½®çƒ­ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯ã€‚

------

## ğŸŒ± å¤šç¯å¢ƒéš”ç¦»ï¼šå‘½åç©ºé—´ + Group ç®¡ç†è§„èŒƒ

ä¼ä¸šçº§é¡¹ç›®ä¸­ï¼Œéœ€åŒæ—¶ç®¡ç†å¤šä¸ªç¯å¢ƒï¼ˆdev / test / prodï¼‰ï¼ŒNacos æä¾›ä¸¤å±‚éš”ç¦»æœºåˆ¶ï¼š

| æ¦‚å¿µ      | ä½œç”¨       | ä½¿ç”¨å»ºè®®             |
| --------- | ---------- | -------------------- |
| Namespace | ç‰©ç†éš”ç¦»   | æ¯ä¸ªç¯å¢ƒä¸€ä¸ªå‘½åç©ºé—´ |
| Group     | é€»è¾‘åˆ†ç±»   | æŒ‰æœåŠ¡åˆ†ç»„ç®¡ç†é…ç½®   |
| DataId    | é…ç½®é¡¹æ ‡è¯† | é€šå¸¸ä¸º `æœåŠ¡å.yaml` |

### ç¤ºä¾‹ç»“æ„ï¼š

```
å‘½åç©ºé—´ï¼š
  - dev
  - test
  - prod

Group:
  - order-service
    - order.yaml
    - db.yaml
  - user-service
    - user.yaml
```

> âš ï¸ åˆ‡è®°ï¼šNamespace éš”ç¦»çš„æ˜¯æ³¨å†Œä¸­å¿ƒ & é…ç½®ä¸­å¿ƒçš„æ‰€æœ‰ä¿¡æ¯ï¼ŒGroup ä»…å½±å“é…ç½®ä¸­å¿ƒã€‚

------

## ğŸ” é…ç½®æƒé™æ§åˆ¶ä¸åŠ å¯†ç­–ç•¥

ç”Ÿäº§ç¯å¢ƒé…ç½®å¾€å¾€æ¶‰åŠæ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ•°æ®åº“å¯†ç ã€ç¬¬ä¸‰æ–¹å¯†é’¥ï¼‰ã€‚Nacos æä¾›ä¸¤ç§é˜²æŠ¤æ–¹å¼ï¼š

### 1. ç”¨æˆ· + è§’è‰²æƒé™æ§åˆ¶ï¼š

- æ”¯æŒåŸºäº RBAC çš„æƒé™æ¨¡å‹ï¼›
- é…ç½®ä¸åŒè´¦æˆ·å¯è®¿é—®çš„å‘½åç©ºé—´å’Œ Groupï¼›
- æ”¯æŒåªè¯»æƒé™ã€ç¼–è¾‘æƒé™ç­‰ã€‚

### 2. é…ç½®åŠ å¯†ï¼ˆæ¨èæ–¹å¼ï¼‰ï¼š

- æ”¯æŒå¯¹æ¥é˜¿é‡Œ KMSã€æ”¯æŒ SM2/SM4 åŠ å¯†ï¼›
- é€šè¿‡ `ENC(...)` + è§£å¯†æ’ä»¶è¿›è¡Œé…ç½®åŠ è§£å¯†ï¼›
- é¿å…æ•æ„Ÿä¿¡æ¯æ˜æ–‡æš´éœ²åœ¨é…ç½®ä¸­å¿ƒã€‚

------

## ğŸ§© YAML æ‹†åˆ† + å…¬å…±é…ç½®æŠ½å–

### å®æˆ˜å»ºè®®ï¼š

- æ‰€æœ‰æœåŠ¡å…±ç”¨çš„é…ç½®æå–ä¸º `shared.yaml`ï¼Œç”¨ `spring.cloud.nacos.config.extension-configs` å¼•å…¥ï¼›
- æ¯ä¸ªæœåŠ¡è‡ªå·±çš„é…ç½®å•ç‹¬ç»´æŠ¤ï¼›
- é¿å…é…ç½®å†²çª / é…ç½®æ±¡æŸ“ã€‚

```yaml
# application.yml ä¸­å¼•å…¥å…¬å…±é…ç½®
spring:
  cloud:
    nacos:
      config:
        extension-configs:
          - data-id: shared.yaml
            group: DEFAULT_GROUP
            refresh: true
```

------

## ğŸ› ï¸ é…ç½®éƒ¨ç½²æµç¨‹æœ€ä½³å®è·µ

| é˜¶æ®µ     | åŠ¨ä½œ                                    |
| -------- | --------------------------------------- |
| æœ¬åœ°å¼€å‘ | æ¥å…¥æœ¬åœ° Nacos å®ä¾‹ï¼Œä½¿ç”¨ dev namespace |
| æµ‹è¯•ç¯å¢ƒ | è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬åˆå§‹åŒ–æµ‹è¯•é…ç½®ã€æ•°æ®éš”ç¦»  |
| ç”Ÿäº§ç¯å¢ƒ | é…ç½®éœ€å®¡æ ¸æœºåˆ¶ï¼Œå¼€å¯æƒé™åˆ†çº§å’ŒåŠ å¯†ç­–ç•¥  |
| ç°åº¦åœºæ™¯ | Group åŒºåˆ†ç°åº¦é…ç½®ï¼ŒåŠ¨æ€è°ƒæ•´å¼€å…³        |

> âœ… å»ºè®®æ­é… Git ç®¡ç† YAMLï¼Œé¿å…äººä¸ºè¯¯æ“ä½œã€‚

------

## ğŸ¯ é¢è¯•é«˜é¢‘ï¼šNacos çš„å¥åº·æ£€æŸ¥ & æƒé‡è·¯ç”±æœºåˆ¶ï¼Ÿ

### 1. å¥åº·æ£€æŸ¥ï¼š

- **ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆè¢«åŠ¨ï¼‰ï¼š** ç”±å®¢æˆ·ç«¯å‘é€å¿ƒè·³ï¼›
- **æœåŠ¡ç«¯è¢«åŠ¨å‰”é™¤ï¼š** æ£€æµ‹è¶…è¿‡ä¸€å®šæ—¶é—´æ— å¿ƒè·³ï¼Œæ ‡è®°å®ä¾‹ä¸ºä¸å¥åº·ï¼›
- **æ”¯æŒè‡ªå®šä¹‰å¥åº·æ£€æŸ¥æ¥å£ï¼ˆå¦‚ `/actuator/health`ï¼‰**ã€‚

### 2. æƒé‡è·¯ç”±ï¼š

- æ¯ä¸ªæœåŠ¡å®ä¾‹å¯é…ç½® `weight` æƒé‡ï¼ˆé»˜è®¤ 1ï¼‰ï¼›
- LoadBalancer åœ¨é€‰å®ä¾‹æ—¶ä¼šæŒ‰æƒé‡åŠ æƒé€‰æ‹©ï¼›
- å¯ç”¨äº A/B æµ‹è¯•ã€ç°åº¦å‘å¸ƒã€æµé‡å¼•æµåœºæ™¯ã€‚

------

## âœ… å°ç»“å›é¡¾

| åŠŸèƒ½       | æ ¸å¿ƒäº®ç‚¹                                        |
| ---------- | ----------------------------------------------- |
| æœåŠ¡æ³¨å†Œ   | ä¸ Spring Boot æ·±åº¦æ•´åˆï¼Œæ”¯æŒå¥åº·æ£€æŸ¥å’Œæƒé‡æ§åˆ¶ |
| é…ç½®ä¸­å¿ƒ   | çƒ­æ›´æ–°ã€æƒé™æ§åˆ¶ã€åˆ†ç¯å¢ƒç®¡ç†ï¼Œæ”¯æŒåŠ å¯†          |
| å¤šç¯å¢ƒå®è·µ | Namespace + Group è§„èŒƒåŒ–ç®¡ç†                    |
| é¢è¯•è§†è§’   | å¼ºè°ƒåŸç†ç†è§£ + Nacos ä¸å…¶ä»–ç»„ä»¶çš„å¯¹æ¯”ä¼˜åŠ¿       |

------

# ä¸‰ã€æœåŠ¡è°ƒç”¨ä¸è´Ÿè½½å‡è¡¡ï¼šFeign + LoadBalancer å®æˆ˜

## ğŸš€ ä¸ºä»€ä¹ˆè¯´ Feign æ˜¯æœåŠ¡é—´é€šä¿¡çš„â€œJava æ ‡å‡†å§¿åŠ¿â€ï¼Ÿ

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¸æœåŠ¡ä¹‹é—´å¿…ç„¶éœ€è¦é¢‘ç¹è°ƒç”¨ã€‚ç›¸æ¯”æ‰‹åŠ¨æ‹¼ URL + RestTemplate çš„åŸå§‹æ–¹å¼ï¼Œ**Feign æä¾›äº†æ›´ç¬¦åˆé¢å‘æ¥å£ç¼–ç¨‹çš„å£°æ˜å¼è°ƒç”¨æ–¹å¼**ï¼š

```java
@FeignClient(name = "user-service")
public interface UserClient {
    @GetMapping("/user/{id}")
    UserDTO getUser(@PathVariable("id") Long id);
}
```

ä¼˜åŠ¿æ€»ç»“ï¼š

- âœ… è¯­ä¹‰æ¸…æ™°ï¼Œè´´åˆ Java æ¥å£é£æ ¼ï¼›
- âœ… å†…ç½®è´Ÿè½½å‡è¡¡ï¼ˆLoadBalancerï¼‰ï¼›
- âœ… æ˜“äºæ‰©å±•ï¼ˆæ”¯æŒæ‹¦æˆªå™¨ã€å…¨å±€é…ç½®ï¼‰ï¼›
- âœ… æ˜“äºæµ‹è¯•ã€Mockï¼›
- âœ… ä¸ Spring Cloud å„ç»„ä»¶æ·±åº¦æ•´åˆï¼ˆå¦‚ Sentinelã€OpenTelemetryï¼‰ã€‚

> ğŸ“Œ é¢è¯•è§’åº¦ï¼šFeign æ˜¯å¾®æœåŠ¡ä¸­**æœåŠ¡è§£è€¦ + å¯æ’æ‹”è®¾è®¡æ€æƒ³**çš„å…¸å‹ä½“ç°ã€‚

------

## ğŸ§  Spring Cloud LoadBalancerï¼šæ–°ä¸€ä»£å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨

### èƒŒæ™¯ï¼š

- Ribbonï¼ˆè€ç‰Œè´Ÿè½½å‡è¡¡å™¨ï¼‰åœ¨ 2021 å¹´è¢«æ ‡è®°ä¸º **å¼ƒç”¨**ï¼›
- Spring å®˜æ–¹æ¨å‡ºè‡ªå®¶ LoadBalancer ä½œä¸ºæ›¿ä»£ï¼Œå·²å®Œå…¨æ¥ç®¡ Feign é»˜è®¤è°ƒç”¨é€»è¾‘ã€‚

### ç‰¹æ€§äº®ç‚¹ï¼š

- âœ… æ— ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œè½»é‡ï¼›
- âœ… æ”¯æŒåŠ¨æ€åˆ·æ–°æœåŠ¡å®ä¾‹åˆ—è¡¨ï¼›
- âœ… å¯å®šåˆ¶ç­–ç•¥ï¼ˆæƒé‡ã€ç°åº¦ã€ç‰ˆæœ¬ç­‰ï¼‰ï¼›
- âœ… ä¸ Nacosã€Zookeeper ç­‰æ³¨å†Œä¸­å¿ƒæ— ç¼é›†æˆã€‚

> â˜• é»˜è®¤ç­–ç•¥ä¸ºï¼šè½®è¯¢ï¼ˆRoundRobinï¼‰

------

## ğŸ› ï¸ Feign è¯·æ±‚æµç¨‹å…¨é“¾è·¯è§£æ

```text
Controller â†’ Feign Client æ¥å£ â†’ åŠ¨æ€ä»£ç†ç”Ÿæˆç±»
    â†“
RequestInterceptorï¼ˆæ·»åŠ  Headerã€Tokenï¼‰
    â†“
LoadBalancerClient â†’ è·å–å¯ç”¨æœåŠ¡å®ä¾‹
    â†“
é€‰æ‹©è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆè½®è¯¢ / æƒé‡ / è‡ªå®šä¹‰ï¼‰
    â†“
é€šè¿‡ HttpClient / OkHttp / WebClient å‘èµ· HTTP è¯·æ±‚
```

ä½ å¯ä»¥é€šè¿‡æ—¥å¿—ï¼ˆ`logging.level.feign=DEBUG`ï¼‰è§‚å¯Ÿå®Œæ•´è°ƒç”¨é“¾è·¯ï¼Œä¾¿äºè°ƒè¯•ã€‚

------

## ğŸ” Feign å‚æ•°ä¸ Header / Token ä¼ é€’é—®é¢˜

### åœºæ™¯ï¼š

- è¯·æ±‚éœ€è¦æºå¸¦ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼ˆTokenã€traceIdï¼‰ï¼›
- å¾®æœåŠ¡ä¹‹é—´å¸Œæœ›ç»Ÿä¸€é“¾è·¯ä¸Šä¸‹æ–‡ã€‚

### è§£å†³æ–¹æ¡ˆï¼š

é€šè¿‡ **Feign çš„æ‹¦æˆªå™¨æœºåˆ¶ï¼ˆRequestInterceptorï¼‰** å®ç°ç»Ÿä¸€å¤„ç†ï¼š

```java
@Configuration
public class FeignInterceptor implements RequestInterceptor {
    @Override
    public void apply(RequestTemplate template) {
        String token = RequestContextHolder.getRequestAttributes()
                         .getHeader("Authorization");
        template.header("Authorization", token);
    }
}
```

> âœ… æ¨èç»Ÿä¸€å°è£…æˆ starterï¼Œåœ¨æ‰€æœ‰æœåŠ¡ä¸­å¤ç”¨ã€‚

------

## âš ï¸ Feign ä¸­ç»Ÿä¸€å¼‚å¸¸å¤„ç†æ–¹æ¡ˆ

é»˜è®¤æƒ…å†µä¸‹ï¼ŒFeign é‡åˆ° HTTP é”™è¯¯ç ï¼ˆå¦‚ 404ã€500ï¼‰ä¼šæŠ›å‡º FeignExceptionã€‚å»ºè®®é€šè¿‡ä»¥ä¸‹æ–¹å¼ç»Ÿä¸€å¤„ç†ï¼š

### 1. ä½¿ç”¨ `@ControllerAdvice + @ExceptionHandler` æ‹¦æˆªå¼‚å¸¸ï¼›

### 2. è‡ªå®šä¹‰ `ErrorDecoder`ï¼Œè½¬ä¸ºä¸šåŠ¡å¼‚å¸¸ç±»ï¼š

```java
public class MyErrorDecoder implements ErrorDecoder {
    @Override
    public Exception decode(String methodKey, Response response) {
        return new BusinessException("æœåŠ¡å¼‚å¸¸ï¼š" + response.status());
    }
}
```

------

## â±ï¸ Feign è¶…æ—¶ã€é‡è¯•ã€ç†”æ–­é™çº§å®è·µ

```yaml
feign:
  client:
    config:
      default:
        connectTimeout: 3000
        readTimeout: 5000
        loggerLevel: full
        retryer:
          period: 100
          maxPeriod: 1000
          maxAttempts: 3
```

### ç†”æ–­ä¸é™çº§ï¼šç»“åˆ Sentinel å®ç°ï¼š

```java
@FeignClient(name = "order-service", fallback = OrderClientFallback.class)
public interface OrderClient { ... }

@Component
public class OrderClientFallback implements OrderClient {
    @Override
    public OrderDTO getOrder(Long id) {
        return null; // æˆ–è¿”å›é»˜è®¤å…œåº•æ•°æ®
    }
}
```

> ğŸš¨ æ³¨æ„ï¼šSpring Cloud Alibaba æä¾›äº† Sentinel + Feign çš„æ— ç¼æ•´åˆï¼Œé‡ç‚¹æŒæ¡ã€‚

------

## ğŸŒ è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆåŸºäºç‰ˆæœ¬/æƒé‡/åŒºåŸŸï¼‰

å®é™…é¡¹ç›®ä¸­å¸¸è§éœ€æ±‚ï¼š

- æŸäº›æœåŠ¡éœ€è¦æµé‡å¼•å¯¼åˆ°æ–°ç‰ˆæœ¬å®ä¾‹ï¼›
- æŒ‰åŒºåŸŸåˆ†æµï¼ˆåŒ—äº¬æœºæˆ¿ä¼˜å…ˆè°ƒç”¨åŒ—äº¬æœåŠ¡ï¼‰ï¼›
- æ ¹æ®æƒé‡åšç°åº¦å‘å¸ƒã€‚

### å®ç°æ–¹å¼ï¼š

1. è‡ªå®šä¹‰ `ReactorServiceInstanceLoadBalancer`ï¼›
2. æ³¨å…¥ Beanï¼š

```java
@Bean
@LoadBalanced
public ReactorServiceInstanceLoadBalancer customLoadBalancer(
        Environment env, LoadBalancerClientFactory factory) {
    return new VersionAwareLoadBalancer(...);
}
```

> âœ… Nacos ä¹Ÿæ”¯æŒé…ç½®å®ä¾‹çš„ metadataï¼Œå¦‚ `version=gray`ï¼Œé…åˆç­–ç•¥è¿‡æ»¤å³å¯å®ç°ç‰ˆæœ¬è·¯ç”±ã€‚

------

## ğŸ¯ é¢è¯•å¿…é—®ï¼šFeign æ€ä¹ˆå®ç°è´Ÿè½½å‡è¡¡ï¼Ÿåº•å±‚æ€ä¹ˆå‘è¯·æ±‚ï¼Ÿæ”¯æŒå“ªäº›åè®®ï¼Ÿ

### Q1ï¼šFeign çš„è´Ÿè½½å‡è¡¡æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

- åº•å±‚é€šè¿‡ Spring Cloud LoadBalancerï¼›
- åœ¨æ¯æ¬¡å‘èµ·è¯·æ±‚å‰ï¼ŒåŠ¨æ€ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–å¯ç”¨å®ä¾‹ï¼›
- é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„å®ä¾‹ï¼Œæ„é€  URL å‘èµ·è°ƒç”¨ï¼›
- æ•´ä¸ªæµç¨‹å¯¹å¼€å‘è€…é€æ˜ï¼Œä½“ç°â€œå£°æ˜å¼â€ã€‚

### Q2ï¼šFeign æ”¯æŒå“ªäº›åè®®ï¼Ÿ

- é»˜è®¤æ”¯æŒ **HTTP åè®®**ï¼›
- é…åˆè‡ªå®šä¹‰ `Contract`ã€`Encoder/Decoder` å¯æ”¯æŒ gRPCï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ‰©å±•ï¼‰ï¼›
- é€šå¸¸ç”¨äº REST æ¥å£ï¼Œä¸é€‚åˆ WebSocket ç­‰é•¿è¿æ¥åœºæ™¯ã€‚

### Q3ï¼šåº•å±‚æ˜¯ç”¨ä»€ä¹ˆå‘è¯·æ±‚çš„ï¼Ÿ

- é»˜è®¤ï¼šJDK åŸç”Ÿ HttpURLConnectionï¼›
- å¯åˆ‡æ¢ï¼šApache HttpClientã€OkHttpã€WebClientï¼›
- æ¨èç”¨ OkHttp æˆ– WebClientï¼ˆæ›´ç°ä»£ï¼Œæ”¯æŒå¼‚æ­¥ï¼‰ã€‚

------

## âœ… å°ç»“å›é¡¾

| æŠ€æœ¯ç‚¹       | æ ¸å¿ƒè¦ç‚¹æ€»ç»“                                             |
| ------------ | -------------------------------------------------------- |
| Feign åŸç†   | åŠ¨æ€ä»£ç† + æ³¨è§£é©±åŠ¨ + æ‹¦æˆªå™¨é“¾ + LoadBalancer            |
| LoadBalancer | æ›¿ä»£ Ribbonï¼Œæ”¯æŒå¤šç­–ç•¥ï¼Œæ¨èè‡ªå®šä¹‰é€‚é…å…ƒæ•°æ®            |
| å‚æ•°ä¼ é€’     | ç”¨ RequestInterceptor å®ç° Tokenã€traceId ç­‰ Header æ³¨å…¥ |
| å¼‚å¸¸å¤„ç†     | è‡ªå®šä¹‰ ErrorDecoder + å…¨å±€å¼‚å¸¸æ‹¦æˆª                       |
| é™çº§ä¸ç†”æ–­   | å¼ºçƒˆå»ºè®®ä½¿ç”¨ Sentinel Fallback å®ç°ä¼˜é›…é™çº§å¤„ç†          |
| é¢è¯•è¦ç‚¹     | è¯·æ±‚é“¾è·¯ã€è´Ÿè½½å‡è¡¡å®ç°ã€åè®®æ”¯æŒã€ä¸å…¶ä»–æ–¹æ¡ˆçš„ä¼˜åŠ£å¯¹æ¯”   |

------

å¤ªæ£’äº†ï¼Œè¿™ä¸€èŠ‚æ˜¯å¾ˆå¤šåç«¯å­¦ä¹ è€…ç»•ä¸å¼€çš„é‡å¤´æˆã€‚Sentinel æ˜¯é˜¿é‡Œç³»å¾®æœåŠ¡ä½“ç³»çš„å‹èˆ±çŸ³ï¼Œç‰¹åˆ«é€‚åˆé«˜å¹¶å‘ã€å¤æ‚è§„åˆ™ä¸‹çš„é™æµç†”æ–­åœºæ™¯ã€‚æˆ‘æ¥æ ¹æ®ä½ çš„æçº²è¡¥å…¨è¿™ç« å†…å®¹ï¼Œæ—¢å®æˆ˜ï¼Œåˆå¤Ÿæ·±åº¦ï¼Œè¿˜ç©¿æ’é¢è¯•é‡ç‚¹ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

------

# å››ã€æœåŠ¡å®¹é”™ä¸é™æµä¿æŠ¤ï¼šSentinel å®æˆ˜æŒ‡å—

------

## âœ³ Sentinel æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå®ƒæ¯” Hystrix æ›´é€‚åˆä¸­å›½äº’è”ç½‘ä¸šåŠ¡ï¼Ÿ

**Sentinel æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€å¥—â€œé¢å‘åˆ†å¸ƒå¼ç³»ç»Ÿçš„é«˜å¯ç”¨æµé‡é˜²æŠ¤ç»„ä»¶â€**ï¼Œä¸»è¦è§£å†³åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼š

- æµé‡æ§åˆ¶ï¼ˆé™æµï¼‰
- ç†”æ–­é™çº§
- ç³»ç»Ÿä¿æŠ¤ï¼ˆè´Ÿè½½/RT ç›‘æ§ï¼‰

ç›¸æ¯” Netflix çš„ Hystrixï¼š

| å¯¹æ¯”é¡¹        | Hystrixï¼ˆå·²åœæ›´ï¼‰    | Sentinelï¼ˆé˜¿é‡Œç”Ÿæ€ï¼‰            |
| ------------- | -------------------- | ------------------------------- |
| çŠ¶æ€          | åœæ­¢ç»´æŠ¤             | æ´»è·ƒæ›´æ–°ã€å›½äº§ç”Ÿæ€é€‚é…          |
| åŠŸèƒ½          | ç†”æ–­ã€éš”ç¦»ã€Fallback | +æµæ§ +çƒ­ç‚¹é™æµ +ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ |
| æ§åˆ¶å°        | æ— å®˜æ–¹æ§åˆ¶å°         | å†…ç½®æ§åˆ¶å°æ”¯æŒè§„åˆ™å¯è§†åŒ–é…ç½®    |
| ä¸ Nacos é…åˆ | è¾ƒéš¾                 | åŸç”Ÿæ”¯æŒè§„åˆ™æŒä¹…åŒ–ã€æ¨é€ã€ç°åº¦  |
| æ€§èƒ½å¼€é”€      | é«˜                   | æ›´è½»é‡çº§ï¼Œæ€§èƒ½å¥½                |

> âœ… **æ€»ç»“**ï¼šSentinel æ˜¯â€œä¸ºå¤§è§„æ¨¡æœåŠ¡ç¨³å®šæ€§è€Œç”Ÿâ€ï¼Œå°¤å…¶é€‚åˆä¸­å›½çš„ç”µå•†ã€æ”¯ä»˜ã€é«˜å¹¶å‘ç³»ç»Ÿã€‚

------

## ğŸ”º ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›ï¼šæµæ§ã€ç†”æ–­ã€é™çº§

### 1. æµæ§ï¼ˆé™æµï¼‰ï¼š

- QPS æ¨¡å¼ï¼šæ¯ç§’è¯·æ±‚æ•°è¶…è¿‡é˜ˆå€¼ï¼Œè§¦å‘æ‹’ç»
- å¹¶å‘çº¿ç¨‹æ•°æ¨¡å¼
- æ”¯æŒâ€œå¿«é€Ÿå¤±è´¥â€ã€â€œæ’é˜Ÿç­‰å¾…â€æ¨¡å¼

### 2. ç†”æ–­ï¼š

- RTã€å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°è¶…è¿‡é˜ˆå€¼ï¼Œä¸´æ—¶æ–­å¼€è°ƒç”¨é“¾ï¼Œé˜²æ­¢çº§è”æ•…éšœ

### 3. é™çº§ï¼š

- æŸäº›æ¥å£é•¿æœŸä¸ç¨³å®šæ—¶ä¸»åŠ¨é™çº§ï¼Œè¿”å›å…œåº•å“åº”ï¼ˆfallbackï¼‰

------

## ğŸ”§ `@SentinelResource` æ³¨è§£è¯¦è§£

è¿™æ˜¯ä½¿ç”¨ Sentinel çš„ä¸»è¦æ–¹å¼ä¹‹ä¸€ï¼Œç”¨äºæ ‡è®°èµ„æºï¼ˆæ–¹æ³•ï¼‰å¹¶å£°æ˜é™æµã€é™çº§å¤„ç†é€»è¾‘ã€‚

```java
@SentinelResource(value = "getUser", fallback = "fallbackHandler", blockHandler = "blockHandler")
public User getUser(String id) {
    ...
}
```

### å‚æ•°è¯´æ˜ï¼š

- `value`: èµ„æºåï¼Œå”¯ä¸€æ ‡è¯†
- `fallback`: å¼‚å¸¸æ—¶æ‰§è¡Œçš„æ–¹æ³•ï¼ˆå¦‚æ¥å£å¼‚å¸¸ï¼‰
- `blockHandler`: è¢«é™æµæˆ–é™çº§æ—¶æ‰§è¡Œçš„æ–¹æ³•ï¼ˆSentinel æ‹¦æˆªï¼‰

------

## ğŸ¤ Feign + Sentinelï¼šfallback å’Œ blockHandler åŒºåˆ«

Spring Cloud Alibaba æä¾›äº†ä¸ Feign çš„åŸç”Ÿæ•´åˆï¼š

```java
@FeignClient(name = "order-service", fallback = OrderFallback.class, configuration = SentinelConfig.class)
public interface OrderClient { ... }
```

### åŒºåˆ«ï¼š

| æƒ…å†µ                  | fallback è§¦å‘ | blockHandler è§¦å‘ |
| --------------------- | ------------- | ----------------- |
| è¢« Sentinel é™æµ/ç†”æ–­ | âŒ             | âœ…                 |
| è¢«è°ƒç”¨æ–¹æ³•æŠ›å¼‚å¸¸      | âœ…             | âŒ                 |

â†’ **æœ€ä½³å®è·µ**ï¼šä¸¤è€…éƒ½å†™ï¼Œä¿è¯å¼‚å¸¸ä¸é™æµåœºæ™¯ä¸‹éƒ½èƒ½å¤„ç†ã€‚

------

## ğŸŒ€ çƒ­ç‚¹å‚æ•°é™æµã€é“¾è·¯é™æµã€ç³»ç»Ÿä¿æŠ¤æœºåˆ¶

### çƒ­ç‚¹é™æµï¼š

- æŸäº›å‚æ•°ç‰¹åˆ«â€œçƒ­é—¨â€ï¼ˆå¦‚æ‰‹æœºå·ã€å•†å“ IDï¼‰â†’ ç‹¬ç«‹é™æµ
- ç¤ºä¾‹ï¼š

```java
@SentinelResource(value = "getOrder", blockHandler = "hotParamHandler")
public String getOrder(@RequestParam("itemId") Long itemId) { ... }
```

### é“¾è·¯é™æµï¼š

- åŒä¸€ä¸ªæ¥å£è¢«å¤šä¸ªä¸Šæ¸¸è°ƒç”¨ï¼Œå¯ä»¥ä¸ºâ€œæ¥æº + èµ„æºâ€è®¾ç½®ç‹¬ç«‹è§„åˆ™ï¼ˆé˜²é›ªå´©ï¼‰

### ç³»ç»Ÿä¿æŠ¤ï¼š

- æ ¹æ®ç³»ç»Ÿçš„æ•´ä½“ RTã€çº¿ç¨‹æ•°ã€Load1 ç­‰åŠ¨æ€è§¦å‘ä¿æŠ¤

------

## âš™ï¸ è‡ªå®šä¹‰é™æµè§„åˆ™ / æŒä¹…åŒ–é…ç½®ï¼ˆæ•´åˆ Nacosï¼‰

ä»£ç åŠ¨æ€åŠ è½½è§„åˆ™ï¼š

```java
FlowRule rule = new FlowRule();
rule.setResource("getUser");
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setCount(10);
FlowRuleManager.loadRules(Collections.singletonList(rule));
```

å®é™…é¡¹ç›®æ¨èï¼š

âœ… é€šè¿‡ Sentinel æ§åˆ¶å° â†’ æ¨é€è§„åˆ™åˆ° Nacos â†’ å®¢æˆ·ç«¯åŠ¨æ€æ‹‰å–ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
 é…ç½®æ–¹å¼ï¼š

```yaml
spring:
  cloud:
    sentinel:
      datasource:
        flow:
          nacos:
            server-addr: 127.0.0.1:8848
            data-id: sentinel-rules
            group-id: DEFAULT_GROUP
            rule-type: flow
```

------

## ğŸ“Š Sentinel æ§åˆ¶å°éƒ¨ç½²ã€æ¨é€ã€é›†ç¾¤é™æµ

æ§åˆ¶å°éƒ¨ç½²æ–¹å¼ï¼š

```bash
java -Dserver.port=8858 -Dcsp.sentinel.dashboard.server=localhost:8858 -jar sentinel-dashboard.jar
```

### é«˜çº§åŠŸèƒ½ï¼š

- å¤šæœåŠ¡ç»Ÿä¸€æ¥å…¥ â†’ æ§åˆ¶å°ç»Ÿä¸€ç®¡ç†
- é›†ç¾¤é™æµæ¨¡å¼ï¼ˆæ¯”å•æœºæ›´ç²¾ç»†ï¼Œé€‚åˆå¤§æµé‡åº”ç”¨ï¼‰
- æ¨é€æœºåˆ¶ï¼ˆè§„åˆ™å˜æ›´ â†’ å®æ—¶ç”Ÿæ•ˆï¼‰

------

## âš–ï¸ Sentinel vs Resilience4j vs Hystrix

| ç‰¹æ€§           | Sentinel        | Resilience4j      | Hystrix (åœæ›´) |
| -------------- | --------------- | ----------------- | -------------- |
| æ˜¯å¦ç»´æŠ¤       | âœ… æ´»è·ƒ          | âœ… æ´»è·ƒ            | âŒ åœæ›´         |
| åŠŸèƒ½è¦†ç›–       | âœ… æœ€å…¨ï¼ˆ+é™æµï¼‰ | âœ… ç†”æ–­ã€é‡è¯•ç­‰    | âœ… åŸºç¡€ç†”æ–­é™çº§ |
| æ§åˆ¶å°æ”¯æŒ     | âœ… å›¾å½¢åŒ–        | âŒï¼ˆæ— å®˜æ–¹æ§åˆ¶å°ï¼‰ | âŒ              |
| é˜¿é‡Œç”Ÿæ€å…¼å®¹æ€§ | âœ… å®Œç¾å…¼å®¹      | âŒ                 | âŒ              |
| å­¦ä¹ æ›²çº¿       | ä¸­              | ä½                | ä½             |

> ğŸ¯ å»ºè®®ä¸­å›½åç«¯å¼€å‘è€…é¦–é€‰ Sentinelï¼Œå°¤å…¶æ˜¯ä¸ Nacosã€Feignã€Gateway çš„æ·±åº¦æ•´åˆä¼˜åŠ¿æ˜æ˜¾ã€‚

------

## ğŸ¯ é¢è¯•é«˜é¢‘ï¼š

1. **Sentinel ä¸ºä»€ä¹ˆæ¯” Hystrix æ›´æ¨èï¼Ÿ**
   - Hystrix å·²åœæ›´ï¼ŒåŠŸèƒ½æœ‰é™ï¼Œä¸æ”¯æŒé™æµ/æ§åˆ¶å°/Nacos
   - Sentinel æ”¯æŒæ›´å¼ºç­–ç•¥ï¼Œé…å¥—å®Œå–„ï¼ˆæ§åˆ¶å° + æŒä¹…åŒ– + çƒ­ç‚¹é™æµï¼‰
2. **çƒ­ç‚¹é™æµæ€ä¹ˆå®ç°ï¼Ÿ**
   - æ ‡æ³¨ `@SentinelResource`
   - æ§åˆ¶å°é…ç½®å‚æ•°ç±»å‹é™æµï¼ˆå¦‚å•†å“ IDã€æ‰‹æœºå·ç­‰ï¼‰
   - æ”¯æŒé™æµé¢‘ç‡ + å•ä¸ªå€¼é˜ˆå€¼è®¾å®š

------

## âœ… å°ç»“å›é¡¾

| èƒ½åŠ›ç‚¹         | å®è·µå»ºè®®                                                 |
| -------------- | -------------------------------------------------------- |
| æµæ§           | æ ¸å¿ƒä¿éšœç³»ç»Ÿâ€œæ´»ç€â€ï¼ŒæŒæ¡ QPS/çº¿ç¨‹æ•°ä¸¤ç§æ¨¡å¼              |
| é™çº§ä¸ç†”æ–­     | ä¸åŒå¼‚å¸¸åœºæ™¯èµ° fallback / blockHandler                   |
| å‚æ•°é™æµ       | ä¸šåŠ¡çƒ­ç‚¹å‚æ•°ï¼ˆæ‰‹æœºå·ã€å•†å“ IDï¼‰åº”é…ç½®çƒ­ç‚¹è§„åˆ™            |
| æ§åˆ¶å° + Nacos | æ¨èæ§åˆ¶å°é…ç½® + Nacos æŒä¹…åŒ– + è‡ªåŠ¨æ¨é€                 |
| é¢è¯•           | èƒŒä¸‹æ¥ï¼šä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ + ç†”æ–­ vs é™æµ + æ§åˆ¶å°å¦‚ä½•æ¨é€è§„åˆ™ |

------

# äº”ã€æœåŠ¡ç½‘å…³ï¼šSpring Cloud Gateway æ·±åº¦ä½¿ç”¨

------

## ğŸšª ç½‘å…³çš„è§’è‰²å®šä½ä¸è´£ä»»è¾¹ç•Œ

Spring Cloud Gateway æ˜¯å¾®æœåŠ¡ç³»ç»Ÿçš„â€œç»Ÿä¸€å…¥å£â€ï¼Œå…¶èŒè´£åŒ…æ‹¬ï¼š

- **è¯·æ±‚è·¯ç”±è½¬å‘**
- **ç»Ÿä¸€èº«ä»½è®¤è¯ä¸é‰´æƒ**
- **è®¿é—®æ§åˆ¶ä¸é™æµ**
- **ç°åº¦å‘å¸ƒ**
- **è·¨åŸŸã€æ—¥å¿—åŸ‹ç‚¹ã€å¼‚å¸¸ç»Ÿä¸€å¤„ç†**

> ğŸ“Œ ç½‘å…³ = å¾®æœåŠ¡â€œç¬¬ä¸€é“é˜²çº¿â€ï¼Œä¸åšä¸šåŠ¡ï¼Œåªåšæ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚

------

## ğŸ§  Gateway æ ¸å¿ƒç»„ä»¶ï¼š`RouteLocator`ã€`FilterChain`

- **RouteLocator**ï¼šå®šä¹‰è·¯ç”±è§„åˆ™ï¼ˆåŒ¹é…æ¡ä»¶ + è½¬å‘ç›®æ ‡ï¼‰
- **GlobalFilter**ï¼šå…¨å±€è¿‡æ»¤å™¨ï¼ˆå‰ç½®/åç½®é€»è¾‘ï¼‰
- **GatewayFilter**ï¼šå±€éƒ¨è¿‡æ»¤å™¨ï¼ˆä½œç”¨äºç‰¹å®šè·¯ç”±ï¼‰

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/user/**
          filters:
            - StripPrefix=1
```

------

## ğŸ“Œ è‡ªå®šä¹‰è·¯ç”±è§„åˆ™ä¸è¯·æ±‚è½¬å‘

å¸¸è§çš„ Predicateï¼š

- `Path=/api/**`ï¼šè·¯å¾„åŒ¹é…
- `Header=X-Token, \d+`ï¼šHeader æ¡ä»¶åŒ¹é…
- `Method=GET`ï¼šè¯·æ±‚æ–¹æ³•åŒ¹é…
- `After=2024-01-01T00:00:00Z`ï¼šæ—¶é—´åŒ¹é…ï¼ˆç°åº¦åˆ©å™¨ï¼‰
- `RemoteAddr=192.168.1.1/24`ï¼šåŸºäº IP çš„æ§åˆ¶

------

## ğŸ›¡ å…¨å±€è¿‡æ»¤å™¨å¼€å‘

å®ç° `GlobalFilter` + `Ordered` æ¥å£ï¼š

```java
@Component
public class AuthFilter implements GlobalFilter, Ordered {
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // ä»Headerè¯»å–Tokenï¼Œè¿›è¡Œæ ¡éªŒ
        // æ·»åŠ TraceIdç­‰æ—¥å¿—å­—æ®µ
        // ç»Ÿä¸€æ‹¦æˆªéæ³•è¯·æ±‚
    }
    public int getOrder() {
        return -1; // è¶Šå°è¶Šä¼˜å…ˆ
    }
}
```

å…¸å‹åœºæ™¯ï¼š

- **Token é‰´æƒ**ï¼šè§£æ JWT / OAuth2 Token
- **åŸ‹ç‚¹æ—¥å¿—**ï¼šTraceId / userId / è¯·æ±‚é“¾è®°å½•
- **IP é»‘ç™½åå•æ§åˆ¶**
- **éæ³•å‚æ•°ç»Ÿä¸€æ‹¦æˆª**

------

## ğŸ”„ ä¸ Nacos åŠ¨æ€è·¯ç”±æ•´åˆ

é€šè¿‡ `Spring Cloud Gateway + Nacos Config`ï¼Œå®ç°åŠ¨æ€åŠ è½½è·¯ç”±é…ç½®ï¼š

```yaml
spring:
  cloud:
    nacos:
      config:
        shared-configs:
          - data-id: gateway-routes.yaml
            group: DEFAULT_GROUP
            refresh: true
```

ğŸ‘‰ æ”¹åŠ¨ Nacos ä¸­é…ç½® â†’ ç½‘å…³æ— æ„Ÿåˆ·æ–°ï¼Œæ— éœ€é‡å¯ã€‚

------

## âš¡ ä¸ Sentinel é›†æˆé™æµï¼ˆåŸºäº URIã€IPã€Headerï¼‰

é…ç½®ç¤ºä¾‹ï¼ˆGateway + Sentinelï¼‰ï¼š

```yaml
spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8858
    gateway:
      enabled: true
```

**æ”¯æŒé™æµç»´åº¦ï¼š**

- è¯·æ±‚è·¯å¾„ URI
- ç”¨æˆ· IP
- Header ä¸­çš„ç”¨æˆ·ç­‰çº§ã€æ¥æºç³»ç»Ÿç­‰

å¯ç»“åˆï¼š

- é»‘åå•æ‹¦æˆª
- ç™½åå•æ”¾è¡Œ
- æƒé‡é…ç½®åšç°åº¦æµæ§

------

## ğŸ“ƒ è¯·æ±‚æ—¥å¿—æ‰“å°ã€ç»Ÿä¸€å¼‚å¸¸å“åº”æ ¼å¼

ç»Ÿä¸€æ—¥å¿—å¤„ç†ï¼š

- è®°å½•æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´ã€æ¥æºã€è·¯å¾„ã€çŠ¶æ€ç 
- è¾“å‡º TraceIdï¼ˆé…åˆ Sleuthï¼‰

ç»Ÿä¸€å¼‚å¸¸æ ¼å¼ï¼ˆä¾‹å¦‚æ¥å£æœªç™»å½•ã€é‰´æƒå¤±è´¥ç­‰ï¼‰ï¼š

```json
{
  "code": 401,
  "message": "Token å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•",
  "timestamp": 1710000000000
}
```

å¯å°è£…ä¸ºç»Ÿä¸€ `ErrorHandler` æˆ–åœ¨ `GlobalFilter` ä¸­å¤„ç†ã€‚

------

## ğŸŒ è·¨åŸŸï¼ˆCORSï¼‰é…ç½®ä¸å¼‚å¸¸æ•è·æœºåˆ¶

```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsWebFilter corsWebFilter() {
        CorsConfiguration config = new CorsConfiguration();
        config.addAllowedOrigin("*");
        config.addAllowedHeader("*");
        config.addAllowedMethod("*");
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);
        return new CorsWebFilter(source);
    }
}
```

**ç»Ÿä¸€å¼‚å¸¸**ï¼šå®ç° `ErrorWebExceptionHandler`ï¼Œå¯¹ 404ã€500ã€Token é”™è¯¯ç­‰åœºæ™¯é›†ä¸­å¤„ç†ã€‚

------

## ğŸ¯ ç°åº¦å‘å¸ƒç­–ç•¥è®¾è®¡ï¼ˆHeader / ç”¨æˆ·æ ‡ç­¾ / æœåŠ¡ç‰ˆæœ¬ï¼‰

**ç›®æ ‡**ï¼šè®©æŒ‡å®šç”¨æˆ· / åŒºåŸŸ / è®¾å¤‡ä¼˜å…ˆè®¿é—®ç°åº¦æœåŠ¡

ç°åº¦è§„åˆ™ç¤ºä¾‹ï¼š

```yaml
- id: gray-route
  uri: lb://user-service-v2
  predicates:
    - Header=gray, true
    - Path=/api/user/**
```

**ç­–ç•¥å®ç°æ€è·¯ï¼š**

- ç½‘å…³æ‹¦æˆªè¯·æ±‚ â†’ æ ¹æ®ç”¨æˆ·ç»´åº¦æ‰“æ ‡ â†’ ç°åº¦è½¬å‘
- é…åˆè‡ªå®šä¹‰ Filter æˆ–å¤–éƒ¨ç°åº¦å¹³å°ï¼ˆå¦‚é˜¿é‡Œ AHASï¼‰

------

## ğŸ” å¯¹æ¯”åˆ†æï¼šGateway vs Zuul vs nginx + JWT

| é¡¹ç›®         | Spring Cloud Gateway  | Zuulï¼ˆ1.xï¼‰    | nginx + JWT             |
| ------------ | --------------------- | -------------- | ----------------------- |
| æ€§èƒ½         | âœ… Netty å¼‚æ­¥é«˜æ€§èƒ½    | âŒ Servlet é˜»å¡ | âœ… é«˜æ€§èƒ½ä½†ä¸æ”¯æŒ Java   |
| è·¨åŸŸ / JWT   | âœ… åŸç”Ÿæ”¯æŒ            | âŒ éœ€é¢å¤–é…ç½®   | âœ… å¼ºï¼Œéœ€ lua è„šæœ¬       |
| åŠ¨æ€è·¯ç”±æ”¯æŒ | âœ… Nacos çƒ­åŠ è½½        | âŒ              | âŒ é™æ€é…ç½®              |
| å¼€å‘å‹å¥½åº¦   | âœ… Java å…¨å®¶æ¡¶åŸç”Ÿæ•´åˆ | ä¸­             | âŒ éœ€é¢å¤–å­¦ä¹  nginx é…ç½® |
| ç»´æŠ¤å’Œç”Ÿæ€   | âœ… Spring å®˜æ–¹æ¨è     | âŒ å·²å¼ƒç”¨       | ä¸­ï¼Œéœ€æ­é…è®¤è¯ä¸­å¿ƒ      |

> ğŸš¨ **é¢è¯•å¸¸é—®**ï¼šä¸ºä»€ä¹ˆé€‰æ‹© Gatewayï¼Ÿå¦‚ä½•å®ç°ç°åº¦ï¼Ÿæ€ä¹ˆç»Ÿä¸€ Token è®¤è¯ï¼Ÿ

------

## âœ… å°ç»“å›é¡¾

| èƒ½åŠ›ç‚¹     | å®è·µå»ºè®®                               |
| ---------- | -------------------------------------- |
| æ ¸å¿ƒèŒè´£   | è®¤è¯ã€è½¬å‘ã€åŸ‹ç‚¹ã€é™æµã€ç°åº¦           |
| å…¨å±€è¿‡æ»¤å™¨ | å¤„ç† Tokenã€TraceIdã€æ—¥å¿—ã€å¼‚å¸¸        |
| åŠ¨æ€é…ç½®   | æ¨è Nacos + Gateway è”åŠ¨çƒ­åŠ è½½        |
| ç°åº¦ç­–ç•¥   | Header + Filter + å¤šæœåŠ¡ç‰ˆæœ¬ç®¡ç†       |
| å®‰å…¨é˜²æŠ¤   | Sentinel URI é™æµ + IP é»‘ç™½åå• + é‰´æƒ |

------

# å…­ã€ç»Ÿä¸€é…ç½®ä¸­å¿ƒï¼šNacos Config å…¨æµç¨‹å®è·µ

------

## ğŸ“Œ é…ç½®ä¸­å¿ƒçš„ä½œç”¨ä¸åœºæ™¯

å¾®æœåŠ¡ä¸‹é…ç½®å¤šæ ·ã€é¢‘ç¹å˜æ›´ã€ä¸æ˜“ç»´æŠ¤ï¼š

- å¤šæœåŠ¡å…±äº«é…ç½®ï¼ˆå¦‚æ•°æ®åº“è¿æ¥ã€Redisã€æ—¥å¿—çº§åˆ«ï¼‰
- åŠ¨æ€åˆ‡æ¢é…ç½®ï¼ˆç°åº¦å‘å¸ƒã€é™æµé˜ˆå€¼ã€å¼€å…³æ§åˆ¶ï¼‰
- å¤šç¯å¢ƒé…ç½®éš”ç¦»ï¼ˆå¼€å‘ / æµ‹è¯• / ç”Ÿäº§ï¼‰
- æ•æ„Ÿé…ç½®ç»Ÿä¸€åŠ å¯†ï¼ˆè´¦å·ã€å¯†é’¥ç­‰ï¼‰

Nacos Config æä¾›ï¼š

> ğŸ§  é›†ä¸­ç®¡ç† + åŠ¨æ€åˆ·æ–° + æƒé™æ§åˆ¶ + å¤šç»´åº¦ç¯å¢ƒåˆ’åˆ†

------

## ğŸ— Nacos é…ç½®ç»“æ„æ ¸å¿ƒï¼š`DataId`ã€`Group`ã€`Namespace`

| ç»´åº¦      | å«ä¹‰                     | ç¤ºä¾‹                         |
| --------- | ------------------------ | ---------------------------- |
| DataId    | é…ç½®é¡¹æ–‡ä»¶åï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰ | `application-dev.yaml`       |
| Group     | åˆ†ç»„ï¼ˆä¸šåŠ¡çº¿ / æ¨¡å—ï¼‰    | `DEFAULT_GROUP`ã€`PAY_GROUP` |
| Namespace | ç¯å¢ƒéš”ç¦»                 | `dev`ã€`test`ã€`prod`        |

> âœ… ç»éªŒæ¨èï¼š
>
> - Namespaceï¼šæŒ‰ç¯å¢ƒåˆ’åˆ†
> - Groupï¼šæŒ‰é¡¹ç›®æ¨¡å—åˆ’åˆ†
> - DataIdï¼šé…ç½®æ–‡ä»¶åï¼ˆä¸ Spring Boot profile å¯¹åº”ï¼‰

------

## ğŸ“š é…ç½®ç»§æ‰¿ä¸è¦†ç›–ä¼˜å…ˆçº§è§„åˆ™

åŠ è½½é¡ºåºä¸ä¼˜å…ˆçº§ï¼š

1. **æ‰©å±•é…ç½®ï¼ˆshared-configsï¼‰**
2. **æ‰©å±•é…ç½®ï¼ˆextension-configsï¼‰**
3. **åº”ç”¨é…ç½®ï¼ˆdata-id ä¸æœåŠ¡ç»‘å®šï¼‰**

ç¤ºä¾‹ï¼š

```yaml
shared-configs:
  - data-id: common.yaml
    group: COMMON_GROUP
    refresh: true

extension-configs:
  - data-id: redis.yaml
    group: INFRA_GROUP
    refresh: true
```

è§„åˆ™è¯´æ˜ï¼š

- ååŠ è½½çš„é…ç½® **ä¼˜å…ˆçº§æ›´é«˜**ï¼Œä¼šè¦†ç›–å‰é¢çš„
- å»ºè®®å°†å…¬å…±é…ç½®æ”¾åœ¨å‰é¢åŠ è½½ï¼ŒæœåŠ¡ç§æœ‰é…ç½®æ”¾åœ¨åé¢

------

## ğŸ§¬ å…¬å…±é…ç½®æŠ½å– + ç§æœ‰é…ç½®éš”ç¦»å®è·µ

- `common.yaml`ï¼šæ‰€æœ‰æœåŠ¡é€šç”¨é…ç½®ï¼ˆå¦‚æ—¥å¿—ã€nacos è¿æ¥ï¼‰
- `redis.yaml`ã€`mysql.yaml`ï¼šåŸºç¡€æœåŠ¡æŠ½å–
- `user-service.yaml`ï¼šå•ä¸ªæœåŠ¡ç§æœ‰é…ç½®

```bash
Nacos ç»“æ„å±‚çº§ç¤ºæ„ï¼š
â””â”€â”€ Namespace: dev
    â”œâ”€â”€ Group: COMMON_GROUP
    â”‚   â”œâ”€â”€ common.yaml
    â”‚   â”œâ”€â”€ redis.yaml
    â””â”€â”€ Group: USER_GROUP
        â””â”€â”€ user-service.yaml
```

------

## ğŸ”„ é…ç½®çƒ­æ›´æ–°æœºåˆ¶ï¼ˆSpring Cloud Alibaba çš„æ•´åˆï¼‰

**ä¾èµ–é…ç½®ï¼š**

```xml
<dependency>
  <groupId>com.alibaba.cloud</groupId>
  <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

**å…³é”®æ³¨è§£ï¼š**

```java
@RefreshScope // æ”¯æŒé…ç½®å˜æ›´è‡ªåŠ¨åˆ·æ–° Bean
@Value("${feature.enabled}") // åŠ¨æ€é…ç½®å­—æ®µ
```

åŠ¨æ€åˆ·æ–°åŸç†ï¼š

- å®¢æˆ·ç«¯å®šæ—¶æ‹‰å–ï¼ˆæˆ–é•¿è½®è¯¢ï¼‰
- Nacos æ¨é€å˜åŒ–
- Spring Cloud Alibaba è‡ªåŠ¨æ³¨å…¥æ›´æ–°å€¼

------

## ğŸŒ å¤šç¯å¢ƒéƒ¨ç½²å»ºè®®ï¼ˆdev / test / prodï¼‰

**å¼ºçƒˆå»ºè®®åˆ† Namespace ç®¡ç†ï¼š**

- `dev`ï¼šæœ¬åœ°è°ƒè¯•ç¯å¢ƒ
- `test`ï¼šæµ‹è¯•ç¯å¢ƒ
- `prod`ï¼šç”Ÿäº§ç¯å¢ƒï¼ˆé…ç½®ä¸¥æ ¼æ§åˆ¶ï¼‰

å‘½åè§„èŒƒå»ºè®®ï¼š

- DataIdï¼š`é¡¹ç›®å-ç¯å¢ƒ.yaml`
- Groupï¼šä¸šåŠ¡çº¿ï¼ˆå¦‚ `FIN_GROUP`ï¼‰

------

## ğŸ§· æœ¬åœ°ç¼“å­˜æœºåˆ¶ä¸å®¹ç¾ç­–ç•¥

å®¢æˆ·ç«¯å¯åŠ¨æµç¨‹ï¼š

- å…ˆä»æœ¬åœ°ç¼“å­˜è¯»å–é…ç½®ï¼ˆ`nacos/config` ç›®å½•ï¼‰
- å¯åŠ¨åä¸ Nacos åŒæ­¥
- å¦‚æœå¤±è”ï¼Œä¼˜å…ˆä½¿ç”¨ç¼“å­˜é…ç½®ç»§ç»­è¿è¡Œï¼ˆå®¹ç¾ç­–ç•¥ï¼‰

ğŸ“Œ é«˜å¯ç”¨å»ºè®®ï¼š

- éƒ¨ç½² Nacos å¤šèŠ‚ç‚¹ + VIP
- æœåŠ¡ç«¯é™é€Ÿé…ç½®é˜²æ­¢é›ªå´©
- å®¢æˆ·ç«¯è®¾å®šè¿æ¥/è¯»å–è¶…æ—¶æ—¶é—´

------

## ğŸ” é…ç½®æƒé™ç®¡ç†ã€æ•æ„Ÿä¿¡æ¯åŠ å¯†

**æ•æ„Ÿé…ç½®åŠ å¯†å»ºè®®ï¼š**

- æ¥å…¥ KMSï¼ˆå¯†é’¥ç®¡ç†æœåŠ¡ï¼‰æˆ–ä½¿ç”¨ SM4 åŠ è§£å¯†
- æœ¬åœ° + è¿œç«¯åŒé‡åŠ å¯†ç­–ç•¥
- é…ç½®æ–‡ä»¶åŠ å¯†å­—æ®µç”¨å·¥å…·åŒ…è‡ªåŠ¨è§£å¯†

**æƒé™æ§åˆ¶ï¼š**

- è§’è‰²åˆ’åˆ†ï¼šå¼€å‘è€… / è¿ç»´ / åªè¯»
- åªæˆæƒæ“ä½œæŸä¸ª Namespaceã€Groupã€DataId

------

## âš”ï¸ Apollo vs Nacosï¼šåˆ°åº•é€‰è°ï¼Ÿ

| å¯¹æ¯”ç‚¹       | Nacos                          | Apollo                         |
| ------------ | ------------------------------ | ------------------------------ |
| é…ç½®ä¸­å¿ƒåŠŸèƒ½ | âœ… é…ç½®ä¸­å¿ƒ + æ³¨å†Œä¸­å¿ƒäºŒåˆä¸€    | âœ… ä¸“æ³¨é…ç½®ä¸­å¿ƒï¼ŒåŠŸèƒ½å…¨é¢       |
| åŠ¨æ€åˆ·æ–°     | âœ… @RefreshScope è‡ªåŠ¨åˆ·æ–°       | âœ… çƒ­æ›´æ–°æœºåˆ¶å®Œæ•´ï¼Œéœ€å¼•å…¥å®¢æˆ·ç«¯ |
| å¤šç»´é…ç½®æ”¯æŒ | âœ… Namespace + Group + DataId   | âœ… Namespace + ç°åº¦ + ç¾å¤‡      |
| æƒé™ç®¡ç†     | âœ… åŸºç¡€æƒé™ï¼Œç»†ç²’åº¦è¾ƒå¼±         | âœ… æƒé™æ§åˆ¶ç»†è‡´ï¼Œå®¡è®¡æ—¥å¿—å®Œå–„   |
| UI ä½“éªŒ      | âœ… ç®€æ´ã€å DevOps              | âœ… ä¼ä¸šçº§ï¼Œç•Œé¢ç»†èŠ‚ä¸°å¯Œ         |
| ç¤¾åŒºä¸ç”Ÿæ€   | âœ… é˜¿é‡Œå®˜æ–¹ + Spring Cloud æ•´åˆ | âœ… æºç¨‹ä¸»å¯¼ï¼Œä¼ä¸šç¤¾åŒºæ´»è·ƒ       |
| ä½¿ç”¨å»ºè®®     | âœ… ä¸­å°å›¢é˜Ÿä¼˜å…ˆï¼ˆæˆæœ¬ä½ï¼‰       | âœ… å¤§å‚æˆ–å¤æ‚é…ç½®åœºæ™¯ä¼˜å…ˆ       |

ğŸ‘‰ **å›½å†…è¶‹åŠ¿**ï¼šå¤§å¤šæ•° Spring Cloud é¡¹ç›®é‡‡ç”¨ Nacosï¼Œé™¤éå·²æœ‰ Apollo ä½“ç³»ã€‚

------

## âœ… å°ç»“å»ºè®®

| èƒ½åŠ›ç‚¹             | å®è·µå»ºè®®                                |
| ------------------ | --------------------------------------- |
| ç»“æ„ç®¡ç†           | æŒ‰ Namespace ç¯å¢ƒåˆ’åˆ†ï¼ŒGroup æŒ‰æ¨¡å—åˆ’åˆ† |
| å…¬å…±é…ç½®           | æŠ½å–ä¸º shared-configs ç»Ÿä¸€ç®¡ç†          |
| é…ç½®çƒ­æ›´æ–°         | ä½¿ç”¨ @RefreshScope è‡ªåŠ¨åˆ·æ–° Bean        |
| æƒé™ / å®‰å…¨ç®¡ç†    | æ•æ„Ÿä¿¡æ¯åŠ å¯†ã€é…ç½®è¯»å†™æƒé™éš”ç¦»          |
| ä¸ Apollo é€‰å‹å¯¹æ¯” | Apollo é…ç½®æ›´å¼ºã€Nacos æˆæœ¬æ›´ä½æ›´é€šç”¨   |

------

# ä¸ƒã€é“¾è·¯è¿½è¸ªï¼šSleuth + Zipkin å…¨é“¾è·¯ç›‘æ§

------

## ğŸ¯ ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ªï¼Ÿä¸ºä»€ä¹ˆå¾®æœåŠ¡å¿…å¤‡ï¼Ÿ

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼š

- ä¸€æ¬¡ç”¨æˆ·è¯·æ±‚é€šå¸¸ä¼šç»è¿‡å¤šä¸ªæœåŠ¡ï¼ˆç”¨æˆ·æœåŠ¡ â†’ è®¢å•æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡ï¼‰
- **æ’æŸ¥é—®é¢˜å˜å¾—å¤æ‚**ï¼Œå°¤å…¶æ˜¯â€œæŸä¸ªæ¥å£å¾ˆæ…¢â€æˆ–â€œå¶å‘å¼‚å¸¸â€

é“¾è·¯è¿½è¸ªç›®æ ‡ï¼š

- æŠŠâ€œè°ƒç”¨å…¨æµç¨‹â€åƒä¸€å¼ åœ°å›¾ä¸€æ ·ç”»å‡ºæ¥
- ç¡®è®¤æ˜¯è°è°ƒç”¨äº†è°ã€ç”¨æ—¶å¤šå°‘ã€å“ªé‡Œå‡ºé”™ã€æ˜¯å¦æœ‰ä¸¢åŒ…/é‡è¯•

------

## ğŸ§¬ Sleuth æ ¸å¿ƒåŸç†ï¼šTraceId / SpanId æ³¨å…¥æµç¨‹

Spring Cloud Sleuth ä¸ºæ¯ä¸ªè¯·æ±‚ï¼š

- ç”Ÿæˆå”¯ä¸€ `TraceId`ï¼šæ ‡è¯†ä¸€æ¬¡å®Œæ•´è¯·æ±‚é“¾
- ç”Ÿæˆ `SpanId`ï¼šæ ‡è¯†æ¯ä¸€ä¸ªå­æ“ä½œï¼ˆæœåŠ¡æˆ–æ–¹æ³•å†…éƒ¨ï¼‰
- è‡ªåŠ¨å°†è¿™ä¸¤ä¸ª ID æ³¨å…¥åˆ°æ—¥å¿— MDCï¼ˆMapped Diagnostic Contextï¼‰ä¸­

ğŸ“¦ é»˜è®¤æ”¯æŒçš„ç»„ä»¶æœ‰ï¼š

- Spring MVCï¼ˆRestControllerï¼‰
- Feignã€RestTemplateã€WebClient
- Spring Gateway
- Kafkaã€RabbitMQ

ğŸ“Œ Sleuth ä¼šè‡ªåŠ¨å®Œæˆï¼š

```plaintext
1. è¯·æ±‚è¿›å…¥æ—¶ç”Ÿæˆ TraceIdã€SpanId
2. è°ƒç”¨å…¶ä»–æœåŠ¡æ—¶è‡ªåŠ¨åœ¨ header ä¸­ä¼ é€’
3. æ—¥å¿—ä¸­è‡ªåŠ¨æ‰“å° traceId æ–¹ä¾¿ grep æ—¥å¿—åˆ†æ
```

------

## ğŸ”— Feign / Gateway / RestTemplate è¿½è¸ªé›†æˆå®æˆ˜

#### âœ… Feign é›†æˆï¼š

Sleuth è‡ªåŠ¨ä¸º Feign æ·»åŠ  TraceIdï¼š

```http
GET /order-service HTTP/1.1
X-B3-TraceId: 4f7a1c8a57d3e4c1
X-B3-SpanId: 9eae2350bc8f5a7a
```

ä½ åªéœ€æ­£å¸¸å£°æ˜ FeignClientï¼ŒSleuth å°±ä¼šè‡ªåŠ¨æ¥å…¥ã€‚

------

#### âœ… Gateway é›†æˆï¼š

Gateway ä¼šè‡ªåŠ¨ç”Ÿæˆ TraceId å¹¶ä¼ å…¥ä¸‹æ¸¸æœåŠ¡ï¼ŒåŒæ—¶æ”¯æŒ Filter ä¸­åŸ‹ç‚¹ï¼š

```java
filter((exchange, chain) -> {
  String traceId = MDC.get("traceId");
  log.info("è¿›å…¥ç½‘å…³ TraceId={}", traceId);
  return chain.filter(exchange);
});
```

------

#### âœ… RestTemplate æ‰‹åŠ¨é›†æˆï¼ˆä½ç‰ˆæœ¬ï¼‰ï¼š

```java
@Bean
@LoadBalanced
public RestTemplate restTemplate() {
    return new RestTemplate();
}
```

Sleuth ä¼šæ³¨å…¥æ‹¦æˆªå™¨å°† TraceId æ³¨å…¥è¯·æ±‚å¤´ã€‚

------

## ğŸ›° Zipkinï¼šé“¾è·¯æ•°æ®çš„æ”¶é›†ä¸å¯è§†åŒ–

#### ğŸ“Œ æ ¸å¿ƒä½œç”¨ï¼š

- èšåˆæ‰€æœ‰æœåŠ¡äº§ç”Ÿçš„ Trace æ•°æ®
- å¯è§†åŒ–ï¼šè¯·æ±‚é“¾å±•ç¤º + è°ƒç”¨æ—¶é•¿ + æœåŠ¡å“åº”æ—¶é—´åˆ†æ

#### ğŸ“¦ éƒ¨ç½²æ–¹å¼ï¼š

```bash
# ä¸€è¡Œå‘½ä»¤å¿«é€Ÿå¯åŠ¨ï¼ˆæµ‹è¯•ç”¨ï¼‰
docker run -d -p 9411:9411 openzipkin/zipkin
```

#### ğŸ§© æœåŠ¡ç«¯é…ç½®ï¼š

```yaml
spring:
  zipkin:
    base-url: http://localhost:9411
    sender:
      type: web
  sleuth:
    sampler:
      probability: 1.0 # å…¨é‡é‡‡æ ·ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®® < 1
```

Zipkin ä¼šè‡ªåŠ¨æ”¶é›† Sleuth ä¸ŠæŠ¥çš„æ•°æ®ï¼Œå¹¶åœ¨ UI ä¸Šæ˜¾ç¤ºè°ƒç”¨é“¾ã€‚

------

## ğŸ§© Sleuth + Zipkin + ELK / Skywalking å¯¹æ¯”

| ç‰¹æ€§       | Sleuth + Zipkin  | ELK + TraceId    | Skywalking                |
| ---------- | ---------------- | ---------------- | ------------------------- |
| é“¾è·¯å¯è§†åŒ– | âœ… å®Œæ•´è°ƒç”¨é“¾     | âŒ éœ€æ—¥å¿—æ£€ç´¢æ‹¼æ¥ | âœ… å…¨é“¾è·¯æ‹“æ‰‘              |
| é‡‡æ ·æ§åˆ¶   | âœ… æ”¯æŒè‡ªå®šä¹‰æ¦‚ç‡ | âŒ æ—              | âœ… æ”¯æŒåŠ¨æ€è§„åˆ™            |
| é›†ç¾¤æ”¯æŒ   | âœ… å¤šèŠ‚ç‚¹ä¸ŠæŠ¥     | âœ… å¤šæœåŠ¡æ”¶é›†     | âœ… åŸç”Ÿæ”¯æŒ                |
| ä¸Šæ‰‹é—¨æ§›   | âœ… å…¥é—¨å‹å¥½       | âŒ éœ€é… ELK ç»„ä»¶  | â— é…ç½®å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜    |
| è¿ç»´æˆæœ¬   | âœ… ä¸­ç­‰           | â— é«˜ï¼ˆES ç»´æŠ¤ï¼‰  | â— é«˜ï¼ˆéœ€ Agent + Serverï¼‰ |

ğŸ‘‰ å»ºè®®ï¼š

- ä¸­å°å›¢é˜Ÿæ¨èï¼šSleuth + Zipkin
- å¤§å‚ + å…¨é“¾è·¯è§‚æµ‹ï¼šSkywalking / Jaeger

------

## ğŸ§  TraceId + æ—¥å¿— MDC å…³è”å®è·µ

ä¸ºäº†æ›´å¿«æ’æŸ¥é—®é¢˜ï¼Œæ—¥å¿—ä¸­åŠ å…¥ TraceId æ˜¯åˆšéœ€ï¼š

```java
log.info("ä¸‹å•æˆåŠŸ traceId={}", MDC.get("traceId"));
```

æˆ–ä½¿ç”¨é…ç½®è‡ªåŠ¨æ³¨å…¥ï¼š

```yaml
logging:
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%X{traceId}] - %msg%n"
```

------

## ğŸ§¨ Trace ä¸¢å¤±é—®é¢˜æ’æŸ¥æŠ€å·§

å¸¸è§ä¸¢å¤±åŸå› ï¼š

| åŸå›                        | è§£å†³æ–¹å¼                                                |
| -------------------------- | ------------------------------------------------------- |
| è‡ªå®šä¹‰çº¿ç¨‹æ± æœªä¼ é€’ TraceId | ä½¿ç”¨ `TraceableExecutorService` æˆ– `TtlExecutorService` |
| å¼‚æ­¥è°ƒç”¨æ²¡æœ‰ä¸Šä¸‹æ–‡         | æ‰‹åŠ¨ä¼ é€’ MDCï¼Œæˆ–ä½¿ç”¨ Sleuth çš„å°è£…å·¥å…·                  |
| é Spring ç®¡ç†çš„ bean      | æ‰‹åŠ¨æ¥å…¥ SleuthContext                                  |
| æ—¥å¿—åº“æœªé›†æˆ MDC           | æ£€æŸ¥ `logback.xml` æ˜¯å¦é…ç½® `%X{traceId}`               |

------

## âœ… å°ç»“å»ºè®®

| èƒ½åŠ›ç‚¹       | å®è·µå»ºè®®                                   |
| ------------ | ------------------------------------------ |
| TraceId æ§åˆ¶ | æ§åˆ¶é‡‡æ ·ç‡ï¼Œç”Ÿäº§å»ºè®®è®¾ç½®ä¸º 0.1~0.3         |
| æ—¥å¿—é›†æˆ     | å¿…é¡»åŠ  TraceIdï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜               |
| å¤šæœåŠ¡é“¾è·¯   | å…¨é“¾è·¯æ‰“é€šï¼šGateway â†’ Feign â†’ Service â†’ DB |
| å¯¹æ¯”é€‰å‹     | Zipkin å…¥é—¨å¿«ã€Skywalking åŠŸèƒ½å…¨           |

------

# å…«ã€åˆ†å¸ƒå¼äº‹åŠ¡ï¼šSeata å®æˆ˜æŒ‡å—

------

## ğŸ” ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿä¸ºä»€ä¹ˆå¾®æœåŠ¡æ¶æ„å¿…é¡»æ­£è§†å®ƒï¼Ÿ

å•ä½“åº”ç”¨ä¸­ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®åº“äº‹åŠ¡ï¼ˆå¦‚ `@Transactional`ï¼‰å³å¯ä¿è¯ä¸€è‡´æ€§ã€‚

ä½†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œ**ä¸€æ¬¡ä¸šåŠ¡æ“ä½œæ¶‰åŠå¤šä¸ªæœåŠ¡ã€å¤šä¸ªæ•°æ®åº“**ï¼Œå¦‚ï¼š

```text
ç”¨æˆ·ä¸‹å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡
```

ä¼ ç»Ÿäº‹åŠ¡å·²ç»æ— æ³•è·¨æœåŠ¡è¿›è¡Œæäº¤/å›æ»šï¼Œè¿™å°±äº§ç”Ÿäº†åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼š

- å¦‚ä½•ä¿è¯â€œè®¢å•æ‰£æ¬¾æˆåŠŸ â†’ å•†å“åº“å­˜ä¹Ÿä¸€å®šå‡å°‘â€ï¼Ÿ
- ç½‘ç»œå¼‚å¸¸æˆ–æŸä¸ªæœåŠ¡å¤±è´¥ï¼Œæ˜¯å¦èƒ½ä¿è¯å›æ»šæ•´ä¸ªé“¾è·¯ï¼Ÿ

------

## ğŸ” Seata ç®€ä»‹ï¼šé˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶

> â€œSimple Extensible Autonomous Transaction Architectureâ€

Seata æ˜¯ Spring Cloud Alibaba æ¨èçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œæä¾›ä¸‰ç§äº‹åŠ¡æ¨¡å‹ï¼š

| æ¨¡å¼     | åœºæ™¯æ¨è               | ä¼˜ç‚¹               | ç¼ºç‚¹                     |
| -------- | ---------------------- | ------------------ | ------------------------ |
| **AT**   | å…³ç³»å‹æ•°æ®åº“ã€å¼ºä¸€è‡´æ€§ | è‡ªåŠ¨ä»£ç†ã€æ— ä¾µå…¥   | SQL é™åˆ¶å¤šï¼Œæ€§èƒ½æŸè€—     |
| **TCC**  | é‡‘èã€ç”µå•†ç­‰å¼ºäº‹åŠ¡åœºæ™¯ | å¯æ§æ€§å¼ºï¼Œæ€§èƒ½è¾ƒä¼˜ | å®ç°å¤æ‚ã€ä¸šåŠ¡å¼ºä¾µå…¥     |
| **SAGA** | é•¿äº‹åŠ¡æµç¨‹ã€æŸ”æ€§äº‹åŠ¡   | è§£è€¦ï¼Œé€‚åˆæµç¨‹ç¼–æ’ | è¡¥å¿é€»è¾‘å¤æ‚ï¼Œæœ€ç»ˆä¸€è‡´æ€§ |

ğŸ”¥ AT æ˜¯å½“å‰ä½¿ç”¨æœ€å¤šçš„æ¨¡å¼ï¼ŒTCC/SAGA é€šå¸¸ç”¨äºé«˜ä¸€è‡´æ€§é‡‘èåœºæ™¯æˆ–æµç¨‹é©±åŠ¨å‹ä¸šåŠ¡ã€‚

------

## ğŸ§© Seata æ¶æ„ä¸ä¸‰å¤§æ ¸å¿ƒç»„ä»¶

| æ¨¡å—                             | ä½œç”¨                         |
| -------------------------------- | ---------------------------- |
| **TC** (Transaction Coordinator) | äº‹åŠ¡åè°ƒå™¨ï¼Œç»´æŠ¤å…¨å±€äº‹åŠ¡çŠ¶æ€ |
| **TM** (Transaction Manager)     | å‘èµ·åˆ†å¸ƒå¼äº‹åŠ¡çš„å…¥å£         |
| **RM** (Resource Manager)        | å„æ•°æ®åº“èµ„æºçš„äº‹åŠ¡å‚ä¸è€…     |

------

## ğŸ›  Seata + Nacos æ³¨å†Œä¸é…ç½®æ•´åˆ

#### é…ç½®ä¸­å¿ƒä½¿ç”¨ Nacosï¼š

```yaml
seata:
  enabled: true
  tx-service-group: my_tx_group
  registry:
    type: nacos
    nacos:
      server-addr: localhost:8848
  config:
    type: nacos
    nacos:
      server-addr: localhost:8848
```

#### Nacos ä¸­éœ€é…ç½®æœåŠ¡åï¼š

```properties
service.vgroupMapping.my_tx_group=default
```

------

## âš™ï¸ AT æ¨¡å¼æ ¸å¿ƒæœºåˆ¶ï¼šè‡ªåŠ¨ä»£ç† + Undo æ—¥å¿—

- **ç¬¬ä¸€é˜¶æ®µ**ï¼šä¸šåŠ¡æ­£å¸¸æ‰§è¡Œï¼ŒSeata è®°å½• Undo æ—¥å¿—ï¼Œ**ä¸æäº¤æ•°æ®åº“äº‹åŠ¡**
- **ç¬¬äºŒé˜¶æ®µï¼ˆæäº¤ï¼‰**ï¼šå…¨å±€äº‹åŠ¡é€šè¿‡ï¼ŒSeata TC é€šçŸ¥å„ RM æäº¤æœ¬åœ°äº‹åŠ¡
- **ç¬¬äºŒé˜¶æ®µï¼ˆå›æ»šï¼‰**ï¼šæŸä¸€ RM æŠ¥é”™ï¼ŒTC é€šçŸ¥å…¶ä»– RM ä½¿ç”¨ Undo æ—¥å¿—è¿›è¡Œæ•°æ®å›æ»š

#### Undo æ—¥å¿—å­˜å‚¨è¡¨ç»“æ„ï¼š

```sql
CREATE TABLE undo_log (
  id BIGINT NOT NULL AUTO_INCREMENT,
  branch_id BIGINT NOT NULL,
  xid VARCHAR(100) NOT NULL,
  context VARCHAR(128) NOT NULL,
  rollback_info LONGBLOB NOT NULL,
  log_status INT NOT NULL,
  log_created DATETIME,
  log_modified DATETIME,
  PRIMARY KEY(id),
  UNIQUE KEY ux_undo (xid, branch_id)
);
```

ğŸ‘‰ **æ¯ä¸€æ¬¡ AT æ¨¡å¼çš„ SQL æ›´æ–°ï¼ŒSeata ä¼šè‡ªåŠ¨åœ¨ undo_log è¡¨è®°å½•æ•°æ®å‰é•œåƒ**

------

## ğŸ§¬ ä¸ MyBatis / Spring Boot çš„æ•´åˆé…ç½®

Spring Boot é¡¹ç›®ä¸­é…ç½®å¦‚ä¸‹ï¼š

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/demo
    username: root
    password: root

seata:
  tx-service-group: my_tx_group
```

å¹¶ç”¨ `@GlobalTransactional` æ ‡è®°äº‹åŠ¡å‘èµ·æ–¹æ–¹æ³•ï¼š

```java
@GlobalTransactional
public void placeOrder() {
    orderService.createOrder();
    inventoryService.reduceStock();
}
```

------

## ğŸš¨ å¼‚å¸¸å¤„ç†ä¸è¡¥å¿æœºåˆ¶

åˆ†å¸ƒå¼åœºæ™¯ä¸­â€œå¤±è´¥å³å›æ»šâ€ä¸æ€»æ˜¯è¶³å¤Ÿï¼š

| åœºæ™¯            | å¤„ç†å»ºè®®                      |
| --------------- | ----------------------------- |
| ç½‘ç»œæŠ–åŠ¨        | Seata é»˜è®¤æœ‰é‡è¯• + çŠ¶æ€åæŸ¥   |
| TC æŒ‚äº†         | ä½¿ç”¨é›†ç¾¤éƒ¨ç½² + é«˜å¯ç”¨æ³¨å†Œä¸­å¿ƒ |
| undo_log ä¸¢å¤±   | æŒä¹…åŒ– + å®šæœŸå¤‡ä»½             |
| é SQL æ›´æ–°æ“ä½œ | ä½¿ç”¨ TCC/SAGA æ¨¡å¼            |

------

## ğŸ§  é¢è¯•çƒ­ç‚¹è§£æ

#### ğŸ”¹ Seata äº‹åŠ¡æ‰§è¡Œæµç¨‹ï¼ˆAT æ¨¡å¼ï¼‰

```
@GlobalTransactional
        â†“
   TM å‘ TC å‘èµ·å…¨å±€äº‹åŠ¡
        â†“
  RM æ‹¦æˆª SQLï¼Œè®°å½• Undo æ—¥å¿—
        â†“
ä¸šåŠ¡æ­£å¸¸æ‰§è¡Œå®Œæˆï¼ˆé˜¶æ®µä¸€ï¼‰
        â†“
TC é€šçŸ¥å„ RM æäº¤ or å›æ»šï¼ˆé˜¶æ®µäºŒï¼‰
```

#### ğŸ”¹ Undo æ—¥å¿—ä¸ºä»€ä¹ˆèƒ½ä¿è¯ä¸€è‡´æ€§ï¼Ÿ

- Undo ä¸­è®°å½•äº†æ›´æ–°å‰çš„æ•°æ®ï¼ˆè€é•œåƒï¼‰
- å›æ»šæ—¶æ ¹æ®æ—§å€¼è¿˜åŸ
- æ˜¯æœ¬åœ°äº‹åŠ¡å†…æ“ä½œï¼Œå…·å¤‡å¼ºä¸€è‡´æ€§

#### ğŸ”¹ è„å†™ã€å¹»è¯»ç­‰å¦‚ä½•é¿å…ï¼Ÿ

- Seata å»ºè®®å¼€å¯æ•°æ®åº“çš„ **è¡Œé”ï¼ˆè¡Œçº§é”å®šï¼‰** + **éè‡ªåŠ¨æäº¤äº‹åŠ¡**
- å¹¶å‘å†™å…¥æ—¶ï¼Œä¾èµ–æ•°æ®åº“çš„é”æ§åˆ¶é¿å…æ•°æ®è¦†ç›–

------

## âœ… å°ç»“å»ºè®®

| èƒ½åŠ›ç‚¹         | å»ºè®®                               |
| -------------- | ---------------------------------- |
| å®æˆ˜å…¥é—¨       | å…ˆæŒæ¡ AT æ¨¡å¼ + MyBatis æ•´åˆ      |
| æ¶æ„ç†è§£       | ç†è§£ TC/TM/RM ç»„ä»¶èŒè´£             |
| é«˜é˜¶èƒ½åŠ›       | æŒæ¡ Undo æ—¥å¿—ã€Seata è‡ªåŠ¨ä»£ç†åŸç† |
| é¢è¯•é€šå…³å…³é”®ç‚¹ | æµç¨‹å›¾ã€è„å†™åœºæ™¯ã€ä¸‰ç§æ¨¡å¼å¯¹æ¯”     |

------

å¤ªå¥½äº†ï¼Œ**å¾®æœåŠ¡å®‰å…¨å’Œç»Ÿä¸€è®¤è¯**è¿™ä¸€èŠ‚æ˜¯æ•´ä¸ª Spring Cloud å®æˆ˜ä½“ç³»ä¸­ç»•ä¸è¿‡å»çš„æ ¸å¿ƒå†…å®¹ï¼Œå¾ˆå¤šä¼ä¸šé¢è¯•ã€ç³»ç»Ÿæ¶æ„éƒ½åœ¨å›´ç»•è¿™å¥—æ–¹æ¡ˆæ‰“è½¬ã€‚

ä¸‹é¢æ˜¯æˆ‘ä¸ºä½ ç²¾å¿ƒæ•´ç†çš„ **ç¬¬ä¹ç« ç»“æ„åŒ–è®²è§£æçº²**ï¼Œç¡®ä¿è¦†ç›–åŸç†ã€å®æˆ˜ã€åœºæ™¯è½åœ°ä¸é¢è¯•è¦ç‚¹ï¼Œé€‚é…ä¸­å›½åç«¯å·¥ç¨‹å¸ˆæ—¥å¸¸å·¥ä½œ & é¢è¯•éœ€æ±‚ã€‚

------

# ä¹ã€å¾®æœåŠ¡å®‰å…¨ä¸ç»Ÿä¸€è®¤è¯æ–¹æ¡ˆï¼ˆJWT / OAuth2ï¼‰

------

## ğŸ¯ å¾®æœåŠ¡ä¸‹çš„ç»Ÿä¸€è®¤è¯æŒ‘æˆ˜

- å•ä½“ç³»ç»Ÿçš„è®¤è¯é€šå¸¸æ˜¯åŸºäº Session + Cookie
- å¾®æœåŠ¡æ¶æ„ä¸‹æœåŠ¡åˆ†æ•£ï¼Œ**å¦‚ä½•ç»Ÿä¸€ç”¨æˆ·è®¤è¯**ï¼Ÿ
- æ ¸å¿ƒé—®é¢˜ï¼š
  - ç™»å½•ä¸­å¿ƒåŒ–ã€ä¸‹å‘ Token
  - Token å¦‚ä½•ä¼ é€’ä¸æ ¡éªŒï¼Ÿ
  - æ— çŠ¶æ€æœåŠ¡å¦‚ä½•ç®¡ç†ç™»å½•æ€ï¼Ÿ

------

## ğŸ” JWT + Spring Security å®ç°æ— çŠ¶æ€è®¤è¯

#### ä»€ä¹ˆæ˜¯ JWTï¼ˆJSON Web Tokenï¼‰ï¼Ÿ

- ä¸‰æ®µç»“æ„ï¼šHeader.Payload.Signature
- æ— éœ€æœåŠ¡ç«¯ Sessionï¼Œ**ä¿¡æ¯ç›´æ¥ä¿å­˜åœ¨ Token ä¸­**
- é€‚åˆ**åˆ†å¸ƒå¼æ— çŠ¶æ€è®¤è¯**

#### å®æˆ˜å†…å®¹ï¼š

- ç”¨æˆ·ç™»å½•æˆåŠŸ â†’ ç”Ÿæˆ JWT Token è¿”å›å‰ç«¯
- å®¢æˆ·ç«¯è¯·æ±‚ â†’ æºå¸¦ JWT Token â†’ ç»Ÿä¸€è¿‡æ»¤å™¨éªŒè¯
- è‡ªå®šä¹‰ç™»å½•æ¥å£ã€è‡ªå®šä¹‰è®¤è¯é€»è¾‘ã€è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†

```java
UsernamePasswordAuthenticationToken â†’ JwtTokenProvider â†’ AuthenticationManager
```

#### JWT ç¼ºé™·ä¸åº”å¯¹ç­–ç•¥ï¼š

| é—®é¢˜               | è§£å†³æ–¹æ¡ˆ                   |
| ------------------ | -------------------------- |
| Token æ— æ³•ä¸»åŠ¨å¤±æ•ˆ | Redis ç»´æŠ¤é»‘åå•æœºåˆ¶       |
| Token ä¿¡æ¯å¯èƒ½æ³„éœ² | å¯¹ Payload åŠ å¯† / ç²¾ç®€å†…å®¹ |
| Token è¢«ç›—ç”¨       | ç»‘å®š IP / UA / å¤šå› å­æ ¡éªŒ  |

------

## â™»ï¸ Token ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥

- Access Token ä¸ Refresh Token æœºåˆ¶ï¼ˆå‚è€ƒ OAuth2 è®¾è®¡ï¼‰
- JWT è‡ªåŠ¨åˆ·æ–°æœºåˆ¶å®ç°æ–¹æ¡ˆï¼ˆæ‹¦æˆªå™¨ + Redis + å®šæ—¶åˆ·æ–°ï¼‰
- è¶…æ—¶è¸¢å‡º / å¼ºåˆ¶ä¸‹çº¿æœºåˆ¶ï¼ˆç®¡ç†åå°æ”¯æŒï¼‰

------

## ğŸš¦ åŸºäº Gateway çš„ç»Ÿä¸€è®¤è¯è¿‡æ»¤å™¨

#### ä¸ºä»€ä¹ˆç»Ÿä¸€æ”¾åœ¨ Gateway å±‚ï¼Ÿ

- æ‰€æœ‰è¯·æ±‚æµé‡å…ˆè¿‡ç½‘å…³ï¼Œé€‚åˆç»Ÿä¸€åšè®¤è¯ã€é‰´æƒã€é™æµ
- å‡å°‘æ¯ä¸ªå¾®æœåŠ¡çš„å†—ä½™è®¤è¯é€»è¾‘

#### å®ç°é€»è¾‘ï¼š

```text
è¯·æ±‚ â†’ Gateway â†’ GlobalFilter â†’ Token æ ¡éªŒ â†’ æ”¾è¡Œ or æ‹¦æˆª
```

- è§£æ JWT â†’ æ³¨å…¥ç”¨æˆ·ä¿¡æ¯åˆ° Header / è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­
- æ”¯æŒç™½åå•ï¼ˆé™æ€èµ„æºã€ç™»å½•ã€æ³¨å†Œæ¥å£ï¼‰
- æ‹¦æˆªéæ³•è¯·æ±‚ï¼Œè¿”å›ç»Ÿä¸€é”™è¯¯æ ¼å¼

------

## ğŸ§­ OAuth2 å¤šæ¨¡å¼æˆæƒæµç¨‹è¯¦è§£

| æ¨¡å¼       | é€‚ç”¨åœºæ™¯                 | å®‰å…¨æ€§ | ç®€ä»‹è¯´æ˜                 |
| ---------- | ------------------------ | ------ | ------------------------ |
| å¯†ç æ¨¡å¼   | åç«¯ç»Ÿä¸€è®¤è¯ã€å®¢æˆ·ç«¯å¯ä¿¡ | ä¸­ç­‰   | ç”¨æˆ·åå¯†ç ç›´æ¥è·å– Token |
| æˆæƒç æ¨¡å¼ | ç¬¬ä¸‰æ–¹æˆæƒç™»å½•           | é«˜     | å…¸å‹çš„ä¼ä¸šå¾®ä¿¡/é’‰é’‰ç™»å½•  |
| å®¢æˆ·ç«¯æ¨¡å¼ | ç³»ç»Ÿå¯¹ç³»ç»Ÿè°ƒç”¨           | é«˜     | æ— ç”¨æˆ·å‚ä¸ï¼Œä»…æœåŠ¡è®¤è¯   |

#### Spring Authorization Server æ–°æ–¹æ¡ˆï¼ˆå–ä»£ OAuth2 legacy ç»„ä»¶ï¼‰

- æ”¯æŒ JWT + OAuth2 æ ‡å‡†åè®®
- å¯è‡ªå®šä¹‰ Clientã€Token ç­–ç•¥
- é¢è¯•çƒ­ç‚¹ï¼š**OAuth2.1 å’Œ OAuth2.0 åŒºåˆ«**

------

## ğŸ§© å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰æ–¹æ¡ˆè®¾è®¡ä¸å®ç°

#### åœºæ™¯ï¼šå¤šä¸ªç³»ç»Ÿç»Ÿä¸€ç™»å½•å…¥å£ï¼ˆå¦‚ HR ç³»ç»Ÿ + CRM + BI å¹³å°ï¼‰

- ç™»å½•ä¸­å¿ƒé¢å‘ Token
- å­ç³»ç»Ÿä¿¡ä»»è¯¥ Tokenï¼Œè‡ªåŠ¨ç™»å½•
- Token åŒæ­¥ & é€€å‡ºåŒæ­¥ç­–ç•¥

#### å®ç°æ–¹å¼ï¼š

- JWT + Gateway + Redisï¼ˆç»´æŠ¤ Token å’Œç”¨æˆ·ä¿¡æ¯ï¼‰
- CAS / SAML / OpenID Connectï¼ˆé€‚ç”¨äºå¤§å‹ç»„ç»‡ï¼‰

------

## ğŸ”§ JWT + Redis + Gateway æ„å»ºå®Œæ•´è®¤è¯æ¶æ„

```
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   ç”¨æˆ·ç™»å½•    â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Auth æœåŠ¡    â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ JWT Token
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Gatewayç½‘å…³ â”‚ â”€â”€â”€â”€â”€â†’ â”‚  Redis é»‘åå• â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ å¾®æœåŠ¡ç³»ç»Ÿç¾¤ â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¨¡å—èŒè´£æ‹†åˆ†ï¼š

- Auth æœåŠ¡ï¼šä¸“èŒè®¤è¯ã€é¢å‘ Token
- Gatewayï¼šå…¨å±€è¿‡æ»¤å™¨éªŒè¯ Token
- Redisï¼šç¼“å­˜ç”¨æˆ· Tokenã€å®ç°é»‘åå• / TTL æ§åˆ¶

------

## ğŸ’¡ é¢è¯•çƒ­ç‚¹é—®é¢˜æ±‡æ€»

| é—®é¢˜                                    | å…³é”®è¯                                     |
| --------------------------------------- | ------------------------------------------ |
| JWT æ˜¯ä»€ä¹ˆï¼Ÿå’Œ Session æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ     | æ— çŠ¶æ€ã€ä¸‰æ®µç»“æ„ã€Payloadã€ç­¾åéªŒè¯        |
| JWT å¦‚ä½•è§£å†³å¤±æ•ˆé—®é¢˜ï¼Ÿ                  | Redis é»‘åå•ã€è®¾ç½®è¿‡æœŸæ—¶é—´ã€Token åˆ·æ–°æœºåˆ¶ |
| OAuth2 å››ç§æ¨¡å¼ç†è§£ä¸åº”ç”¨åœºæ™¯ï¼Ÿ         | æˆæƒç ã€å¯†ç ã€å®¢æˆ·ç«¯ã€ç®€åŒ–æ¨¡å¼             |
| å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ”¯æŒ SSO çš„å¾®æœåŠ¡è®¤è¯æ¶æ„ï¼Ÿ | Gateway è¿‡æ»¤å™¨ã€JWTã€Redisã€å¤šæœåŠ¡åŒæ­¥é€€å‡º |
| JWT ä¼šè¢«ç›—ç”¨æ€ä¹ˆåŠï¼Ÿ                    | åŠ å¯†ã€ç­¾åéªŒè¯ã€IP ç»‘å®šã€è®¾å¤‡æŒ‡çº¹è¯†åˆ«      |

------

## âœ… å°ç»“

JWT / OAuth2 æ˜¯å¾®æœåŠ¡ä½“ç³»ä¸­**æœ€æ ¸å¿ƒçš„å®‰å…¨æŠ€æœ¯æ ˆ**ä¹‹ä¸€ï¼Œä¸æŒæ¡å®ƒåŸºæœ¬æ— æ³•èƒœä»»ä¸€ä¸ªä¸­å¤§å‹å¾®æœåŠ¡é¡¹ç›®ã€‚
 æœ¬ç« ä¸æ˜¯ä¸ºäº†ç®€å•è·‘é€š demoï¼Œè€Œæ˜¯è¦åšåˆ°ï¼š

- èƒ½è®²æ¸…æ¥šè®¤è¯æ–¹æ¡ˆçš„åŸç†ä¸æ¼”è¿›
- èƒ½åœ¨é¡¹ç›®ä¸­çµæ´»è½åœ°
- é¢è¯•æ—¶æ€è·¯æ¸…æ™°ã€è‡ªä¿¡å›ç­”

------

# åã€é¡¹ç›®æ¶æ„å®è·µä¸æ¨¡å—æ‹†åˆ†

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¦‚ä½•é«˜æ•ˆè®¾è®¡é¡¹ç›®ç»“æ„å’Œæ¨¡å—æ‹†åˆ†ï¼Œä¿æŒä»£ç çš„æ¸…æ™°æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œæ˜¯æ„å»ºå¥å£®ç³»ç»Ÿçš„åŸºç¡€ã€‚è‰¯å¥½çš„æ¶æ„ä¸ä»…æé«˜å¼€å‘æ•ˆç‡ï¼Œè¿˜èƒ½åº”å¯¹é¡¹ç›®æ—¥åå¯èƒ½é¢ä¸´çš„æ‰©å±•ä¸ç»´æŠ¤éš¾é¢˜ã€‚æœ¬ç« å°†ä»å¾®æœåŠ¡æ¶æ„çš„ç»“æ„è®¾è®¡å‡ºå‘ï¼Œæ¢è®¨å¦‚ä½•åˆç†æ‹†åˆ†æ¨¡å—ï¼Œè®¾è®¡å…¬å…±æ¨¡å—ï¼Œç»Ÿä¸€å¼€å‘è§„èŒƒå’Œç®¡ç†æ¥å£æ–‡æ¡£ï¼Œå¸®åŠ©ä½ åœ¨å¼€å‘å®è·µä¸­æ„å»ºé«˜æ•ˆã€å¯æ‰©å±•çš„ç³»ç»Ÿã€‚

------

## ğŸ“‚ æ¨èé¡¹ç›®ç»“æ„

ä¸€ä¸ªæ¸…æ™°çš„é¡¹ç›®ç»“æ„èƒ½å¤Ÿè®©å¼€å‘äººå‘˜åœ¨ä¸åŒæ¨¡å—é—´å¿«é€Ÿåˆ‡æ¢å’Œå®šä½ï¼Œé¿å…æ¨¡å—é—´çš„è€¦åˆå’Œå†²çªã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¸¸è§çš„å¾®æœåŠ¡æ¶æ„æ¨èç»“æ„ï¼š

```
â”œâ”€â”€ gateway                    # API ç½‘å…³å±‚ï¼Œè´Ÿè´£ç»Ÿä¸€è·¯ç”±ä¸è¯·æ±‚è½¬å‘
â”‚   â””â”€â”€ src/main/java/com/example/gateway
â”œâ”€â”€ service                    # ä¸šåŠ¡å¾®æœåŠ¡å±‚ï¼Œå•ç‹¬ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ user-service           # ç”¨æˆ·æœåŠ¡
â”‚   â””â”€â”€ order-service          # è®¢å•æœåŠ¡
â”œâ”€â”€ common                     # å…¬å…±æ¨¡å—ï¼Œå­˜æ”¾å„å¾®æœåŠ¡é€šç”¨çš„ç±»
â”‚   â”œâ”€â”€ dto                    # æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰
â”‚   â”œâ”€â”€ exception              # å¼‚å¸¸å¤„ç†ç±»
â”‚   â”œâ”€â”€ util                   # å…¬å…±å·¥å…·ç±»
â”œâ”€â”€ auth                       # ç”¨æˆ·è®¤è¯ä¸æƒé™æ§åˆ¶æ¨¡å—
â”‚   â”œâ”€â”€ auth-service           # æä¾›è®¤è¯ã€æˆæƒã€Token ç”Ÿæˆç­‰åŠŸèƒ½
â”‚   â””â”€â”€ security               # Spring Security ç›¸å…³é…ç½®
â”œâ”€â”€ admin                      # ç®¡ç†åå°ï¼Œæ”¯æŒå¯¹å¾®æœåŠ¡è¿›è¡Œç®¡ç†
â”‚   â”œâ”€â”€ admin-panel            # æä¾›ç³»ç»Ÿç®¡ç†ã€æ•°æ®ç›‘æ§ç­‰åŠŸèƒ½
â”‚   â””â”€â”€ configuration          # é…ç½®ç®¡ç†æ¨¡å—
â””â”€â”€ pom.xml                    # æ ¹ POM æ–‡ä»¶ï¼ˆå¤šæ¨¡å— Maven é¡¹ç›®ï¼‰
```

#### è¯´æ˜ï¼š

1. **Gateway**ï¼šè´Ÿè´£æ‰€æœ‰å¤–éƒ¨è¯·æ±‚çš„è·¯ç”±å’Œè½¬å‘ï¼Œç»Ÿä¸€å¤„ç†è·¨åŸŸã€è®¤è¯ã€é™æµã€è¯·æ±‚ç›‘æ§ç­‰ä»»åŠ¡ã€‚å¯ä»¥é€‰æ‹© Spring Cloud Gateway æˆ– Nginxã€‚
2. **Service**ï¼šå¾®æœåŠ¡æ ¸å¿ƒï¼Œåˆ†åˆ«å®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚æ¯ä¸ªå¾®æœåŠ¡æœ‰è‡ªå·±ç‹¬ç«‹çš„æ¨¡å—ï¼Œæ¯”å¦‚ç”¨æˆ·æœåŠ¡ã€è®¢å•æœåŠ¡ç­‰ã€‚
3. **Common**ï¼šæ”¾ç½®å…¬å…±çš„å·¥å…·ç±»ã€DTOã€å¼‚å¸¸ç±»å’ŒåŸºç¡€ç»„ä»¶ï¼Œç¡®ä¿å„ä¸ªå¾®æœåŠ¡æ¨¡å—ä¹‹é—´çš„å¤ç”¨ã€‚
4. **Auth**ï¼šä¸“é—¨å¤„ç†è®¤è¯ã€æˆæƒç›¸å…³çš„åŠŸèƒ½ï¼Œå¯ä»¥é›†æˆ Spring Security ä¸ JWT è¿›è¡Œæ— çŠ¶æ€è®¤è¯ã€‚
5. **Admin**ï¼šé’ˆå¯¹å¾®æœåŠ¡çš„ç®¡ç†åå°ï¼Œæä¾›æœåŠ¡ç›‘æ§ã€é…ç½®ç®¡ç†ã€æƒé™ç®¡ç†ç­‰åŠŸèƒ½ã€‚
6. **pom.xml**ï¼šä½¿ç”¨ Maven æ„å»ºé¡¹ç›®æ—¶çš„æ ¹ POM æ–‡ä»¶ï¼Œæ–¹ä¾¿ä¾èµ–ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶ã€‚

------

## ğŸ§© æ¨¡å—åŒ–å¾®æœåŠ¡æ‹†åˆ†å»ºè®®

#### 1. **å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™**

- **é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰**ï¼šæ ¹æ®é¢†åŸŸæ¨¡å‹åˆ’åˆ†æœåŠ¡ï¼Œç¡®ä¿æ¯ä¸ªæœåŠ¡éƒ½æ˜¯å›´ç»•ä¸€ä¸ªæ˜ç¡®çš„ä¸šåŠ¡åŠŸèƒ½è¿›è¡Œæ‹†åˆ†ï¼Œä¾‹å¦‚è®¢å•ã€æ”¯ä»˜ã€ç”¨æˆ·ç­‰ã€‚
- **æœåŠ¡å¤§å°åˆç†**ï¼šæ¯ä¸ªå¾®æœåŠ¡ä¸å®œè¿‡å¤§ï¼Œé€‚å½“æ‹†åˆ†ä»¥é¿å…æœåŠ¡è†¨èƒ€å’Œç®¡ç†éš¾åº¦å¢å¤§ã€‚
- **æœåŠ¡è‡ªæ²»**ï¼šæ¯ä¸ªå¾®æœåŠ¡éƒ½åº”è¯¥æ˜¯è‡ªæ²»çš„ï¼Œèƒ½å¤Ÿç‹¬ç«‹éƒ¨ç½²ã€æ‰©å±•ã€å‡çº§ï¼Œå‡å°‘ä¸å…¶ä»–æœåŠ¡çš„ä¾èµ–ã€‚
- **éµå¾ªæ¥å£å¥‘çº¦**ï¼šé€šè¿‡ API æ¥å£è¿›è¡Œå¾®æœåŠ¡é—´çš„äº¤äº’ï¼Œé¿å…ç›´æ¥å¼•ç”¨å…¶ä»–æœåŠ¡çš„å®ç°ã€‚

#### 2. **å¸¸è§çš„å¾®æœåŠ¡æ‹†åˆ†æ–¹å¼**

- **æŒ‰ä¸šåŠ¡æ‹†åˆ†**ï¼šæ¯ä¸ªå¾®æœåŠ¡é’ˆå¯¹ä¸åŒçš„ä¸šåŠ¡æ¨¡å—ï¼Œç‹¬ç«‹å®Œæˆè‡ªå·±çš„åŠŸèƒ½ï¼Œå¦‚ç”¨æˆ·æœåŠ¡ã€å•†å“æœåŠ¡ã€è®¢å•æœåŠ¡ã€‚
- **æŒ‰åŠŸèƒ½æ‹†åˆ†**ï¼šæ ¹æ®åŠŸèƒ½è¿›è¡Œæ‹†åˆ†ï¼Œå¦‚ç”¨æˆ·è®¤è¯æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ã€é€šçŸ¥æœåŠ¡ç­‰ã€‚
- **æŒ‰æ•°æ®æ‹†åˆ†**ï¼šæ ¹æ®æ•°æ®å­˜å‚¨çš„é¢†åŸŸæ‹†åˆ†ï¼Œç¡®ä¿æ¯ä¸ªå¾®æœåŠ¡æ‹¥æœ‰è‡ªå·±çš„æ•°æ®åº“ã€‚

------

## ğŸ› ï¸ å…¬å…±æ¨¡å—è®¾è®¡ï¼ˆDTOã€å¼‚å¸¸ã€æƒé™ã€å“åº”å°è£…ï¼‰

#### 1. **DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰è®¾è®¡**

DTO æ˜¯ç”¨æ¥ä¼ è¾“æ•°æ®çš„å¯¹è±¡ï¼Œä¸€èˆ¬ç”¨äºå¾®æœåŠ¡é—´çš„æ¥å£é€šä¿¡ã€‚DTO çš„è®¾è®¡éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š

- **ç®€å•æ¸…æ™°**ï¼šåªåŒ…å«å¿…è¦çš„å­—æ®µï¼Œé¿å…è¿‡å¤šçš„å…³è”æ•°æ®ã€‚
- **å°è£…å±‚æ¬¡æ¸…æ™°**ï¼šå¯ä½¿ç”¨ VOï¼ˆè§†å›¾å¯¹è±¡ï¼‰æ¥ä¼ è¾“å’Œå±•ç¤ºæ•°æ®ï¼Œä½¿ç”¨ DTO è¿›è¡ŒæœåŠ¡å±‚ä¹‹é—´çš„ä¼ é€’ã€‚
- **ä¸æ•°æ®åº“è§£è€¦**ï¼šDTO ä¸åº”è¯¥ä¸æ•°æ®åº“è¡¨ç»“æ„ç›´æ¥ç»‘å®šï¼Œåº”å¯¹å¤–æš´éœ²æœ‰å®é™…ä¸šåŠ¡æ„ä¹‰çš„æ•°æ®ã€‚

ç¤ºä¾‹ï¼š

```java
public class UserDTO {
    private String username;
    private String email;
    private String phoneNumber;
    // Getters and Setters
}
```

#### 2. **å¼‚å¸¸å¤„ç†ä¸ç»Ÿä¸€å°è£…**

å¾®æœåŠ¡ä¸­çš„å¼‚å¸¸é€šå¸¸åˆ†ä¸ºä¸¤ç±»ï¼š**ä¸šåŠ¡å¼‚å¸¸**å’Œ**æŠ€æœ¯å¼‚å¸¸**ã€‚ä¸ºäº†ç»Ÿä¸€ç®¡ç†å¼‚å¸¸ï¼Œå¯ä»¥è®¾è®¡ä¸€ä¸ªå…¬å…±çš„å¼‚å¸¸ç±»ï¼š

```java
public class BusinessException extends RuntimeException {
    private int code;
    private String message;
    // å…·ä½“ä¸šåŠ¡å¼‚å¸¸çš„å®ç°
}
```

åœ¨å…¨å±€å¼‚å¸¸å¤„ç†æ—¶ï¼Œå°è£…ç»Ÿä¸€çš„å“åº”ç»“æ„ï¼Œä¾‹å¦‚ï¼š

```json
{
    "status": "error",
    "message": "Invalid parameters",
    "data": null
}
```

#### 3. **æƒé™ç®¡ç†ä¸é‰´æƒ**

å¾®æœåŠ¡çš„æƒé™ç®¡ç†é€šå¸¸æ˜¯åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚ä½¿ç”¨ Spring Security + JWT è¿›è¡Œæ— çŠ¶æ€è®¤è¯å’Œæˆæƒï¼Œå¹¶ä¸”åœ¨æœåŠ¡é—´å…±äº«é‰´æƒä¿¡æ¯ã€‚

- è§’è‰²ï¼šå®šä¹‰ç³»ç»Ÿä¸­ä¸åŒè§’è‰²çš„æƒé™èŒƒå›´ï¼ˆå¦‚ç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·ã€è®¿å®¢ç­‰ï¼‰ã€‚
- é‰´æƒï¼šé€šè¿‡ JWT ä¸­çš„è§’è‰²ä¿¡æ¯è¿›è¡Œé‰´æƒï¼Œä¿è¯ä¸åŒè§’è‰²è®¿é—®ä¸åŒçš„èµ„æºã€‚

------

## ğŸ“ é…ç½®ç»Ÿä¸€ã€æ—¥å¿—ç»Ÿä¸€ã€å¼‚å¸¸ç»Ÿä¸€ã€æƒé™ç»Ÿä¸€

#### 1. **é…ç½®ç»Ÿä¸€**

- æ‰€æœ‰å¾®æœåŠ¡å…±äº«ç›¸åŒçš„é…ç½®ç®¡ç†ç³»ç»Ÿï¼Œå¦‚ Nacosï¼Œæ”¯æŒé…ç½®çš„åŠ¨æ€åˆ·æ–°ã€‚
- é…ç½®ä¸­å¿ƒçš„ä½¿ç”¨å¯ä»¥ç¡®ä¿åœ¨å¤šä¸ªç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ä¸‹çš„é…ç½®ä¸€è‡´æ€§ã€‚

#### 2. **æ—¥å¿—ç»Ÿä¸€**

- ä½¿ç”¨ ELKï¼ˆElasticsearch + Logstash + Kibanaï¼‰æˆ–å…¶ä»–æ—¥å¿—ç›‘æ§ç³»ç»Ÿï¼Œå®ç°å¾®æœåŠ¡çš„æ—¥å¿—é›†ä¸­åŒ–ç®¡ç†ã€‚
- ä¸ºäº†ä¾¿äºåæœŸæ’æŸ¥ï¼Œå¯ä»¥åœ¨æ—¥å¿—ä¸­è®°å½• TraceIdã€ç”¨æˆ·IDã€è¯·æ±‚è·¯å¾„ç­‰ä¿¡æ¯ï¼Œç»Ÿä¸€æ ¼å¼è¾“å‡ºã€‚

#### 3. **å¼‚å¸¸ç»Ÿä¸€**

- è®¾è®¡å…¨å±€å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå¯¹å¾®æœåŠ¡ä¸­çš„å¼‚å¸¸è¿›è¡Œç»Ÿä¸€æ•è·å’Œå¤„ç†ã€‚
- è¿”å›æ ‡å‡†åŒ–çš„å¼‚å¸¸å“åº”æ ¼å¼ï¼Œä¾¿äºå‰ç«¯æˆ–å®¢æˆ·ç«¯è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚

#### 4. **æƒé™ç»Ÿä¸€**

- ä½¿ç”¨ç»Ÿä¸€çš„æƒé™ç®¡ç†ç³»ç»Ÿï¼Œå¦‚ Spring Security å®ç°å¾®æœåŠ¡çš„æƒé™éªŒè¯ã€‚
- é€šè¿‡é›†ä¸­åŒ–çš„æƒé™é…ç½®ï¼Œå‡å°‘ä¸åŒæœåŠ¡ä¹‹é—´æƒé™ç®¡ç†çš„å¤æ‚åº¦ã€‚

------

## ğŸ“‘ å¼€å‘è§„èŒƒã€å‘½åè§„èŒƒã€æ¥å£è§„èŒƒå»ºè®®

#### 1. **å¼€å‘è§„èŒƒ**

- **ä»£ç æ ¼å¼åŒ–**ï¼šéµå¾ªä»£ç è§„èŒƒï¼Œç¡®ä¿ä»£ç ä¸€è‡´æ€§ï¼Œæå‡å›¢é˜Ÿåä½œæ•ˆç‡ã€‚
- **æ³¨é‡Šä¸æ–‡æ¡£**ï¼šå¯¹äºå¤æ‚é€»è¾‘ï¼ŒåŠ¡å¿…ä¹¦å†™è¯¦ç»†çš„ä»£ç æ³¨é‡Šå’Œå¼€å‘æ–‡æ¡£ã€‚

#### 2. **å‘½åè§„èŒƒ**

- **æœåŠ¡å‘½å**ï¼šæœåŠ¡åç§°åº”ç®€æ´æ˜äº†ï¼Œè¡¨ç¤ºè¯¥æœåŠ¡çš„åŠŸèƒ½æ¨¡å—ï¼Œå¦‚ `order-service`ã€`user-service`ã€‚
- **ç±»ä¸æ–¹æ³•å‘½å**ï¼šç±»ååº”éµå¾ªé©¼å³°å‘½åæ³•ï¼Œæ–¹æ³•ååº”ç®€æ´ä¸”ç¬¦åˆåŠŸèƒ½æè¿°ã€‚

#### 3. **æ¥å£è§„èŒƒ**

- **RESTful API è®¾è®¡è§„èŒƒ**ï¼šæ¥å£è®¾è®¡éµå¾ª REST åŸåˆ™ï¼Œä½¿ç”¨ HTTP æ–¹æ³•è¡¨ç¤ºæ“ä½œï¼ŒURL åæ˜ èµ„æºå«ä¹‰ã€‚
- **ç»Ÿä¸€è¯·æ±‚ä¸å“åº”æ ¼å¼**ï¼šæ‰€æœ‰å¾®æœåŠ¡çš„è¯·æ±‚å’Œå“åº”éµå¾ªç»Ÿä¸€çš„ JSON æ ¼å¼è§„èŒƒã€‚

------

## ğŸ“œ æ¥å£æ–‡æ¡£ç®¡ç†ï¼ˆSwagger / Knife4jï¼‰

#### 1. **Swagger**ï¼šè‡ªåŠ¨åŒ–ç”Ÿæˆæ¥å£æ–‡æ¡£

Swagger æ˜¯ä¸€ä¸ªå¯ä»¥è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£çš„å·¥å…·ï¼Œç»“åˆ Spring Boot ä½¿ç”¨ï¼Œå¯ä»¥ç”Ÿæˆæ¸…æ™°ã€å¯æ“ä½œçš„æ–‡æ¡£ç•Œé¢ï¼Œæ–¹ä¾¿å›¢é˜Ÿä¸å¤–éƒ¨å¼€å‘è€…æŸ¥çœ‹ APIã€‚

#### 2. **Knife4j**ï¼šSwagger çš„å¢å¼ºç‰ˆ

Knife4j æä¾›äº†æ›´ä¸°å¯Œçš„ UIï¼Œæ”¯æŒ API æµ‹è¯•ã€å‚æ•°æ˜¾ç¤ºã€è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆç­‰åŠŸèƒ½ï¼Œæå‡äº† Swagger ä½¿ç”¨ä½“éªŒã€‚

------

### ğŸ å°ç»“

è‰¯å¥½çš„é¡¹ç›®æ¶æ„è®¾è®¡æ˜¯å¾®æœåŠ¡å¼€å‘çš„åŸºçŸ³ã€‚åœ¨è¿™ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬æ¢è®¨äº†å¦‚ä½•é€šè¿‡åˆç†æ‹†åˆ†æ¨¡å—ï¼Œè®¾è®¡å…¬å…±ç»„ä»¶ï¼Œç»Ÿä¸€è§„èŒƒï¼Œå¸®åŠ©å›¢é˜Ÿæé«˜å¼€å‘æ•ˆç‡å’Œé¡¹ç›®çš„å¯ç»´æŠ¤æ€§ã€‚é€šè¿‡å®è·µä¸­çš„æ¨¡å—åŒ–æ‹†åˆ†ã€ç»Ÿä¸€æ¥å£æ–‡æ¡£ç®¡ç†ç­‰æ–¹æ¡ˆï¼Œå¯ä»¥æœ‰æ•ˆé™ä½å¼€å‘å¤æ‚åº¦ï¼Œæå‡é¡¹ç›®çš„æ‰©å±•æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚

# åä¸€ã€éƒ¨ç½²ã€ç›‘æ§ä¸è¿ç»´å»ºè®®

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œéƒ¨ç½²ã€ç›‘æ§å’Œè¿ç»´æ˜¯ç³»ç»Ÿç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§çš„å…³é”®å› ç´ ã€‚éšç€å¾®æœåŠ¡æ•°é‡çš„å¢å¤šï¼Œå¦‚ä½•é«˜æ•ˆç®¡ç†æœåŠ¡çš„éƒ¨ç½²ã€ç›‘æ§æœåŠ¡çš„å¥åº·çŠ¶å†µä»¥åŠä¿è¯ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œï¼Œæˆä¸ºäº†å¼€å‘ä¸è¿ç»´å›¢é˜Ÿéœ€è¦é‡ç‚¹å…³æ³¨çš„é—®é¢˜ã€‚æœ¬ç« å°†å›´ç»•å¾®æœåŠ¡çš„éƒ¨ç½²ã€ç›‘æ§å’Œè¿ç»´å±•å¼€ï¼Œæä¾›ä¸€ç³»åˆ—çš„å®æˆ˜å»ºè®®ä¸æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°éƒ¨ç½²ã€ç»´æŠ¤å’Œè¿ç»´å¾®æœåŠ¡ç³»ç»Ÿã€‚

------

## ğŸ› ï¸ å¤šæœåŠ¡æœ¬åœ°å¼€å‘è°ƒè¯•æŠ€å·§

åœ¨å¼€å‘å¾®æœåŠ¡æ—¶ï¼Œé€šå¸¸éœ€è¦åŒæ—¶å¯åŠ¨å¤šä¸ªæœåŠ¡è¿›è¡Œè°ƒè¯•ã€‚ä¸ºäº†æœ‰æ•ˆç®¡ç†æœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„è°ƒè¯•æŠ€å·§ã€‚

#### 1. **ä½¿ç”¨ Profile é…ç½®å¤šç¯å¢ƒæ”¯æŒ**

Spring Boot çš„ `@Profile` æ³¨è§£å¯ä»¥å¸®åŠ©ä½ åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹åŠ è½½ä¸åŒçš„é…ç½®ã€‚é€šè¿‡åˆç†çš„é…ç½®ï¼Œä½ å¯ä»¥åœ¨æœ¬åœ°ã€å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒä¸­åˆ‡æ¢ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚

```java
@Profile("dev")
@Configuration
public class DevConfig {
    // å¼€å‘ç¯å¢ƒé…ç½®
}
```

åŒæ—¶ï¼Œå¯ä»¥é€šè¿‡ `application.properties` æˆ– `application.yml` æ–‡ä»¶ä¸­è®¾ç½®ä¸åŒçš„ `spring.profiles.active` æ¥é€‰æ‹©ä½¿ç”¨çš„ç¯å¢ƒé…ç½®ï¼š

```properties
spring.profiles.active=dev
```

#### 2. **å¤šç«¯å£é…ç½®**

ä¸ºäº†é¿å…æœ¬åœ°å¼€å‘æ—¶æœåŠ¡ç«¯å£å†²çªï¼Œå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€ä¿®æ”¹æœåŠ¡ç«¯å£ï¼š

```properties
server.port=8080
```

æˆ–è€…ï¼Œåœ¨ `application-dev.properties`ã€`application-prod.properties` æ–‡ä»¶ä¸­é…ç½®ä¸åŒçš„ç«¯å£ï¼Œè®©æ¯ä¸ªæœåŠ¡éƒ½ä½¿ç”¨ç‹¬ç«‹çš„ç«¯å£ï¼Œé¿å…ç«¯å£å†²çªã€‚

#### 3. **Docker å®¹å™¨åŒ–éƒ¨ç½²**

Docker æ˜¯å®¹å™¨åŒ–éƒ¨ç½²çš„æœ€ä½³é€‰æ‹©ï¼Œå¯ä»¥å¸®åŠ©ä½ å°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–æ‰“åŒ…åˆ°å®¹å™¨ä¸­ï¼Œç¡®ä¿åœ¨ä¸åŒç¯å¢ƒä¸‹å…·æœ‰ä¸€è‡´æ€§ã€‚

- **Dockerfile ç¤ºä¾‹ï¼š**

```Dockerfile
FROM openjdk:11-jre-slim
VOLUME /tmp
COPY target/my-app.jar app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
```

- **æ„å»ºé•œåƒï¼š**

```bash
docker build -t my-app .
```

- **è¿è¡Œå®¹å™¨ï¼š**

```bash
docker run -p 8080:8080 my-app
```

é€šè¿‡å®¹å™¨åŒ–éƒ¨ç½²ï¼Œå¯ä»¥æ›´æ–¹ä¾¿åœ°è¿›è¡Œå¾®æœåŠ¡çš„éš”ç¦»ä¸ç®¡ç†ï¼ŒåŒæ—¶åœ¨ä¸åŒç¯å¢ƒä¸‹å®ç°ä¸€è‡´çš„éƒ¨ç½²æµç¨‹ã€‚

------

## ğŸ“Š æœåŠ¡ç›‘æ§ä¸å¥åº·æ£€æŸ¥

ç›‘æ§å¾®æœåŠ¡ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ï¼Œå¯¹äºä¿éšœç”Ÿäº§ç¯å¢ƒçš„ç¨³å®šè‡³å…³é‡è¦ã€‚ç»“åˆ Spring Boot Actuatorã€Prometheus å’Œ Grafana å¯ä»¥å®ç°å¼ºå¤§çš„ç›‘æ§åŠŸèƒ½ã€‚

#### 1. **Spring Boot Actuator é›†æˆ**

Spring Boot Actuator æä¾›äº†ä¸€äº›å†…ç½®çš„ç«¯ç‚¹ï¼ˆå¦‚ `/actuator/health` å’Œ `/actuator/metrics`ï¼‰æ¥ç›‘æ§åº”ç”¨çš„å¥åº·çŠ¶å†µå’Œæ€§èƒ½ã€‚é€šè¿‡å¯ç”¨ Actuatorï¼Œä½ å¯ä»¥æ–¹ä¾¿åœ°æ£€æŸ¥åº”ç”¨çš„å¥åº·çŠ¶æ€ã€æ€§èƒ½æŒ‡æ ‡ã€æ•°æ®åº“è¿æ¥ç­‰ã€‚

åœ¨ `application.properties` æ–‡ä»¶ä¸­å¯ç”¨ Actuatorï¼š

```properties
management.endpoints.web.exposure.include=health,metrics
```

#### 2. **Prometheus ä¸ Grafana é›†æˆ**

Prometheus æ˜¯ä¸€ä¸ªå¼€æºç›‘æ§å·¥å…·ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°æ”¶é›†å’Œå­˜å‚¨æ¥è‡ªä¸åŒå¾®æœåŠ¡çš„ç›‘æ§æ•°æ®ï¼ŒGrafana å¯ä»¥ç”¨æ¥å¯è§†åŒ–è¿™äº›æ•°æ®ã€‚

- **é›†æˆ Prometheusï¼š** åœ¨ Spring Boot é¡¹ç›®ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `micrometer` å’Œ `spring-boot-starter-actuator` æ¥æš´éœ² Prometheus æ ¼å¼çš„ç›‘æ§æ•°æ®ï¼š

```properties
management.endpoints.web.exposure.include=prometheus
```

- **Grafana é…ç½®ï¼š** åœ¨ Grafana ä¸­é…ç½® Prometheus æ•°æ®æºï¼Œå¹¶ä½¿ç”¨è‡ªå®šä¹‰æˆ–å®˜æ–¹çš„ç›‘æ§é¢æ¿æ¥å±•ç¤ºå„ç±»æŒ‡æ ‡ï¼Œå¦‚å“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡ç­‰ã€‚

------

## ğŸ“¦ æ—¥å¿—é‡‡é›†ä¸åˆ†æ

å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œæ—¥å¿—æ•°æ®é‡åºå¤§ï¼Œå› æ­¤å¦‚ä½•é«˜æ•ˆæ”¶é›†å’Œåˆ†ææ—¥å¿—æ•°æ®ï¼Œæˆä¸ºäº†å¾®æœåŠ¡è¿ç»´ä¸­çš„ä¸€ä¸ªé‡è¦é—®é¢˜ã€‚

#### 1. **ELK Stackï¼ˆElasticsearch + Logstash + Kibanaï¼‰**

ELK Stack æ˜¯å¸¸è§çš„æ—¥å¿—æ”¶é›†ä¸åˆ†ææ–¹æ¡ˆï¼š

- **Elasticsearch**ï¼šè´Ÿè´£å­˜å‚¨å’Œæœç´¢æ—¥å¿—æ•°æ®ã€‚
- **Logstash**ï¼šè´Ÿè´£æ”¶é›†ã€è¿‡æ»¤å’Œä¼ è¾“æ—¥å¿—æ•°æ®ã€‚
- **Kibana**ï¼šæä¾›æ—¥å¿—çš„å¯è§†åŒ–ç•Œé¢ï¼Œå¸®åŠ©ä½ å¿«é€ŸæŸ¥çœ‹å’Œåˆ†ææ—¥å¿—æ•°æ®ã€‚

éƒ¨ç½² ELK æ—¶ï¼Œä½ éœ€è¦é€šè¿‡ Logstash å°†æ—¥å¿—ä»å„ä¸ªæœåŠ¡æ”¶é›†åˆ° Elasticsearch ä¸­ï¼Œå¹¶é€šè¿‡ Kibana è¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚

#### 2. **Loki + Promtail + Grafana**

å¦‚æœä½ åå¥½ä½¿ç”¨ Grafana è¿›è¡Œæ—¥å¿—åˆ†æï¼Œå¯ä»¥é€‰æ‹© Loki + Promtailã€‚Loki æ˜¯ä¸€ä¸ªå¼€æºçš„æ—¥å¿—èšåˆç³»ç»Ÿï¼Œä¸ Prometheus é…åˆä½¿ç”¨ï¼Œèƒ½å¤Ÿæä¾›é«˜æ•ˆçš„æ—¥å¿—å­˜å‚¨ä¸æŸ¥è¯¢åŠŸèƒ½ã€‚

- **Promtail**ï¼šè´Ÿè´£å°†åº”ç”¨æ—¥å¿—é‡‡é›†å¹¶æ¨é€è‡³ Lokiã€‚
- **Loki**ï¼šå­˜å‚¨æ—¥å¿—æ•°æ®ã€‚
- **Grafana**ï¼šæä¾›æ—¥å¿—çš„å¯è§†åŒ–ä¸æŸ¥è¯¢ç•Œé¢ã€‚

------

## ğŸ› ï¸ ç°åº¦å‘å¸ƒä¸æµé‡æ§åˆ¶

åœ¨å¾®æœåŠ¡çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç°åº¦å‘å¸ƒå’Œæµé‡æ§åˆ¶æ˜¯å¸¸è§çš„å‘å¸ƒç­–ç•¥ï¼Œèƒ½å¤Ÿæœ‰æ•ˆå‡å°‘ç³»ç»Ÿå‡ºç°æ•…éšœçš„é£é™©ï¼Œå¹¶ç¡®ä¿æ–°åŠŸèƒ½çš„å¹³æ»‘å‘å¸ƒã€‚

#### 1. **Nacos + Gateway + æ ‡ç­¾è·¯ç”±å®ç°ç°åº¦å‘å¸ƒ**

ä½¿ç”¨ Nacos åŠ¨æ€ç®¡ç†æœåŠ¡ä¸è·¯ç”±ï¼Œç»“åˆ Spring Cloud Gatewayï¼Œå®ç°åŸºäºæ ‡ç­¾çš„ç°åº¦å‘å¸ƒï¼š

- **Nacos é…ç½®ï¼š** ä½¿ç”¨ Nacos é…ç½®ä¸åŒç¯å¢ƒä¸‹çš„è·¯ç”±è§„åˆ™ï¼Œæ§åˆ¶æµé‡çš„é€æ­¥åˆ‡æ¢ã€‚
- **Gateway è·¯ç”±é…ç½®ï¼š** é€šè¿‡ Gateway çš„è·¯ç”±åŒ¹é…è§„åˆ™ï¼Œå¯ä»¥åŸºäºè¯·æ±‚å¤´ã€ç”¨æˆ·æ ‡ç­¾æˆ–è¯·æ±‚æ¥æºç­‰ä¿¡æ¯ï¼Œå°†æµé‡å®šå‘åˆ°ä¸åŒçš„æœåŠ¡ç‰ˆæœ¬ï¼Œå®ç°ç°åº¦å‘å¸ƒã€‚

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service-v1
          uri: lb://user-service-v1
          predicates:
            - Path=/user/**

        - id: user-service-v2
          uri: lb://user-service-v2
          predicates:
            - Path=/user/**
            - Header=X-Version=2
```

#### 2. **æµé‡æ§åˆ¶ä¸ç†”æ–­**

ç»“åˆ Sentinel æˆ– Resilience4jï¼Œå¯ä»¥åœ¨å¾®æœåŠ¡ç½‘å…³å±‚è¿›è¡Œæµé‡æ§åˆ¶ï¼Œè®¾å®šæµé‡é˜ˆå€¼ä¸ç†”æ–­ç­–ç•¥ã€‚ç¡®ä¿åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œç³»ç»Ÿèƒ½å¤Ÿç¨³å®šè¿è¡Œã€‚

------

## â›‘ï¸ é…ç½®/æœåŠ¡ä¸­å¿ƒç¾éš¾æ¢å¤ä¸é™çº§ç­–ç•¥

å¾®æœåŠ¡æ¶æ„çš„åˆ†å¸ƒå¼ç‰¹æ€§å¸¦æ¥äº†æœåŠ¡ä¸­å¿ƒï¼ˆå¦‚ Nacosï¼‰çš„å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå› æ­¤åˆç†è®¾è®¡ç¾éš¾æ¢å¤ä¸é™çº§ç­–ç•¥æ˜¯ä¿éšœç³»ç»Ÿé«˜å¯ç”¨æ€§çš„å…³é”®ã€‚

#### 1. **é…ç½®ä¸­å¿ƒç¾éš¾æ¢å¤**

ä¸ºäº†é¿å…é…ç½®ä¸­å¿ƒï¼ˆå¦‚ Nacosï¼‰æ•…éšœæ—¶å¸¦æ¥çš„å½±å“ï¼Œå¯ä»¥é‡‡ç”¨å¦‚ä¸‹ç­–ç•¥ï¼š

- **å¤‡ä»½æœºåˆ¶**ï¼šå®šæœŸå¤‡ä»½é…ç½®æ•°æ®ï¼Œé˜²æ­¢é…ç½®ä¸¢å¤±ã€‚
- **å¤šé›†ç¾¤é…ç½®ä¸­å¿ƒ**ï¼šéƒ¨ç½²å¤šä¸ª Nacos å®ä¾‹ï¼Œå½¢æˆé›†ç¾¤ï¼Œç¡®ä¿é…ç½®æœåŠ¡çš„é«˜å¯ç”¨æ€§ã€‚
- **æœ¬åœ°ç¼“å­˜ä¸å®¹ç¾**ï¼šå¾®æœåŠ¡ä¸­åº”æœ‰æœ¬åœ°ç¼“å­˜é…ç½®çš„æœºåˆ¶ï¼Œç¡®ä¿åœ¨é…ç½®ä¸­å¿ƒæ— æ³•è®¿é—®æ—¶ï¼ŒæœåŠ¡ä»èƒ½æ­£å¸¸å¯åŠ¨ã€‚

#### 2. **æœåŠ¡é™çº§ç­–ç•¥**

æœåŠ¡é™çº§å¯ä»¥åœ¨å‡ºç°æ•…éšœæ—¶ä¿éšœç”¨æˆ·ä½“éªŒï¼Œé€šè¿‡ç†”æ–­ã€é™çº§ç­–ç•¥é¿å…ç³»ç»Ÿå´©æºƒã€‚å¸¸è§çš„é™çº§ç­–ç•¥åŒ…æ‹¬ï¼š

- **ä¸šåŠ¡ç†”æ–­**ï¼šå½“æœåŠ¡è°ƒç”¨è¶…æ—¶æˆ–å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨å¯ç”¨å¤‡ç”¨é€»è¾‘ï¼Œè¿”å›é»˜è®¤å€¼æˆ–å®¹é”™æ–¹æ¡ˆã€‚
- **é™çº§è·¯ç”±**ï¼šé€šè¿‡ç½‘å…³å®ç°æœåŠ¡é™çº§ï¼Œç¡®ä¿è¯·æ±‚åœ¨ä¸»æœåŠ¡ä¸å¯ç”¨æ—¶è½¬å‘åˆ°å¤‡ä»½æœåŠ¡æˆ–é™æ€å†…å®¹ã€‚

------

### ğŸ“Œ å°ç»“

å¾®æœåŠ¡æ¶æ„çš„éƒ¨ç½²ã€ç›‘æ§ä¸è¿ç»´æ˜¯ç³»ç»Ÿç¨³å®šä¸é«˜æ•ˆè¿è¡Œçš„åŸºç¡€ã€‚é€šè¿‡åˆç†é…ç½®æœ¬åœ°å¼€å‘ç¯å¢ƒã€ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½²ã€æ­å»ºç›‘æ§ä¸æ—¥å¿—ç³»ç»Ÿã€å®ç°ç°åº¦å‘å¸ƒä¸æµé‡æ§åˆ¶ç­‰æªæ–½ï¼Œèƒ½å¤Ÿç¡®ä¿å¾®æœåŠ¡ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯æ‰©å±•æ€§ã€‚æ­¤å¤–ï¼Œç¾éš¾æ¢å¤ä¸é™çº§ç­–ç•¥çš„æœ‰æ•ˆè®¾è®¡ï¼Œèƒ½åœ¨ç³»ç»Ÿå‡ºç°æ•…éšœæ—¶æœ€å¤§é™åº¦åœ°å‡å°‘å½±å“ã€‚

# åäºŒã€å¸¸è§é—®é¢˜ä¸é«˜é¢‘é¢è¯•é¢˜ç²¾é€‰

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæŠ€æœ¯æ ˆçš„é€‰æ‹©ã€é…ç½®çš„ç®¡ç†ã€æœåŠ¡çš„å®¹é”™ä»¥åŠç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œéƒ½æ˜¯é¢è¯•ä¸­ç»å¸¸è¢«é—®åˆ°çš„å…³é”®ç‚¹ã€‚æœ¬èŠ‚å°†é‡ç‚¹æ€»ç»“ä¸€äº› Spring Cloud ç›¸å…³çš„å¸¸è§é—®é¢˜ä¸é«˜é¢‘é¢è¯•é¢˜ï¼Œå¸®åŠ©å­¦ä¹ è€…åŠ æ·±å¯¹ Spring Cloud æŠ€æœ¯æ ˆçš„ç†è§£ï¼Œå‡†å¤‡é¢è¯•æ—¶èƒ½å¤Ÿæ›´åŠ å¾—å¿ƒåº”æ‰‹ã€‚

------

## â“ **Spring Cloud çš„æ•´ä½“æ¶æ„æµç¨‹å›¾èƒ½ç”»å‡ºæ¥å—ï¼Ÿ**

é¢è¯•æ—¶ï¼Œè€ƒå®˜å¾€å¾€å¸Œæœ›é¢è¯•è€…èƒ½æ¸…æ™°æè¿° Spring Cloud çš„æ•´ä½“æ¶æ„ï¼ŒæŒæ¡å¾®æœåŠ¡æ¶æ„çš„ä¸»è¦æ¨¡å—ä¸æµè½¬è¿‡ç¨‹ã€‚Spring Cloud çš„æ•´ä½“æ¶æ„ä¸»è¦åŒ…æ‹¬ï¼š

1. **æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼š** é€šè¿‡ Nacos æˆ– Eureka æ¥å®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚
2. **é…ç½®ä¸­å¿ƒï¼š** Nacos é…ç½®ä¸­å¿ƒæä¾›ç»Ÿä¸€çš„é…ç½®ç®¡ç†å’ŒåŠ¨æ€åˆ·æ–°ã€‚
3. **æœåŠ¡è°ƒç”¨ä¸è´Ÿè½½å‡è¡¡ï¼š** ä½¿ç”¨ Feign + Ribbon æˆ– LoadBalancer æ¥å®ç°å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ã€‚
4. **æœåŠ¡å®¹é”™ä¸é™æµï¼š** é€šè¿‡ Sentinel æ¥è¿›è¡Œæµé‡æ§åˆ¶ã€ç†”æ–­ä¸é™çº§ã€‚
5. **æœåŠ¡ç½‘å…³ï¼š** é€šè¿‡ Spring Cloud Gateway æä¾›ç»Ÿä¸€çš„ç½‘å…³æœåŠ¡ï¼Œå¤„ç†è¯·æ±‚çš„è·¯ç”±ä¸å®‰å…¨ã€‚
6. **é“¾è·¯è¿½è¸ªä¸ç›‘æ§ï¼š** ä½¿ç”¨ Sleuth å’Œ Zipkin æ¥è¿›è¡Œåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªã€‚
7. **åˆ†å¸ƒå¼äº‹åŠ¡ï¼š** ä½¿ç”¨ Seata è¿›è¡Œåˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚

**Spring Cloud æ¶æ„æµç¨‹å›¾ï¼š**

```
                +-----------------+
                |    Client App   |
                +-----------------+
                       |
                       v
             +---------------------+
             | Spring Cloud Gateway |
             +---------------------+
                       |
         +-------------+-------------+
         |                           |
+----------------+          +----------------+
| Service A      |          | Service B      |
| (Feign/Ribbon) |          | (Feign/Ribbon) |
+----------------+          +----------------+
        |                          |
        v                          v
   +-----------------+     +-----------------+
   | Nacos/Eureka    |     | Nacos/Eureka    |
   | (Service Discovery)    | (Service Discovery) |
   +-----------------+     +-----------------+
        |
        v
   +------------------------+
   | Config Center (Nacos)   |
   | (Dynamic Config)        |
   +------------------------+
```

------

## â“ **Feign å’Œ RestTemplate åŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆæ¨è Feignï¼Ÿ**

- **RestTemplateï¼š**
  - Spring æä¾›çš„åŒæ­¥ HTTP è¯·æ±‚å·¥å…·ï¼Œä¸»è¦ç”¨äºå‘èµ· HTTP è¯·æ±‚ã€‚
  - ä½¿ç”¨ `RestTemplate` æ—¶éœ€è¦æ‰‹åŠ¨å¤„ç† URLã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ã€é”™è¯¯å¤„ç†ç­‰ï¼Œè¾ƒä¸ºç¹çã€‚
  - ä¸å…·å¤‡è´Ÿè½½å‡è¡¡å’Œå®¹é”™åŠŸèƒ½ï¼Œéœ€è¦ä¸ Ribbonã€Hystrix ç­‰å…¶ä»–ç»„ä»¶ä¸€èµ·æ­é…ä½¿ç”¨ã€‚
- **Feignï¼š**
  - Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ Web æœåŠ¡å®¢æˆ·ç«¯ï¼Œé€šè¿‡æ¥å£å’Œæ³¨è§£æ¥ç®€åŒ–æœåŠ¡è°ƒç”¨çš„é…ç½®ã€‚
  - å†…ç½®æ”¯æŒè´Ÿè½½å‡è¡¡ã€å®¹é”™ã€æ‹¦æˆªå™¨ã€æ—¥å¿—ç­‰åŠŸèƒ½ã€‚
  - é…åˆ Ribbon å’Œ Hystrix ç­‰å®ç°æœåŠ¡è°ƒç”¨çš„æ™ºèƒ½è´Ÿè½½å‡è¡¡ä¸å®¹é”™å¤„ç†ï¼Œèƒ½å¤§å¤§ç®€åŒ–ä»£ç ã€‚

**ä¸ºä»€ä¹ˆæ¨è Feignï¼Ÿ**

- **å£°æ˜å¼è°ƒç”¨**ï¼šåªéœ€è¦å®šä¹‰æ¥å£åŠæ–¹æ³•ï¼Œç®€åŒ–äº†è°ƒç”¨æ–¹å¼ã€‚
- **è‡ªåŠ¨é›†æˆ**ï¼šä¸ Spring Cloud å…¶ä»–ç»„ä»¶ï¼ˆå¦‚ Ribbonã€Hystrixã€Nacosï¼‰é›†æˆé¡ºç•…ï¼Œé™ä½å¼€å‘å¤æ‚åº¦ã€‚
- **è´Ÿè½½å‡è¡¡ä¸å®¹é”™**ï¼šå†…å»ºè´Ÿè½½å‡è¡¡ä¸ç†”æ–­æœºåˆ¶ï¼Œä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€‚

------

## â“ **Sentinel æ€ä¹ˆåšåˆ°ä¸åŒç»´åº¦çš„é™æµï¼Ÿ**

Sentinel æä¾›äº†å¤šç»´åº¦çš„æµé‡æ§åˆ¶æ–¹å¼ï¼š

1. **QPS é™æµï¼š** æ ¹æ®æ¯ç§’è¯·æ±‚æ•°ï¼ˆQPSï¼‰è¿›è¡Œæµé‡æ§åˆ¶ã€‚
2. **çº¿ç¨‹æ•°é™æµï¼š** æ ¹æ®çº¿ç¨‹æ•°è¿›è¡Œæµé‡æ§åˆ¶ï¼Œé˜²æ­¢çº¿ç¨‹æ± æº¢å‡ºã€‚
3. **RT é™æµï¼š** åŸºäºå“åº”æ—¶é—´ï¼ˆRTï¼‰è¿›è¡Œæµé‡æ§åˆ¶ï¼Œä¿æŠ¤ç³»ç»Ÿå“åº”æ—¶é—´ã€‚
4. **å‚æ•°é™æµï¼š** æ ¹æ®è¯·æ±‚å‚æ•°è¿›è¡Œæµé‡æ§åˆ¶ï¼Œé’ˆå¯¹æŸäº›é«˜å¹¶å‘å‚æ•°è¿›è¡Œé™æµã€‚

**ä¸åŒç»´åº¦çš„é™æµé…ç½®ï¼š**

- å¯ä»¥é€šè¿‡è§„åˆ™é…ç½®è¿›è¡Œæµé‡æ§åˆ¶ï¼Œä¾‹å¦‚å¯ä»¥å¯¹ URIã€IPã€ç”¨æˆ·ç­‰ä¸åŒç»´åº¦çš„è¯·æ±‚è¿›è¡Œæµæ§ã€‚

------

## â“ **å¦‚ä½•ä¿è¯é…ç½®ä¸­å¿ƒå’Œæ³¨å†Œä¸­å¿ƒé«˜å¯ç”¨ï¼Ÿ**

1. **æ³¨å†Œä¸­å¿ƒé«˜å¯ç”¨ï¼š**
   - **å¤šèŠ‚ç‚¹é›†ç¾¤éƒ¨ç½²ï¼š** æ³¨å†Œä¸­å¿ƒï¼ˆå¦‚ Nacosã€Eurekaï¼‰å¯ä»¥é€šè¿‡é›†ç¾¤æ¨¡å¼éƒ¨ç½²å¤šä¸ªèŠ‚ç‚¹ï¼Œç¡®ä¿é«˜å¯ç”¨ã€‚
   - **æ•°æ®åŒæ­¥ï¼š** é…ç½®ä¸­å¿ƒä¸æ³¨å†Œä¸­å¿ƒçš„èŠ‚ç‚¹éœ€è¦å®ç°æ•°æ®åŒæ­¥æœºåˆ¶ï¼Œé¿å…å•ç‚¹æ•…éšœã€‚
   - **å®¢æˆ·ç«¯é‡è¯•æœºåˆ¶ï¼š** æœåŠ¡ç«¯å‡ºç°æ•…éšœæ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡é‡è¯•æœºåˆ¶è¿æ¥å…¶ä»–å¯ç”¨èŠ‚ç‚¹ã€‚
2. **é…ç½®ä¸­å¿ƒé«˜å¯ç”¨ï¼š**
   - **é›†ç¾¤éƒ¨ç½²ï¼š** é…ç½®ä¸­å¿ƒï¼ˆå¦‚ Nacosï¼‰æ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œä¿è¯é…ç½®çš„é«˜å¯ç”¨æ€§ã€‚
   - **æ•°æ®å¤‡ä»½ï¼š** å®šæœŸå¤‡ä»½é…ç½®ä¿¡æ¯ï¼Œé˜²æ­¢é…ç½®ä¸¢å¤±ã€‚
   - **å®¢æˆ·ç«¯ç¼“å­˜ï¼š** åœ¨é…ç½®ä¸­å¿ƒæ— æ³•è®¿é—®æ—¶ï¼Œå¯ä»¥é€šè¿‡æœ¬åœ°ç¼“å­˜ä½¿ç”¨æ—§çš„é…ç½®ã€‚

------

## â“ **JWT å¦‚ä½•è®¾è®¡åˆ·æ–°æœºåˆ¶ï¼Ÿå¦‚ä½•é˜²æ­¢è¢«ç¯¡æ”¹ï¼Ÿ**

- **JWT åˆ·æ–°æœºåˆ¶ï¼š**
  - å¯ä»¥ä½¿ç”¨ **Access Token** å’Œ **Refresh Token** é…åˆä½¿ç”¨ï¼ŒAccess Token ç”¨äºçŸ­æ—¶é—´çš„è®¤è¯ï¼Œè¿‡æœŸåé€šè¿‡ Refresh Token åˆ·æ–°è·å–æ–°çš„ Access Tokenã€‚
  - **Refresh Token** ä¸€èˆ¬è¾ƒé•¿æœ‰æ•ˆæœŸï¼Œå¯ä»¥é€šè¿‡å®šæœŸåˆ·æ–°æ¥ä¿è¯ç”¨æˆ·æŒç»­ç™»å½•ã€‚
- **é˜²æ­¢ç¯¡æ”¹ï¼š**
  - ä½¿ç”¨ **ç­¾å**ï¼šJWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šå¤´éƒ¨ã€è½½è·å’Œç­¾åã€‚ç­¾åéƒ¨åˆ†ä½¿ç”¨å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œç¡®ä¿æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æœªè¢«ç¯¡æ”¹ã€‚
  - ä½¿ç”¨ **HMAC SHA-256** æˆ– **RSA** ç­‰åŠ å¯†ç®—æ³•ç”Ÿæˆç­¾åï¼Œä¿éšœæ•°æ®çš„å®Œæ•´æ€§ã€‚

------

## â“ **Seata çš„ Undo æ—¥å¿—ä¼šä¸ä¼šå¤ªé‡ï¼Ÿä¼šä¸ä¼šé€ æˆä¸»åº“å‹åŠ›ï¼Ÿ**

- **Undo æ—¥å¿—**ï¼šSeata ä½¿ç”¨ Undo æ—¥å¿—æ¥è®°å½•æ•°æ®å˜æ›´çš„å‰å€¼ï¼Œä»¥ä¾¿åœ¨äº‹åŠ¡å›æ»šæ—¶èƒ½æ¢å¤æ•°æ®ã€‚
- **æ˜¯å¦é‡ï¼Ÿ**ï¼š
  - **Undo æ—¥å¿—çš„å¼€é”€**ï¼šå¯¹äºå¤§éƒ¨åˆ†åœºæ™¯ï¼ŒUndo æ—¥å¿—çš„å­˜å‚¨å¼€é”€è¾ƒå°ï¼Œä½†åœ¨å¤§é‡äº‹åŠ¡æ“ä½œçš„æƒ…å†µä¸‹å¯èƒ½ä¼šå¢åŠ æ•°æ®åº“è´Ÿæ‹…ã€‚
- **ä¸»åº“å‹åŠ›**ï¼š
  - **è§£å†³æ–¹æ¡ˆ**ï¼šå¯ä»¥å°† Undo æ—¥å¿—å­˜å‚¨åˆ°å•ç‹¬çš„è¡¨ä¸­ï¼Œå‡å°‘ä¸»åº“çš„å‹åŠ›ï¼›åŒæ—¶ Seata æ”¯æŒå°† Undo æ—¥å¿—å­˜å‚¨åˆ°åˆ†å¸ƒå¼æ•°æ®åº“æˆ– NoSQL ç³»ç»Ÿï¼Œä»¥é™ä½å¯¹ä¸»åº“çš„å½±å“ã€‚

------

## â“ **é¢è¯•åœºæ™¯é¢˜ç²¾é€‰ï¼šç°åº¦å‘å¸ƒã€çƒ­ç‚¹é™æµã€é“¾è·¯ä¸¢å¤±æ’æŸ¥**

1. **ç°åº¦å‘å¸ƒï¼š**
   - **é¢è¯•é¢˜è§£ç­”**ï¼šç°åº¦å‘å¸ƒä¸€èˆ¬é€šè¿‡ç½‘å…³å±‚ã€æœåŠ¡æ ‡ç­¾ã€è¯·æ±‚å¤´ç­‰ç»´åº¦æ§åˆ¶æµé‡ï¼Œå°†æµé‡é€æ­¥åˆ‡æ¢åˆ°æ–°çš„ç‰ˆæœ¬ã€‚å¯ä»¥ç»“åˆ Nacos åŠ¨æ€è·¯ç”±ä¸ Spring Cloud Gateway å®ç°ã€‚
2. **çƒ­ç‚¹é™æµï¼š**
   - **é¢è¯•é¢˜è§£ç­”**ï¼šçƒ­ç‚¹é™æµä¸»è¦è§£å†³æŸäº›ç‰¹å®šèµ„æºï¼ˆå¦‚ç‰¹å®šå‚æ•°ã€è¯·æ±‚è·¯å¾„ç­‰ï¼‰çš„è®¿é—®è¿‡äºé¢‘ç¹çš„é—®é¢˜ã€‚é€šè¿‡ Sentinel ç­‰å·¥å…·å¯ä»¥åŸºäº URIã€IPã€è¯·æ±‚å‚æ•°ç­‰ç»´åº¦å®ç°æµé‡æ§åˆ¶ã€‚
3. **é“¾è·¯ä¸¢å¤±æ’æŸ¥ï¼š**
   - **é¢è¯•é¢˜è§£ç­”**ï¼šé“¾è·¯ä¸¢å¤±é—®é¢˜é€šå¸¸ç”±äº TraceId æ²¡æœ‰æ­£ç¡®ä¼ é€’æˆ–æ—¥å¿—ç³»ç»Ÿçš„é…ç½®é—®é¢˜ã€‚æ’æŸ¥æ­¥éª¤åŒ…æ‹¬ï¼š
     - ç¡®è®¤ TraceId æ˜¯å¦æ­£ç¡®ä¼ é€’ï¼Œæ˜¯å¦åœ¨ Feignã€Gatewayã€RestTemplate ä¸­æ­£ç¡®è®¾ç½®ã€‚
     - æ£€æŸ¥ Sleuth ä¸ Zipkin é…ç½®ï¼Œç¡®ä¿ TraceId èƒ½åœ¨å„ä¸ªå¾®æœåŠ¡é—´æµè½¬ã€‚
     - é€šè¿‡æ—¥å¿—ç³»ç»ŸæŸ¥çœ‹æ˜¯å¦æœ‰é—æ¼çš„é“¾è·¯ä¿¡æ¯ã€‚

------

