<template><div><h1 id="目录" tabindex="-1"><a class="header-anchor" href="#目录"><span>目录</span></a></h1>
<h2 id="一、redis核心数据结构深度应用" tabindex="-1"><a class="header-anchor" href="#一、redis核心数据结构深度应用"><span><strong>一、Redis核心数据结构深度应用</strong></span></a></h2>
<ol>
<li><strong>五种基础类型高阶技巧</strong><br>
• String类型在原子计数与分布式锁中的实战<br>
• Hash实现多字段频繁更新的性能优化<br>
• List作为消息队列的可靠性保障与内存控制</li>
<li><strong>特殊数据结构实战场景</strong><br>
• Bitmap实现用户行为统计（如日活、留存）<br>
• HyperLogLog在去重场景下的误差分析与优化<br>
• Stream在消息队列中的消费组（Consumer Group）管理</li>
</ol>
<hr>
<h2 id="二、redis持久化与高可用架构" tabindex="-1"><a class="header-anchor" href="#二、redis持久化与高可用架构"><span><strong>二、Redis持久化与高可用架构</strong></span></a></h2>
<ol>
<li><strong>持久化机制深度解析</strong><br>
• RDB与AOF混合持久化的配置与取舍<br>
• AOF重写对性能的影响及优化策略</li>
<li><strong>高可用方案对比与实践</strong><br>
• 主从复制中的全量/增量同步瓶颈排查<br>
• Sentinel集群的Leader选举机制与生产故障模拟<br>
• Cluster模式下Slot迁移导致的请求倾斜问题解决</li>
<li><strong>跨地域多活设计</strong><br>
• Redisson实现跨机房数据同步<br>
• 读写分离与就近访问策略</li>
</ol>
<hr>
<h2 id="三、redis性能调优与生产监控" tabindex="-1"><a class="header-anchor" href="#三、redis性能调优与生产监控"><span><strong>三、Redis性能调优与生产监控</strong></span></a></h2>
<ol>
<li><strong>内存优化核心技术</strong><br>
• ziplist与quicklist的内部结构解析<br>
• 大Key检测与分拆方案（10MB+ Value处理）<br>
• 内存碎片率（mem_fragmentation_ratio）调优</li>
<li><strong>延迟问题诊断与解决</strong><br>
• 慢查询日志（slowlog）的分析与优化<br>
• 网络抖动引起的Redis集群脑裂解决方案<br>
• CPU绑核（taskset）与NUMA架构优化</li>
<li><strong>Redis集群监控体系</strong><br>
• Prometheus+Redis_exporter监控指标采集<br>
• Grafana可视化看板关键指标（QPS、内存、连接数）<br>
• Key过期与逐出策略（eviction）动态调整</li>
</ol>
<hr>
<h2 id="四、redis扩展功能与企业级实战" tabindex="-1"><a class="header-anchor" href="#四、redis扩展功能与企业级实战"><span><strong>四、Redis扩展功能与企业级实战</strong></span></a></h2>
<ol>
<li><strong>Lua脚本高级编程</strong><br>
• 原子操作实现复杂业务（秒杀库存扣减+订单创建）<br>
• 脚本调试与性能优化（避免全局变量、复用SHA）</li>
<li><strong>Redis Modules开发实战</strong><br>
• 使用RediSearch实现全文检索功能<br>
• 基于RedisTimeSeries的实时监控数据存储<br>
• 自定义模块开发（C语言扩展）</li>
<li><strong>Redis与Spring生态整合</strong><br>
• Lettuce连接池参数调优（maxActive、maxWait）<br>
• Spring Cache注解实现多级缓存联动<br>
• Redis分布式Session存储的GC策略</li>
</ol>
<hr>
<h2 id="五、生产环境安全与运维最佳实践" tabindex="-1"><a class="header-anchor" href="#五、生产环境安全与运维最佳实践"><span><strong>五、生产环境安全与运维最佳实践</strong></span></a></h2>
<ol>
<li><strong>安全防护体系</strong><br>
• ACL权限控制与RBAC模型实现<br>
• TLS加密传输配置（SSL/TLS双向认证）<br>
• 防注入攻击的Lua脚本沙箱机制</li>
<li><strong>备份与恢复方案</strong><br>
• RDB文件冷备与S3云存储集成<br>
• AOF日志实时同步到HDFS<br>
• 跨集群数据迁移（redis-port工具实战）</li>
<li><strong>版本升级与故障处理</strong><br>
• 集群滚动升级（从5.x到7.x兼容性处理）<br>
• 热点Key导致的CPU飙高问题定位<br>
• 内存暴增的快速定位与OOM防御</li>
</ol>
<hr>
<h2 id="六、redis在云原生场景的实践" tabindex="-1"><a class="header-anchor" href="#六、redis在云原生场景的实践"><span><strong>六、Redis在云原生场景的实践</strong></span></a></h2>
<ol>
<li><strong>Kubernetes部署方案</strong><br>
• StatefulSet实现Redis Cluster自动化部署<br>
• 本地存储（Local PV）与网络延迟优化<br>
• Horizontal Pod Autoscaling动态扩缩容</li>
<li><strong>混合云与多活架构</strong><br>
• 阿里云Redis与自建集群的混合订阅<br>
• AWS ElastiCache的VPC Peering配置</li>
<li><strong>Serverless架构下的Redis应用</strong><br>
• 函数计算（FC）中的Redis连接池管理<br>
• 冷启动场景下的缓存预热策略</li>
</ol>
<hr>
<h2 id="七、面试高频题解析与实战案例" tabindex="-1"><a class="header-anchor" href="#七、面试高频题解析与实战案例"><span><strong>七、面试高频题解析与实战案例</strong></span></a></h2>
<ol>
<li><strong>大厂面试题精选</strong><br>
• Redis如何实现分布式限流（令牌桶算法）？<br>
• Cluster模式下如何优雅处理节点失效？<br>
• Redis事务与MySQL事务的ACID对比</li>
<li><strong>复杂场景设计题</strong><br>
• 设计日活千万级的Feed流系统（Redis+分库分表）<br>
• 亿级用户实时排行榜的存储与更新方案</li>
<li><strong>生产故障案例分析</strong><br>
• 某金融企业缓存穿透导致DB雪崩的复盘<br>
• 大促期间Redis Cluster带宽打满的应急处理</li>
</ol>
<hr>
<h1 id="一、redis核心数据结构深度应用-1" tabindex="-1"><a class="header-anchor" href="#一、redis核心数据结构深度应用-1"><span><strong>一、Redis核心数据结构深度应用</strong></span></a></h1>
<hr>
<h2 id="_1-五种基础类型高阶技巧" tabindex="-1"><a class="header-anchor" href="#_1-五种基础类型高阶技巧"><span><strong>1. 五种基础类型高阶技巧</strong></span></a></h2>
<h4 id="_1-1-string类型在原子计数与分布式锁中的实战" tabindex="-1"><a class="header-anchor" href="#_1-1-string类型在原子计数与分布式锁中的实战"><span><strong>1.1 String类型在原子计数与分布式锁中的实战</strong></span></a></h4>
<p>• <strong>原子计数</strong>：<br>
• <strong>场景</strong>：电商商品库存扣减、秒杀活动计数器。<br>
• <strong>命令与Java实现</strong>：<br>
```java<br>
// 初始化库存<br>
redisTemplate.opsForValue().set(&quot;product:1001:stock&quot;, &quot;1000&quot;);</p>
<pre><code>// 原子扣减库存（INCRBY负值实现）  
Long remain = redisTemplate.opsForValue()  
    .increment(&quot;product:1001:stock&quot;, -1L);  
if (remain &lt; 0) {  
    // 库存不足，回滚  
    redisTemplate.opsForValue().increment(&quot;product:1001:stock&quot;, 1L);  
    throw new BusinessException(&quot;库存不足&quot;);  
}  
```  
</code></pre>
<p>• <strong>优势</strong>：<code v-pre>INCRBY</code>命令的原子性避免并发超卖。</p>
<p>• <strong>分布式锁</strong>：<br>
• <strong>Redisson实现</strong>：<br>
<code v-pre>java       RLock lock = redissonClient.getLock(&quot;order_lock:&quot; + orderId);       try {           // 尝试加锁，等待时间3秒，锁自动续期           if (lock.tryLock(3, 30, TimeUnit.SECONDS)) {               // 业务逻辑               createOrder(order);           }       } finally {           lock.unlock();       }       </code><br>
• <strong>避坑指南</strong>：<br>
◦ 必须设置合理的锁超时时间（业务最大耗时+缓冲时间）。<br>
◦ 避免锁重入导致死锁（Redisson可重入锁需控制嵌套层级）。</p>
<h4 id="_1-2-hash实现多字段频繁更新的性能优化" tabindex="-1"><a class="header-anchor" href="#_1-2-hash实现多字段频繁更新的性能优化"><span><strong>1.2 Hash实现多字段频繁更新的性能优化</strong></span></a></h4>
<p>• <strong>性能对比实验</strong>：</p>
<table>
<thead>
<tr>
<th><strong>操作</strong></th>
<th>String类型（ms）</th>
<th>Hash类型（ms）</th>
</tr>
</thead>
<tbody>
<tr>
<td>单字段更新（100次）</td>
<td>120</td>
<td>45</td>
</tr>
<tr>
<td>多字段批量更新（10字段）</td>
<td>300</td>
<td>60</td>
</tr>
</tbody>
</table>
<p>• <strong>优化实践</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 使用HMSET批量更新用户信息  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">&#x3C;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">></span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> userMap </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> HashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">&#x3C;></span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">userMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"name"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"Alice"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">userMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"age"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"30"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">userMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"email"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"alice@example.com"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForHash</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">putAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"user:1001"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, userMap);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 部分字段更新  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForHash</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"user:1001"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"age"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"31"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>适用场景</strong>：用户属性、商品规格等多字段频繁修改的场景。</p>
<h4 id="_1-3-list作为消息队列的可靠性保障与内存控制" tabindex="-1"><a class="header-anchor" href="#_1-3-list作为消息队列的可靠性保障与内存控制"><span><strong>1.3 List作为消息队列的可靠性保障与内存控制</strong></span></a></h4>
<p>• <strong>基础消息队列模式</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 生产者（LPUSH）  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">leftPush</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"queue:order"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, orderJson);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 消费者（BRPOP阻塞获取）  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> orderJson </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">rightPop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"queue:order"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">SECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>可靠性增强方案</strong>：<br>
• <strong>备份队列</strong>：使用<code v-pre>RPOPLPUSH</code>将消息转移到处理中队列，处理完成后再删除。<br>
<code v-pre>java       String processingQueue = &quot;queue:order:processing&quot;;       String orderJson = redisTemplate.opsForList()           .rightPopAndLeftPush(&quot;queue:order&quot;, processingQueue, 10, TimeUnit.SECONDS);       // 处理完成后删除       redisTemplate.opsForList().remove(processingQueue, 1, orderJson);       </code><br>
• <strong>内存控制</strong>：通过<code v-pre>LTRIM</code>限制队列长度，避免内存溢出。<br>
<code v-pre>java       // 保留最新1000条消息       redisTemplate.opsForList().trim(&quot;queue:order&quot;, 0, 999);       </code></p>
<hr>
<h2 id="_2-特殊数据结构实战场景" tabindex="-1"><a class="header-anchor" href="#_2-特殊数据结构实战场景"><span><strong>2. 特殊数据结构实战场景</strong></span></a></h2>
<h4 id="_2-1-bitmap实现用户行为统计" tabindex="-1"><a class="header-anchor" href="#_2-1-bitmap实现用户行为统计"><span><strong>2.1 Bitmap实现用户行为统计</strong></span></a></h4>
<p>• <strong>日活统计（DAU）</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 用户1001在2023-10-01活跃  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> key </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "dau:2023-10-01"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">setBit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(key, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1001</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 计算当日活跃用户数  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> count </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">((</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">RedisCallback</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">&#x3C;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">></span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) conn </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD">-></span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">    conn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">bitCount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">())  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>用户留存分析</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 计算次日留存（两日都活跃的用户数）  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> key1 </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "dau:2023-10-01"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> key2 </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "dau:2023-10-02"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> tempKey </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "retention:temp"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">((</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">RedisCallback</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">&#x3C;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">Void</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">></span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) conn </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD">-></span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">    conn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">bitOp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">RedisStringCommands</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">BitOperation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">AND</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">        tempKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(), </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">key1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(), </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">key2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">());  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">});</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> retentionCount </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">bitCount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(tempKey);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-hyperloglog在去重场景下的误差分析与优化" tabindex="-1"><a class="header-anchor" href="#_2-2-hyperloglog在去重场景下的误差分析与优化"><span><strong>2.2 HyperLogLog在去重场景下的误差分析与优化</strong></span></a></h4>
<p>• <strong>误差测试</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 添加100万个元素  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> key </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "uv:product:1001"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">IntStream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">range</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1_000_000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">forEach</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(i </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD">-></span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">    redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForHyperLogLog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(key, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"user"</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> i)  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 获取基数估计值（理论误差0.81%）  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> estimate </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForHyperLogLog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(key);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"估计值: "</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> estimate);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> // 输出: 997536（误差-0.246%）</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>优化方案</strong>：<br>
• <strong>多HLL合并</strong>：将数据分片到多个HLL Key，最后合并计算。<br>
<code v-pre>java       String key1 = &quot;uv:product:1001:shard1&quot;;       String key2 = &quot;uv:product:1001:shard2&quot;;       String mergedKey = &quot;uv:product:1001:merged&quot;;       redisTemplate.opsForHyperLogLog().union(mergedKey, key1, key2);       </code></p>
<h4 id="_2-3-stream在消息队列中的消费组管理" tabindex="-1"><a class="header-anchor" href="#_2-3-stream在消息队列中的消费组管理"><span><strong>2.3 Stream在消息队列中的消费组管理</strong></span></a></h4>
<p>• <strong>生产消息</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">&#x3C;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">></span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> message </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> HashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">&#x3C;></span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"orderId"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"1001"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"amount"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"299.00"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForStream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"stream:orders"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, message);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>消费组创建与消费</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 创建消费组  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForStream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">createGroup</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"stream:orders"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"order_consumers"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 消费者读取消息（自动ACK）  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">&#x3C;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">MapRecord</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">&#x3C;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">>></span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> messages </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForStream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">read</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">Consumer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"order_consumers"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"consumer1"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">),  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">        StreamReadOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">empty</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">),  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">        StreamOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">create</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"stream:orders"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">ReadOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">lastConsumed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">())  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    );</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 处理完成后手动ACK  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForStream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">acknowledge</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"stream:orders"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"order_consumers"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, messageId);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>关键配置</strong>：<br>
• <strong>Pending消息处理</strong>：通过<code v-pre>XPENDING</code>命令监控未ACK消息，设置超时重试。<br>
• <strong>消费者崩溃恢复</strong>：使用<code v-pre>XCLAIM</code>命令将未处理消息转移给其他消费者。</p>
<hr>
<h2 id="总结与生产建议" tabindex="-1"><a class="header-anchor" href="#总结与生产建议"><span><strong>总结与生产建议</strong></span></a></h2>
<p>• <strong>数据结构选型决策树</strong>：</p>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span>if (需要精确去重) → Set/Hash  </span></span>
<span class="line"><span>elif (允许误差去重) → HyperLogLog  </span></span>
<span class="line"><span>elif (高频计数) → String/Hash  </span></span>
<span class="line"><span>elif (消息队列) → Stream/List  </span></span>
<span class="line"><span>elif (位操作统计) → Bitmap</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>性能优化核心原则</strong>：<br>
• <strong>减少网络往返</strong>：优先使用Pipeline、Lua脚本合并操作。<br>
• <strong>内存控制</strong>：对大Value进行分片（如10MB以上的JSON数据拆分为Hash字段）。<br>
• <strong>持久化权衡</strong>：AOF每秒同步（everysec）在性能与可靠性间取得平衡。</p>
<p><strong>生产案例</strong>：某社交平台使用HyperLogLog统计每日UV（用户数），节省98%内存（相比Set），误差稳定在0.8%以内，完全满足业务需求。</p>
<p>通过深度掌握Redis数据结构特性，开发者能够在高并发场景下灵活选择最佳方案，实现高性能、低资源消耗的系统架构。</p>
<hr>
<h1 id="二、redis持久化与高可用架构-1" tabindex="-1"><a class="header-anchor" href="#二、redis持久化与高可用架构-1"><span><strong>二、Redis持久化与高可用架构</strong></span></a></h1>
<hr>
<h2 id="_1-持久化机制深度解析" tabindex="-1"><a class="header-anchor" href="#_1-持久化机制深度解析"><span><strong>1. 持久化机制深度解析</strong></span></a></h2>
<h4 id="_1-1-rdb与aof混合持久化的配置与取舍" tabindex="-1"><a class="header-anchor" href="#_1-1-rdb与aof混合持久化的配置与取舍"><span><strong>1.1 RDB与AOF混合持久化的配置与取舍</strong></span></a></h4>
<p>• <strong>混合持久化原理</strong>：<br>
• <strong>RDB快照</strong>：全量备份，生成紧凑的二进制文件（<code v-pre>dump.rdb</code>）。<br>
• <strong>AOF日志</strong>：记录所有写操作命令（增量），默认每秒同步一次。<br>
• <strong>混合模式</strong>：Redis 4.0+支持，AOF文件包含RDB头部 + AOF增量操作。<br>
• <strong>配置示例（redis.conf）</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 开启混合持久化  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">aof-use-rdb-preamble</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> yes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># RDB配置（每5分钟且至少100次修改触发）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 300</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># AOF配置（每秒同步）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">appendonly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> yes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">appendfsync</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> everysec</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>选型建议</strong>：</p>
<table>
<thead>
<tr>
<th><strong>场景</strong></th>
<th><strong>推荐策略</strong></th>
<th><strong>原因</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>容灾恢复速度优先</td>
<td>RDB</td>
<td>加载速度快（GB级数据秒级恢复）</td>
</tr>
<tr>
<td>数据安全性优先</td>
<td>AOF</td>
<td>最多丢失1秒数据</td>
</tr>
<tr>
<td>平衡恢复速度与安全</td>
<td>混合模式</td>
<td>RDB快照 + AOF增量，兼顾两者优势</td>
</tr>
</tbody>
</table>
<h4 id="_1-2-aof重写对性能的影响及优化策略" tabindex="-1"><a class="header-anchor" href="#_1-2-aof重写对性能的影响及优化策略"><span><strong>1.2 AOF重写对性能的影响及优化策略</strong></span></a></h4>
<p>• <strong>AOF重写过程</strong>：</p>
<ol>
<li><strong>Fork子进程</strong>：生成新的AOF文件，期间父进程继续处理请求。</li>
<li><strong>写入增量命令</strong>：父进程将重写期间的命令写入AOF缓冲区和新AOF文件。<br>
• <strong>性能瓶颈与优化</strong>：</li>
</ol>
<pre><code>• **问题1：Fork阻塞**：  

◦ **监控指标**：`latest_fork_usec`（最近一次Fork耗时）。  
◦ **优化方案**：使用大内存机器，或升级到Redis 6.0+（改进Fork机制）。  
</code></pre>
<p>• <strong>问题2：磁盘IO压力</strong>：<br>
◦ <strong>配置优化</strong>：<br>
<code v-pre>bash         # 调整AOF重写缓冲区大小（默认32MB）         aof-rewrite-buffer-size 64mb         # 减少fsync频率（每32MB数据刷盘一次）         aof-rewrite-incremental-fsync yes         </code><br>
• <strong>问题3：重写期间内存暴增</strong>：<br>
◦ <strong>控制阈值</strong>：避免在内存使用率超过70%时触发重写（通过<code v-pre>auto-aof-rewrite-percentage</code>和<code v-pre>auto-aof-rewrite-min-size</code>调整）。</p>
<hr>
<h2 id="_2-高可用方案对比与实践" tabindex="-1"><a class="header-anchor" href="#_2-高可用方案对比与实践"><span><strong>2. 高可用方案对比与实践</strong></span></a></h2>
<h4 id="_2-1-主从复制中的全量-增量同步瓶颈排查" tabindex="-1"><a class="header-anchor" href="#_2-1-主从复制中的全量-增量同步瓶颈排查"><span><strong>2.1 主从复制中的全量/增量同步瓶颈排查</strong></span></a></h4>
<p>• <strong>全量同步（SYNC）触发条件</strong>：<br>
• 从节点首次连接主节点。<br>
• 主从复制积压缓冲区（<code v-pre>repl_backlog</code>）不足，导致增量同步失败。<br>
• <strong>积压缓冲区配置优化</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 调整积压缓冲区大小（默认1MB，建议设置为256MB）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">repl-backlog-size</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 256mb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 缓冲区存活时间（主节点无连接后的保留时间）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">repl-backlog-ttl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 3600</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>增量同步失败排查步骤</strong>：</p>
<ol>
<li><strong>检查<code v-pre>master_repl_offset</code></strong>：主从节点的偏移量需连续。</li>
<li><strong>监控<code v-pre>repl_backlog_histlen</code></strong>：若历史数据长度不足，需增大<code v-pre>repl-backlog-size</code>。</li>
<li><strong>网络延迟检查</strong>：使用<code v-pre>redis-cli --latency</code>检测主从节点间延迟。</li>
</ol>
<h4 id="_2-2-sentinel集群的leader选举机制与生产故障模拟" tabindex="-1"><a class="header-anchor" href="#_2-2-sentinel集群的leader选举机制与生产故障模拟"><span><strong>2.2 Sentinel集群的Leader选举机制与生产故障模拟</strong></span></a></h4>
<p>• <strong>Leader选举流程</strong>：</p>
<ol>
<li><strong>主观下线（SDOWN）</strong>：单个Sentinel检测到主节点不可达。</li>
<li><strong>客观下线（ODOWN）</strong>：超过半数Sentinel确认主节点故障。</li>
<li><strong>选举Leader</strong>：通过Raft算法选出Leader Sentinel执行故障转移。<br>
• <strong>生产故障模拟（手动触发主节点宕机）</strong>：</li>
</ol>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 1. 杀死主节点进程  </span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">kill</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -9</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> &#x3C;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">master-pi</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">d>  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 2. 观察Sentinel日志  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">tail</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> /var/log/redis/sentinel.log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 3. 验证新主节点  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 26379</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> get-master-addr-by-name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> mymaster</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>Sentinel调优参数</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 减少故障转移时间  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> down-after-milliseconds</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> mymaster</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 5000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  # 5秒判定下线  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> failover-timeout</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> mymaster</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 60000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">        # 故障转移超时时间</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-cluster模式下slot迁移导致的请求倾斜问题解决" tabindex="-1"><a class="header-anchor" href="#_2-3-cluster模式下slot迁移导致的请求倾斜问题解决"><span><strong>2.3 Cluster模式下Slot迁移导致的请求倾斜问题解决</strong></span></a></h4>
<p>• <strong>请求倾斜现象</strong>：<br>
• 迁移过程中，客户端可能访问到已迁移的Slot，触发<code v-pre>MOVED</code>重定向。<br>
• 客户端未及时更新集群拓扑，导致请求集中在部分节点。<br>
• <strong>解决方案</strong>：</p>
<ol>
<li><strong>客户端优化</strong>：<br>
◦ 使用支持Smart Client的驱动（如Lettuce），自动处理<code v-pre>MOVED</code>/<code v-pre>ASK</code>重定向。<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">ClusterClientOptions</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> options </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> ClusterClientOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">builder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">validateClusterNodeMembership</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  // 禁用节点校验  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">();</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li><strong>迁移策略调整</strong>：<br>
◦ 采用渐进式迁移，每次迁移少量Slot（通过<code v-pre>CLUSTER SETSLOT &lt;slot&gt; IMPORTING/MIGRATING</code>控制）。<br>
◦ 使用<code v-pre>CLUSTER REBALANCE</code>命令自动平衡Slot分布。</li>
</ol>
<hr>
<h2 id="_3-跨地域多活设计" tabindex="-1"><a class="header-anchor" href="#_3-跨地域多活设计"><span><strong>3. 跨地域多活设计</strong></span></a></h2>
<h4 id="_3-1-redisson实现跨机房数据同步" tabindex="-1"><a class="header-anchor" href="#_3-1-redisson实现跨机房数据同步"><span><strong>3.1 Redisson实现跨机房数据同步</strong></span></a></h4>
<p>• <strong>异地双写方案</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 写入时同步到两个机房  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">RLock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> lock </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> redissonClient1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">getLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"lock:key"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">();</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75"> {  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">    redisTemplate1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"key"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"value"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">    redisTemplate2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"key"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"value"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75"> {  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">    lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">();</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>数据同步延迟处理</strong>：<br>
• <strong>版本号控制</strong>：写入时携带时间戳版本，读取时合并最新值。<br>
• <strong>冲突解决</strong>：业务层根据优先级（如最后写入优先）处理冲突。</p>
<h4 id="_3-2-读写分离与就近访问策略" tabindex="-1"><a class="header-anchor" href="#_3-2-读写分离与就近访问策略"><span><strong>3.2 读写分离与就近访问策略</strong></span></a></h4>
<p>• <strong>读写分离配置</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 使用Lettuce配置读写分离  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">RedisStaticMasterReplicaConfiguration</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> config </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> RedisStaticMasterReplicaConfiguration</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"master-host"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 6379</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">addNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"replica-host"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">6380</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">LettuceClientConfiguration</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> clientConfig </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> LettuceClientConfiguration</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">builder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">readFrom</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">ReadFrom</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">REPLICA_PREFERRED</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  // 优先从副本读  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">();</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">RedisConnectionFactory</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> factory </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> LettuceConnectionFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">(config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75"> clientConfig)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>就近访问（DNS+VIP）</strong>：<br>
• <strong>架构设计</strong>：<br>
1. 不同地域部署Redis集群，通过DNS解析到最近的VIP。<br>
2. 客户端配置动态路由，根据延迟自动选择最优节点。<br>
• <strong>性能测试</strong>：跨机房延迟从50ms降至5ms（同机房访问）。</p>
<hr>
<h2 id="总结与生产经验" tabindex="-1"><a class="header-anchor" href="#总结与生产经验"><span><strong>总结与生产经验</strong></span></a></h2>
<p>• <strong>持久化与高可用选型矩阵</strong>：</p>
<table>
<thead>
<tr>
<th><strong>场景</strong></th>
<th><strong>推荐方案</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>单机房高可用</td>
<td>Redis Sentinel + AOF混合持久化</td>
</tr>
<tr>
<td>多机房容灾</td>
<td>Redis Cluster跨机房部署 + 双写策略</td>
</tr>
<tr>
<td>海量数据水平扩展</td>
<td>Redis Cluster分片 + 动态Slot迁移</td>
</tr>
</tbody>
</table>
<p>• <strong>故障排查工具箱</strong>：<br>
• <strong>命令工具</strong>：<code v-pre>INFO replication</code>（主从状态）、<code v-pre>CLUSTER NODES</code>（集群拓扑）、<code v-pre>SLOWLOG</code>（慢查询）。<br>
• <strong>监控平台</strong>：Prometheus（采集<code v-pre>redis_exporter</code>指标）+ Grafana（可视化）。</p>
<p><strong>生产案例</strong>：某金融系统通过跨机房双写 + 版本号冲突解决，实现RPO（恢复点目标）≈0，RTO（恢复时间目标）&lt;30秒，满足监管要求。</p>
<p>通过合理设计持久化策略、高可用架构与跨地域同步方案，Redis可支撑金融级的高可用性与数据一致性需求，为业务连续性提供坚实保障。</p>
<hr>
<h1 id="三、redis性能调优与生产监控-1" tabindex="-1"><a class="header-anchor" href="#三、redis性能调优与生产监控-1"><span><strong>三、Redis性能调优与生产监控</strong></span></a></h1>
<hr>
<h2 id="_1-内存优化核心技术" tabindex="-1"><a class="header-anchor" href="#_1-内存优化核心技术"><span><strong>1. 内存优化核心技术</strong></span></a></h2>
<h4 id="_1-1-ziplist与quicklist的内部结构解析" tabindex="-1"><a class="header-anchor" href="#_1-1-ziplist与quicklist的内部结构解析"><span><strong>1.1 ziplist与quicklist的内部结构解析</strong></span></a></h4>
<p>• <strong>ziplist（压缩列表）</strong>：<br>
• <strong>结构特点</strong>：连续内存块存储多个元素，通过长度编码节省内存。<br>
• <strong>适用场景</strong>：小规模列表（元素数量 &lt; 512，元素大小 &lt; 64字节）。<br>
• <strong>配置优化</strong>：<br>
<code v-pre>bash       # 修改ziplist阈值（redis.conf）       hash-max-ziplist-entries 512       hash-max-ziplist-value 64       list-max-ziplist-size -2  # 默认8KB       </code><br>
• <strong>quicklist（快速列表）</strong>：<br>
• <strong>结构特点</strong>：由多个ziplist通过双向链表连接，平衡内存与性能。<br>
• <strong>内存节省示例</strong>：存储1000个元素的列表，内存占用减少40%（对比普通链表）。</p>
<h4 id="_1-2-大key检测与分拆方案" tabindex="-1"><a class="header-anchor" href="#_1-2-大key检测与分拆方案"><span><strong>1.2 大Key检测与分拆方案</strong></span></a></h4>
<p>• <strong>大Key检测方法</strong>：<br>
• <strong>命令行工具</strong>：<br>
<code v-pre>bash       # 扫描大于10MB的Key       redis-cli --bigkeys --memkeys 10       </code><br>
• <strong>Lua脚本统计</strong>：<br>
<code v-pre>lua       local keys = redis.call('keys', '*')       for _, key in ipairs(keys) do           local type = redis.call('type', key)['ok']           local size = 0           if type == 'string' then               size = redis.call('memory', 'usage', key)           elseif type == 'hash' then               size = redis.call('hlen', key) * 100  -- 估算字段平均大小           end           if size &gt; 10*1024*1024 then               print(key, type, size)           end       end       </code><br>
• <strong>分拆策略</strong>：<br>
• <strong>Hash分片</strong>：将大Hash拆分为多个Key（如<code v-pre>user:1001:info:base</code>、<code v-pre>user:1001:info:detail</code>）。<br>
• <strong>List分片</strong>：按范围分片（如<code v-pre>article:comments:1001:part1</code>、<code v-pre>article:comments:1001:part2</code>）。</p>
<h4 id="_1-3-内存碎片率调优" tabindex="-1"><a class="header-anchor" href="#_1-3-内存碎片率调优"><span><strong>1.3 内存碎片率调优</strong></span></a></h4>
<p>• <strong>碎片率计算</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 内存碎片率 = used_memory_rss / used_memory  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> info</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> memory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> mem_fragmentation_ratio</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>健康指标</strong>：1.0~1.5为正常，&gt;1.5需优化。<br>
• <strong>优化方案</strong>：<br>
• <strong>重启节点</strong>：直接释放碎片内存（需主从切换保证可用性）。<br>
• <strong>内存碎片整理</strong>：<br>
<code v-pre>bash       # 手动触发整理（阻塞操作，低峰期执行）       redis-cli memory purge       # 自动整理配置       config set activedefrag yes       </code></p>
<hr>
<h2 id="_2-延迟问题诊断与解决" tabindex="-1"><a class="header-anchor" href="#_2-延迟问题诊断与解决"><span><strong>2. 延迟问题诊断与解决</strong></span></a></h2>
<h4 id="_2-1-慢查询日志分析与优化" tabindex="-1"><a class="header-anchor" href="#_2-1-慢查询日志分析与优化"><span><strong>2.1 慢查询日志分析与优化</strong></span></a></h4>
<p>• <strong>慢查询配置</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 记录超过5ms的查询（redis.conf）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">slowlog-log-slower-than</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 5000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">slowlog-max-len</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 1000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  # 保留1000条记录</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>日志分析工具</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 获取慢查询  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> slowlog</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> get</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 输出示例：  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 1) 1) (integer) 12               # 日志ID  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#    2) (integer) 1630450000       # 时间戳  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#    3) (integer) 15000            # 耗时（微秒）  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#    4) 1) "KEYS"                  # 命令  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#       2) "*"</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>优化措施</strong>：<br>
• <strong>避免<code v-pre>KEYS *</code></strong>：使用<code v-pre>SCAN</code>迭代替代。<br>
• <strong>批量操作</strong>：使用<code v-pre>MGET</code>/<code v-pre>MSET</code>替代循环单次操作。</p>
<h4 id="_2-2-网络抖动与集群脑裂解决方案" tabindex="-1"><a class="header-anchor" href="#_2-2-网络抖动与集群脑裂解决方案"><span><strong>2.2 网络抖动与集群脑裂解决方案</strong></span></a></h4>
<p>• <strong>脑裂现象</strong>：主节点因网络隔离继续接收写请求，导致数据不一致。<br>
• <strong>预防配置</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 要求至少2个从节点在线  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">min-replicas-to-write</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 从节点延迟不超过10秒  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">min-replicas-max-lag</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 10</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>恢复流程</strong>：</p>
<ol>
<li><strong>手动介入</strong>：选择数据最新的主节点。</li>
<li><strong>数据合并</strong>：使用<code v-pre>redis-check-rdb</code>对比RDB文件差异。</li>
<li><strong>从节点同步</strong>：重置旧主节点为从节点并同步数据。</li>
</ol>
<h4 id="_2-3-cpu绑核与numa架构优化" tabindex="-1"><a class="header-anchor" href="#_2-3-cpu绑核与numa架构优化"><span><strong>2.3 CPU绑核与NUMA架构优化</strong></span></a></h4>
<p>• <strong>CPU绑核（taskset）</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 将Redis进程绑定到CPU核心0-3  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">taskset</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 0-3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> $(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">pidof</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis-server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>NUMA优化</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 启动时指定NUMA节点  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">numactl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --cpunodebind=0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --membind=0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis-server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis.conf</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>中断亲和性设置</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 将网络中断分配到指定CPU核心  </span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "FFF"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> > </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">/proc/irq/</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">&#x3C;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">irq_nu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">m></span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">/smp_affinity</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><hr>
<h2 id="_3-redis集群监控体系" tabindex="-1"><a class="header-anchor" href="#_3-redis集群监控体系"><span><strong>3. Redis集群监控体系</strong></span></a></h2>
<h4 id="_3-1-prometheus-redis-exporter监控配置" tabindex="-1"><a class="header-anchor" href="#_3-1-prometheus-redis-exporter监控配置"><span><strong>3.1 Prometheus + Redis_exporter监控配置</strong></span></a></h4>
<p>• <strong>部署Redis_exporter</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 启动Exporter（监控多个实例）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">./redis_exporter</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --redis.addr=redis://192.168.1.100:6379</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2"> \ </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">                 --redis.addr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">=redis://192.168.1.101:6379</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>Prometheus抓取配置</strong>：</p>
<div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">scrape_configs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">job_name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'redis'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    static_configs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">      - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">targets</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'192.168.1.100:9121'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">]</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>关键监控指标</strong>：<br>
• <strong>QPS</strong>：<code v-pre>redis_commands_processed_total</code><br>
• <strong>内存使用</strong>：<code v-pre>redis_memory_used_bytes</code><br>
• <strong>连接数</strong>：<code v-pre>redis_connected_clients</code></p>
<h4 id="_3-2-grafana可视化看板" tabindex="-1"><a class="header-anchor" href="#_3-2-grafana可视化看板"><span><strong>3.2 Grafana可视化看板</strong></span></a></h4>
<p>• <strong>核心图表配置</strong>：</p>
<div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- 内存碎片率  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">redis_memory_used_rss_bytes{instance</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"$instance"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">} / redis_memory_used_bytes{instance</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"$instance"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">}  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- 缓存命中率  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">redis_keyspace_hits_total{instance</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"$instance"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">} /  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(redis_keyspace_hits_total{instance</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"$instance"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">} + redis_keyspace_misses_total{instance</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"$instance"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">})</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>生产仪表板示例</strong>：<br>
<img src="https://grafana.com/static/img/docs/redis_dashboard.png" alt="Grafana Redis监控看板"></p>
<h4 id="_3-3-key过期与逐出策略调优" tabindex="-1"><a class="header-anchor" href="#_3-3-key过期与逐出策略调优"><span><strong>3.3 Key过期与逐出策略调优</strong></span></a></h4>
<p>• <strong>过期策略配置</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 主动过期检查频率（默认10次/秒）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">hz</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 20</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 最大内存限制（超出触发逐出）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">maxmemory</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 16gb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 逐出策略（LRU）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">maxmemory-policy</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> allkeys-lru</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>策略对比</strong>：</p>
<table>
<thead>
<tr>
<th><strong>策略</strong></th>
<th><strong>特点</strong></th>
<th><strong>适用场景</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code v-pre>volatile-lru</code></td>
<td>仅淘汰有过期时间的Key的LRU</td>
<td>混合缓存（部分Key过期）</td>
</tr>
<tr>
<td><code v-pre>allkeys-lfu</code></td>
<td>全Key淘汰（访问频率最低）</td>
<td>长期缓存（如用户画像）</td>
</tr>
<tr>
<td><code v-pre>noeviction</code></td>
<td>不淘汰，写入返回错误</td>
<td>不可丢失数据的场景</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="总结与调优手册" tabindex="-1"><a class="header-anchor" href="#总结与调优手册"><span><strong>总结与调优手册</strong></span></a></h2>
<p>• <strong>内存优化Checklist</strong>：</p>
<ol>
<li>每日定时执行<code v-pre>--bigkeys</code>扫描。</li>
<li>每周检查<code v-pre>mem_fragmentation_ratio</code>，超过1.5触发整理。</li>
<li>调整<code v-pre>ziplist</code>配置以适应业务数据特征。<br>
• <strong>延迟调优手册</strong>：</li>
</ol>
<pre><code>• **网络**：使用`ping`检测跨机房延迟，超过50ms考虑就近部署。  
• **CPU**：避免Redis进程与高CPU应用（如Kafka）共享物理核心。  
</code></pre>
<p>• <strong>监控告警规则</strong>：</p>
<div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># Alertmanager配置示例  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">- </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">alert</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">RedisHighMemoryFragmentation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  expr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis_memory_used_rss_bytes / redis_memory_used_bytes > 1.5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">1h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  labels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    severity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">warning</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  annotations</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    summary</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"Redis内存碎片率过高 (实例 {{ $labels.instance }})"</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生产案例</strong>：某电商平台通过调整<code v-pre>ziplist</code>配置，将商品属性Hash的内存占用从2GB降至800MB，同时查询效率提升30%。</p>
<p>通过系统性监控与调优，Redis集群可支撑百万级QPS，平均延迟稳定在1ms以内，成为高并发场景下的核心基础设施。</p>
<hr>
<h1 id="四、redis扩展功能与企业级实战-1" tabindex="-1"><a class="header-anchor" href="#四、redis扩展功能与企业级实战-1"><span><strong>四、Redis扩展功能与企业级实战</strong></span></a></h1>
<hr>
<h2 id="_1-lua脚本高级编程" tabindex="-1"><a class="header-anchor" href="#_1-lua脚本高级编程"><span><strong>1. Lua脚本高级编程</strong></span></a></h2>
<h4 id="_1-1-原子操作实现复杂业务-秒杀库存扣减-订单创建" tabindex="-1"><a class="header-anchor" href="#_1-1-原子操作实现复杂业务-秒杀库存扣减-订单创建"><span><strong>1.1 原子操作实现复杂业务（秒杀库存扣减+订单创建）</strong></span></a></h4>
<p>• <strong>场景需求</strong>：在高并发下保证库存扣减与订单创建的原子性，避免超卖。<br>
• <strong>Lua脚本实现</strong>：</p>
<div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- KEYS[1]: 库存Key  ARGV[1]: 扣减数量  ARGV[2]: 订单ID  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'GET'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">KEYS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">]))  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> >= </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">]) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">then</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'DECRBY'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">KEYS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">], </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">])  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'HSET'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'orders'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">], </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'created'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  -- 成功  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  -- 库存不足  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">end</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>Java调用示例</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> script </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "..."</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> // 上述Lua脚本  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> sha </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">scriptLoad</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(script);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">Boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> DefaultRedisScript</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">&#x3C;>(script, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">Boolean</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">class</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">),  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">    List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">of</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"stock:1001"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">),  </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">    "1"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"order_20231101123456"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>性能优化</strong>：<br>
• <strong>复用SHA</strong>：预加载脚本获取SHA值，减少网络传输开销。<br>
• <strong>避免全局变量</strong>：所有变量通过<code v-pre>local</code>声明，防止内存泄漏。</p>
<h4 id="_1-2-脚本调试与性能优化" tabindex="-1"><a class="header-anchor" href="#_1-2-脚本调试与性能优化"><span><strong>1.2 脚本调试与性能优化</strong></span></a></h4>
<p>• <strong>调试工具</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 使用redis-cli调试  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --ldb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --eval</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> /path/to/script.lua</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> key1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> key2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> arg1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> arg2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 进入调试模式后，使用命令逐步执行  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">lua</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> debugge</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">r> </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">step</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">lua</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> debugge</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">r> </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">print</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> stock</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>性能优化技巧</strong>：<br>
• <strong>批量操作</strong>：合并多个Redis命令减少网络开销。<br>
• <strong>限制脚本复杂度</strong>：避免在Lua中执行<code v-pre>O(n)</code>复杂度的循环。</p>
<hr>
<h2 id="_2-redis-modules开发实战" tabindex="-1"><a class="header-anchor" href="#_2-redis-modules开发实战"><span><strong>2. Redis Modules开发实战</strong></span></a></h2>
<h4 id="_2-1-使用redisearch实现全文检索功能" tabindex="-1"><a class="header-anchor" href="#_2-1-使用redisearch实现全文检索功能"><span><strong>2.1 使用RediSearch实现全文检索功能</strong></span></a></h4>
<p>• <strong>索引创建</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">FT.CREATE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> product_idx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ON</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> HASH</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> PREFIX</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "product:"</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> SCHEMA</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">  name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> TEXT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> WEIGHT</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 5.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">  description</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> TEXT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">  price</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> NUMERIC</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>查询示例</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 搜索名称包含"手机"且价格低于3000的商品  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">FT.SEARCH</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> product_idx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "@name:手机 @price:[0 3000]"</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>Java集成</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">RediSearchClient</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> client </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> RediSearchClient</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">(redisConnection)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">SearchResult</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> client</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">search</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"product_idx"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"华为手机"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-基于redistimeseries的实时监控数据存储" tabindex="-1"><a class="header-anchor" href="#_2-2-基于redistimeseries的实时监控数据存储"><span><strong>2.2 基于RedisTimeSeries的实时监控数据存储</strong></span></a></h4>
<p>• <strong>数据写入</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">TS.CREATE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> server.cpu_usage</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> LABELS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "web01"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">TS.ADD</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> server.cpu_usage</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 85</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>聚合查询</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 查询最近5分钟CPU使用率的平均值  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">TS.RANGE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> server.cpu_usage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (now-300000) now AGGREGATION avg 60000</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>告警规则</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">TS.CREATE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> RULE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> server.cpu_alert</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> WHEN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> max</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> OVER</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5m</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> > </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">90</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> DO</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "notify.sh"</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><h4 id="_2-3-自定义模块开发-c语言扩展" tabindex="-1"><a class="header-anchor" href="#_2-3-自定义模块开发-c语言扩展"><span><strong>2.3 自定义模块开发（C语言扩展）</strong></span></a></h4>
<p>• <strong>开发步骤</strong>：</p>
<ol>
<li><strong>编写模块代码</strong>：<div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "redismodule.h"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> HelloCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">RedisModuleCtx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75"> RedisModuleString </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">**</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">argv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic"> argc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) {  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">    RedisModule_ReplyWithString</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(ctx, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"Hello, Redis Module!"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> REDISMODULE_OK;  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">}  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> RedisModule_OnLoad</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">RedisModuleCtx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) {  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">    RedisModule_CreateCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(ctx, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"hello"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, HelloCommand, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">""</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> REDISMODULE_OK;  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li><strong>编译为动态库</strong>：<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">gcc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -fPIC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -shared</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> hello.so</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> hello.c</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div></li>
<li><strong>加载模块</strong>：<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-server</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --loadmodule</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ./hello.so</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div>• <strong>测试命令</strong>：</li>
</ol>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">127.0.0.1:6379</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">> </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">hello</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">"Hello, Redis Module!"</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><hr>
<h2 id="_3-redis与spring生态整合" tabindex="-1"><a class="header-anchor" href="#_3-redis与spring生态整合"><span><strong>3. Redis与Spring生态整合</strong></span></a></h2>
<h4 id="_3-1-lettuce连接池参数调优" tabindex="-1"><a class="header-anchor" href="#_3-1-lettuce连接池参数调优"><span><strong>3.1 Lettuce连接池参数调优</strong></span></a></h4>
<p>• <strong>关键参数配置</strong>：</p>
<div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">spring</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    lettuce</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      pool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        max-active</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">200</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">    # 最大连接数  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        max-idle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">50</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        min-idle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        max-wait</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">5000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">     # 获取连接超时时间（毫秒）</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>监控指标</strong>：<br>
• <strong>连接泄漏检测</strong>：通过<code v-pre>leak-detection-threshold</code>设置阈值（默认0，不检测）。<br>
• <strong>超时优化</strong>：根据平均RT（响应时间）调整<code v-pre>max-wait</code>，例如RT为10ms则设置<code v-pre>max-wait=20ms</code>。</p>
<h4 id="_3-2-spring-cache多级缓存联动" tabindex="-1"><a class="header-anchor" href="#_3-2-spring-cache多级缓存联动"><span><strong>3.2 Spring Cache多级缓存联动</strong></span></a></h4>
<p>• <strong>配置示例</strong>：</p>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B">Configuration</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B">EnableCaching</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> CacheConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B">Bean</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> CacheManager</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> cacheManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">        CaffeineCacheManager</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> caffeineManager</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> CaffeineCacheManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">();  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">        caffeineManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">setCaffeine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">Caffeine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">newBuilder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">expireAfterWrite</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">MINUTES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">));  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">        RedisCacheManager</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> redisManager</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> RedisCacheManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">create</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(redisConnectionFactory);  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">        // 组合缓存（先查本地，再查Redis）  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">        return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> CompositeCacheManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(caffeineManager, redisManager);  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    }</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>缓存同步</strong>：通过Redis Pub/Sub通知其他节点失效本地缓存。</p>
<h4 id="_3-3-redis分布式session的gc策略" tabindex="-1"><a class="header-anchor" href="#_3-3-redis分布式session的gc策略"><span><strong>3.3 Redis分布式Session的GC策略</strong></span></a></h4>
<p>• <strong>Session配置</strong>：</p>
<div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">spring</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  session</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    store-type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      flush-mode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">on_save</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">spring:session</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1800</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  # 30分钟过期</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>GC优化</strong>：<br>
• <strong>定期清理</strong>：通过<code v-pre>spring-session</code>的<code v-pre>RedisOperationsSessionRepository</code>自动清理过期Session。<br>
• <strong>增量式扫描</strong>：使用<code v-pre>SCAN</code>命令替代<code v-pre>KEYS</code>，避免阻塞。</p>
<hr>
<h3 id="总结与生产级最佳实践" tabindex="-1"><a class="header-anchor" href="#总结与生产级最佳实践"><span><strong>总结与生产级最佳实践</strong></span></a></h3>
<p>• <strong>Lua脚本原则</strong>：<br>
• <strong>原子性优先</strong>：复杂业务逻辑尽量封装到Lua脚本。<br>
• <strong>性能测试</strong>：使用<code v-pre>SCRIPT LOAD</code>和<code v-pre>EVALSHA</code>减少网络开销。<br>
• <strong>Modules选型指南</strong>：</p>
<table>
<thead>
<tr>
<th><strong>需求</strong></th>
<th><strong>推荐Module</strong></th>
<th><strong>优势</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>全文搜索</td>
<td>RediSearch</td>
<td>低延迟、支持中文分词</td>
</tr>
<tr>
<td>时间序列分析</td>
<td>RedisTimeSeries</td>
<td>高效存储与聚合计算</td>
</tr>
<tr>
<td>图计算</td>
<td>RedisGraph</td>
<td>实时关系分析</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>• <strong>Spring整合要点</strong>：</th>
</tr>
</thead>
<tbody>
<tr>
<td>• <strong>连接池监控</strong>：通过Micrometer暴露Lettuce指标到Prometheus。</td>
</tr>
<tr>
<td>• <strong>缓存一致性</strong>：通过<code v-pre>@CacheEvict</code> + Redis Pub/Sub实现多节点同步。</td>
</tr>
</tbody>
</table>
<p><strong>生产案例</strong>：某物流系统通过RediSearch实现运单实时检索，查询响应时间从2秒优化至50毫秒，支撑日均千万级查询量。</p>
<p>通过扩展Redis的功能边界，企业能够在高并发、实时性要求极高的场景中，构建出高性能、可扩展的技术架构，充分释放Redis的潜能。</p>
<hr>
<h1 id="五、生产环境安全与运维最佳实践-1" tabindex="-1"><a class="header-anchor" href="#五、生产环境安全与运维最佳实践-1"><span><strong>五、生产环境安全与运维最佳实践</strong></span></a></h1>
<hr>
<h2 id="_1-安全防护体系" tabindex="-1"><a class="header-anchor" href="#_1-安全防护体系"><span><strong>1. 安全防护体系</strong></span></a></h2>
<h4 id="_1-1-acl权限控制与rbac模型实现" tabindex="-1"><a class="header-anchor" href="#_1-1-acl权限控制与rbac模型实现"><span><strong>1.1 ACL权限控制与RBAC模型实现</strong></span></a></h4>
<p>• <strong>ACL基础配置</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 创建运维账号（允许读写所有Key，禁止危险命令）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">ACL</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> SETUSER</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> opsuser</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ></span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">ops_password</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ~</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> &#x26;* +@all -FLUSHDB -KEYS  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 创建只读账号（仅允许读以"cache:"开头的Key）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">ACL</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> SETUSER</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> readonly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ></span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">read_password</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ~cache:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> &#x26;* +GET +HGET +LRANGE</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>RBAC模型集成</strong>：<br>
• <strong>角色定义</strong>：通过ACL定义角色（如<code v-pre>admin</code>、<code v-pre>developer</code>、<code v-pre>monitor</code>）。<br>
• <strong>权限分配</strong>：将用户绑定到角色，限制命令和数据访问范围。</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 定义角色  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">ACL</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> SETROLE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> admin</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> +@all</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">ACL</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> SETROLE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> developer</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> +GET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> +SET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ~app:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 用户绑定角色  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">ACL</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> SETUSER</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> alice</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ></span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">alice_pwd</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #admin  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">ACL</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> SETUSER</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> bob</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ></span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">bob_pwd</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #developer</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-tls加密传输配置-ssl-tls双向认证" tabindex="-1"><a class="header-anchor" href="#_1-2-tls加密传输配置-ssl-tls双向认证"><span><strong>1.2 TLS加密传输配置（SSL/TLS双向认证）</strong></span></a></h4>
<p>• <strong>生成证书</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 生成CA证书  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> genrsa</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -out</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ca.key</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 4096</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> req</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -x509</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -new</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -nodes</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -key</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ca.key</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -sha256</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -days</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 3650</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -out</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ca.crt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 生成服务端证书  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> genrsa</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -out</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis.key</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 2048</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> req</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -new</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -key</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis.key</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -out</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis.csr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> x509</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -req</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -in</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis.csr</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -CA</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ca.crt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -CAkey</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ca.key</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -CAcreateserial</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -out</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis.crt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -days</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 365</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 生成客户端证书（双向认证）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> genrsa</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -out</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> client.key</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 2048</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> req</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -new</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -key</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> client.key</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -out</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> client.csr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> x509</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -req</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -in</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> client.csr</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -CA</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ca.crt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -CAkey</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ca.key</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -CAcreateserial</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -out</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> client.crt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -days</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 365</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>Redis服务端配置</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># redis.conf  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">tls-port</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 6379</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">tls-cert-file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> /path/to/redis.crt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">tls-key-file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> /path/to/redis.key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">tls-ca-cert-file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> /path/to/ca.crt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">tls-auth-clients</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> yes</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  # 强制客户端证书验证</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-防注入攻击的lua脚本沙箱机制" tabindex="-1"><a class="header-anchor" href="#_1-3-防注入攻击的lua脚本沙箱机制"><span><strong>1.3 防注入攻击的Lua脚本沙箱机制</strong></span></a></h4>
<p>• <strong>安全限制配置</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 禁用危险命令（如os.execute）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">rename-command</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> EVAL</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ""</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">rename-command</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> SCRIPT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> ""</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 限制脚本执行时间（默认5秒）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">lua-time-limit</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 5000</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>沙箱化脚本示例</strong>：</p>
<div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- 仅允许访问指定Key前缀  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> allowed_prefix</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"app:"  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> not </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">string.match</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">KEYS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">], </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"^"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">..</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">allowed_prefix</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">then</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">error_reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"Access denied"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- 业务逻辑...</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr>
<h2 id="_2-备份与恢复方案" tabindex="-1"><a class="header-anchor" href="#_2-备份与恢复方案"><span><strong>2. 备份与恢复方案</strong></span></a></h2>
<h4 id="_2-1-rdb文件冷备与s3云存储集成" tabindex="-1"><a class="header-anchor" href="#_2-1-rdb文件冷备与s3云存储集成"><span><strong>2.1 RDB文件冷备与S3云存储集成</strong></span></a></h4>
<p>• <strong>自动化备份脚本</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#!/bin/bash  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">BACKUP_DIR</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"/backup/redis"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">DATE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">date</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> +%Y%m%d</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> SAVE</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  # 触发RDB生成  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> /var/lib/redis/dump.rdb</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> $BACKUP_DIR</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">/dump_</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">$DATE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">.rdb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 上传到S3  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">aws</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> s3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> cp</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> $BACKUP_DIR</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">/dump_</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">$DATE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">.rdb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> s3://my-redis-backup/</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>生命周期管理</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># S3生命周期策略（保留30天）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">aws</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> s3api</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> put-bucket-lifecycle-configuration</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --bucket</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> my-redis-backup</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2"> \ </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">  --lifecycle-configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> '{  </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">    "Rules": [{  </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">      "ID": "30DaysRetention",  </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">      "Status": "Enabled",  </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">      "Prefix": "",  </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">      "Expiration": { "Days": 30 }  </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">    }]  </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">  }'</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-aof日志实时同步到hdfs" tabindex="-1"><a class="header-anchor" href="#_2-2-aof日志实时同步到hdfs"><span><strong>2.2 AOF日志实时同步到HDFS</strong></span></a></h4>
<p>• <strong>Flume配置示例</strong>：</p>
<div class="language-properties line-numbers-mode" data-highlighter="shiki" data-ext="properties" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># flume.conf  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD">agent.sources</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379"> redisSource  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD">agent.sinks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379"> hdfsSink  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD">agent.channels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379"> memChannel  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD">agent.sources.redisSource.type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379"> exec  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD">agent.sources.redisSource.command</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379"> tail -F /var/log/redis/appendonly.aof  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD">agent.sources.redisSource.channels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379"> memChannel  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD">agent.sinks.hdfsSink.type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379"> hdfs  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD">agent.sinks.hdfsSink.hdfs.path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379"> hdfs://namenode:8020/redis/aof/%Y%m%d  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD">agent.sinks.hdfsSink.hdfs.filePrefix</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379"> aof  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD">agent.sinks.hdfsSink.hdfs.rollInterval</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379"> 3600</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-跨集群数据迁移-redis-port工具实战" tabindex="-1"><a class="header-anchor" href="#_2-3-跨集群数据迁移-redis-port工具实战"><span><strong>2.3 跨集群数据迁移（redis-port工具实战）</strong></span></a></h4>
<p>• <strong>数据同步流程</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 从源集群同步到目标集群  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">./redis-port</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> sync</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --from=src_redis:6379</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --target=dest_redis:6379</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 带密码迁移  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">./redis-port</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> sync</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --from=src_redis:6379</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --source-password=src_pass</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2"> \ </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">                 --target</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">dest_redis:6379</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> --target-password</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">dest_pass</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>断点续传配置</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 生成断点文件  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">./redis-port</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> sync</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --from=src_redis:6379</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --target=dest_redis:6379</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --resume-file=resume.log</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><hr>
<h2 id="_3-版本升级与故障处理" tabindex="-1"><a class="header-anchor" href="#_3-版本升级与故障处理"><span><strong>3. 版本升级与故障处理</strong></span></a></h2>
<h4 id="_3-1-集群滚动升级-从5-x到7-x兼容性处理" tabindex="-1"><a class="header-anchor" href="#_3-1-集群滚动升级-从5-x到7-x兼容性处理"><span><strong>3.1 集群滚动升级（从5.x到7.x兼容性处理）</strong></span></a></h4>
<p>• <strong>升级步骤</strong>：</p>
<ol>
<li><strong>逐个节点升级</strong>：<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 下线节点  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -h</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> node1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> CLUSTER</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> FAILOVER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -h</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> node1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> CLUSTER</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> RESET</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 停止旧进程，启动新版本Redis  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> stop</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis-node1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis-7.0.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> /usr/local/bin/redis-server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> start</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis-node1</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li><strong>验证协议兼容性</strong>：<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --cluster</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> check</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> new_node:6379</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div></li>
<li><strong>升级后修复</strong>：处理因版本差异导致的命令不兼容（如<code v-pre>MEMORY USAGE</code>行为变化）。</li>
</ol>
<h4 id="_3-2-热点key导致的cpu飙高问题定位" tabindex="-1"><a class="header-anchor" href="#_3-2-热点key导致的cpu飙高问题定位"><span><strong>3.2 热点Key导致的CPU飙高问题定位</strong></span></a></h4>
<p>• <strong>定位工具</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 使用redis-cli监控热点Key  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --hotkeys</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --intrinsic-latency</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 输出示例：  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># Hot key found: user:1001:profile (type: string, accesses: 123456)</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>优化方案</strong>：<br>
• <strong>本地缓存</strong>：将热点Key缓存到应用层（如Caffeine）。<br>
• <strong>分片处理</strong>：将<code v-pre>user:1001:profile</code>拆分为<code v-pre>user:1001:profile:part1</code>、<code v-pre>part2</code>等。</p>
<h4 id="_3-3-内存暴增的快速定位与oom防御" tabindex="-1"><a class="header-anchor" href="#_3-3-内存暴增的快速定位与oom防御"><span><strong>3.3 内存暴增的快速定位与OOM防御</strong></span></a></h4>
<p>• <strong>诊断步骤</strong>：</p>
<ol>
<li><strong>分析内存分布</strong>：<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --bigkeys</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> memory</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> stats</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "peak.allocated"</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li><strong>检查碎片率</strong>：<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> info</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> memory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> mem_fragmentation_ratio</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div>• <strong>应急处理</strong>：<br>
• <strong>临时扩容</strong>：调整<code v-pre>maxmemory</code>值并重启（需主从切换）。<br>
• <strong>逐出策略</strong>：切换为<code v-pre>allkeys-lru</code>释放内存。<br>
• <strong>防御措施</strong>：</li>
</ol>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 配置OOM保护（限制Redis可用内存）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> edit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis-server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 添加：MemoryLimit=16G</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr>
<h2 id="总结与生产级checklist" tabindex="-1"><a class="header-anchor" href="#总结与生产级checklist"><span><strong>总结与生产级Checklist</strong></span></a></h2>
<p>• <strong>安全运维Checklist</strong>：</p>
<ol>
<li>每月执行ACL权限审计，清理无用账号。</li>
<li>每季度更新TLS证书，并测试双向认证流程。</li>
<li>每日检查备份完整性（通过CRC校验RDB文件）。<br>
• <strong>故障应急手册</strong>：<br>
| <strong>故障现象</strong>        | <strong>处理步骤</strong>                         |
| ------------------- | ------------------------------------ |
| 内存OOM             | 1. 开启逐出策略 2. 分片大Key 3. 扩容 |
| 集群脑裂            | 1. 人工仲裁 2. 数据合并 3. 重置节点  |
| 热点Key导致服务雪崩 | 1. 本地缓存 2. 限流熔断 3. 分片设计  |</li>
</ol>
<p><strong>生产案例</strong>：某电商平台在“双11”大促期间，通过热点Key本地缓存+动态分片，成功将Redis CPU使用率从95%降至45%，保障了核心交易链路稳定。</p>
<p>通过严格的安全策略、可靠的备份恢复机制与系统的故障处理方案，Redis生产环境能够实现全年99.99%可用性，支撑企业关键业务的高效运行。</p>
<hr>
<h1 id="六、redis在云原生场景的实践-1" tabindex="-1"><a class="header-anchor" href="#六、redis在云原生场景的实践-1"><span><strong>六、Redis在云原生场景的实践</strong></span></a></h1>
<hr>
<h2 id="_1-kubernetes部署方案" tabindex="-1"><a class="header-anchor" href="#_1-kubernetes部署方案"><span><strong>1. Kubernetes部署方案</strong></span></a></h2>
<h4 id="_1-1-statefulset实现redis-cluster自动化部署" tabindex="-1"><a class="header-anchor" href="#_1-1-statefulset实现redis-cluster自动化部署"><span><strong>1.1 StatefulSet实现Redis Cluster自动化部署</strong></span></a></h4>
<p>• <strong>部署模板（YAML）</strong>：</p>
<div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">apps/v1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">StatefulSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis-cluster</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  serviceName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis-cluster</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  replicas</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">6</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  selector</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    matchLabels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      app</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      labels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        app</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      initContainers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">      - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        image</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis:7.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        command</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"/bin/sh"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"-c"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">]  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">          - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"echo 'cluster-enabled yes' >> /redis-config/redis.conf &#x26;&#x26;  </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">             echo 'cluster-node-timeout 5000' >> /redis-config/redis.conf"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        volumeMounts</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">          - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis-config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">            mountPath</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">/redis-config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      containers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">      - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        image</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis:7.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        ports</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">        - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">containerPort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">6379</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        volumeMounts</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">          - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis-data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">            mountPath</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">/data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">          - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis-config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">            mountPath</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">/usr/local/etc/redis/redis.conf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">            subPath</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis.conf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  volumeClaimTemplates</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis-data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      accessModes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: [ </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"ReadWriteOnce"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ]  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      storageClassName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"local-storage"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      resources</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        requests</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">          storage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">20Gi</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>集群初始化</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 创建Cluster（Pod IP需替换）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> exec</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -it</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis-cluster-0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --cluster</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> create</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2"> \ </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">  $(kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> pods</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -l</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> app=redis</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> jsonpath='{range.items[*]}{.status.podIP}:6379 '</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) --cluster-replicas 1</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-本地存储-local-pv-与网络延迟优化" tabindex="-1"><a class="header-anchor" href="#_1-2-本地存储-local-pv-与网络延迟优化"><span><strong>1.2 本地存储（Local PV）与网络延迟优化</strong></span></a></h4>
<p>• <strong>Local PV配置</strong>：</p>
<div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">v1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">PersistentVolume</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis-local-pv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    storage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">20Gi</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  volumeMode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">Filesystem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  accessModes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: [ </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"ReadWriteOnce"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ]  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  persistentVolumeReclaimPolicy</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">Retain</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  local</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">/mnt/redis-data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  nodeAffinity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    required</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      nodeSelectorTerms</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">      - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">matchExpressions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">        - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">kubernetes.io/hostname</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">          operator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">In</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">          values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: [ </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"node1"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ]  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 绑定到特定节点</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>网络优化策略</strong>：<br>
• <strong>Pod反亲和性</strong>：避免Redis主从节点部署在同一物理机。<br>
• <strong>NetworkPolicy</strong>：限制Redis Cluster Pod仅允许内部通信。</p>
<h4 id="_1-3-horizontal-pod-autoscaling动态扩缩容" tabindex="-1"><a class="header-anchor" href="#_1-3-horizontal-pod-autoscaling动态扩缩容"><span><strong>1.3 Horizontal Pod Autoscaling动态扩缩容</strong></span></a></h4>
<p>• <strong>HPA配置</strong>：</p>
<div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">autoscaling/v2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">HorizontalPodAutscaler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis-hpa</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  scaleTargetRef</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">apps/v1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">StatefulSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">redis-cluster</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  minReplicas</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  maxReplicas</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">12</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">  metrics</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">Resource</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    resource</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">cpu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">      target</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">Utilization</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">        averageUtilization</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">70</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>扩缩容触发条件</strong>：<br>
• <strong>CPU使用率</strong>：超过70%触发扩容，低于30%触发缩容。<br>
• <strong>自定义指标</strong>：通过Prometheus Adapter监控Redis QPS。</p>
<hr>
<h2 id="_2-混合云与多活架构" tabindex="-1"><a class="header-anchor" href="#_2-混合云与多活架构"><span><strong>2. 混合云与多活架构</strong></span></a></h2>
<h4 id="_2-1-阿里云redis与自建集群的混合订阅" tabindex="-1"><a class="header-anchor" href="#_2-1-阿里云redis与自建集群的混合订阅"><span><strong>2.1 阿里云Redis与自建集群的混合订阅</strong></span></a></h4>
<p>• <strong>跨云数据同步</strong>：<br>
• <strong>DTS（数据传输服务）</strong>：配置双向同步通道。<br>
<code v-pre>bash       # 阿里云DTS配置（控制台操作）       源库：自建Redis (192.168.1.100:6379)       目标库：阿里云Redis实例 (r-xxx.redis.rds.aliyuncs.com:6379)       同步对象：全量数据 + 增量数据       </code><br>
• <strong>客户端路由</strong>：通过Sharding-JDBC动态选择数据源。<br>
<code v-pre>java       ShardingRuleConfiguration config = new ShardingRuleConfiguration();       config.addShardingTableRule(&quot;user&quot;, new InlineShardingStrategy(&quot;id&quot;, &quot;user_${id % 2}&quot;));       DataSource dataSource = ShardingDataSourceFactory.createDataSource(createDataSourceMap(), config);       </code></p>
<h4 id="_2-2-aws-elasticache的vpc-peering配置" tabindex="-1"><a class="header-anchor" href="#_2-2-aws-elasticache的vpc-peering配置"><span><strong>2.2 AWS ElastiCache的VPC Peering配置</strong></span></a></h4>
<p>• <strong>VPC Peering流程</strong>：</p>
<ol>
<li><strong>创建VPC Peering连接</strong>：在AWS控制台中连接自建IDC VPC和ElastiCache VPC。</li>
<li><strong>路由表配置</strong>：添加Peering路由到双方子网。</li>
<li><strong>安全组规则</strong>：允许ElastiCache安全组接受来自自建IDC的6379端口流量。<br>
• <strong>客户端连接示例</strong>：</li>
</ol>
<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">JedisPoolConfig</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> poolConfig </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> JedisPoolConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">HostAndPort</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> hostAndPort </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> HostAndPort</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"elasticache-endpoint"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 6379</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">JedisCluster</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> jedisCluster </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> JedisCluster</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">(hostAndPort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 5000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 5000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "password"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75"> poolConfig)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr>
<h2 id="_3-serverless架构下的redis应用" tabindex="-1"><a class="header-anchor" href="#_3-serverless架构下的redis应用"><span><strong>3. Serverless架构下的Redis应用</strong></span></a></h2>
<h4 id="_3-1-函数计算-fc-中的redis连接池管理" tabindex="-1"><a class="header-anchor" href="#_3-1-函数计算-fc-中的redis连接池管理"><span><strong>3.1 函数计算（FC）中的Redis连接池管理</strong></span></a></h4>
<p>• <strong>连接池复用策略</strong>：</p>
<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 阿里云FC Python示例  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> redis  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> flask </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> Flask  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">app </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF"> Flask</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">__name__</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 全局连接池  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">pool </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> redis.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF">ConnectionPool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">host</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'r-xxx.redis.rds.aliyuncs.com'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">port</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">6379</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">password</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'password'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">r </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> redis.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF">Redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">connection_pool</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">pool)  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">@app</span><span style="--shiki-light:#4078F2;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">route</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'/get_data'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">def</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> get_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">():  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    value </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> r.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'key'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> value</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>冷启动优化</strong>：<br>
• <strong>预留实例</strong>：配置FC预留实例避免冷启动。<br>
• <strong>预热触发器</strong>：定时调用函数保持连接活跃。</p>
<h4 id="_3-2-冷启动场景下的缓存预热策略" tabindex="-1"><a class="header-anchor" href="#_3-2-冷启动场景下的缓存预热策略"><span><strong>3.2 冷启动场景下的缓存预热策略</strong></span></a></h4>
<p>• <strong>预热脚本设计</strong>：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 在函数实例启动时执行  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#!/bin/bash  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -h</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> $REDIS_HOST</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -p</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> $REDIS_PORT</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -a</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> $REDIS_PASS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> GET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "hot_key"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> > </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">/dev/null</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>预热效果验证</strong>：<br>
• <strong>监控指标</strong>：通过日志服务查看冷启动耗时（从500ms降至100ms）。</p>
<hr>
<h2 id="总结与生产案例" tabindex="-1"><a class="header-anchor" href="#总结与生产案例"><span><strong>总结与生产案例</strong></span></a></h2>
<p>• <strong>云原生实践要点</strong>：</p>
<table>
<thead>
<tr>
<th><strong>场景</strong></th>
<th><strong>关键技术</strong></th>
<th><strong>优化目标</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes部署</td>
<td>StatefulSet + Local PV</td>
<td>高可用、低延迟</td>
</tr>
<tr>
<td>混合云多活</td>
<td>VPC Peering + 双向同步</td>
<td>数据一致性、灾备恢复</td>
</tr>
<tr>
<td>Serverless应用</td>
<td>连接池复用 + 预热策略</td>
<td>降低冷启动影响、提升性能</td>
</tr>
</tbody>
</table>
<p>• <strong>生产案例</strong>：<br>
• <strong>案例1</strong>：某社交平台通过Kubernetes部署Redis Cluster，结合HPA动态扩缩容，应对流量峰值时自动从6节点扩展到12节点，CPU使用率稳定在60%。<br>
• <strong>案例2</strong>：跨境电商使用阿里云DTS + 自建Redis实现混合云多活，跨地域请求延迟从200ms降至50ms，数据同步误差率&lt;0.1%。</p>
<p><strong>实施建议</strong>：</p>
<ol>
<li><strong>监控先行</strong>：通过Prometheus监控Redis在云原生环境下的QPS、延迟、内存碎片率。</li>
<li><strong>混沌工程</strong>：定期模拟节点故障（如<code v-pre>kubectl delete pod</code>），验证自愈能力。</li>
<li><strong>成本优化</strong>：在AWS/Aliyun利用Spot实例或预留容量降低Redis云服务成本。</li>
</ol>
<p>通过云原生技术栈的深度整合，Redis能够灵活适应弹性扩缩、混合云架构与Serverless场景，为企业提供高性能、高可用的数据服务能力。</p>
<hr>
<h1 id="七、面试高频题解析与实战案例-1" tabindex="-1"><a class="header-anchor" href="#七、面试高频题解析与实战案例-1"><span><strong>七、面试高频题解析与实战案例</strong></span></a></h1>
<hr>
<h2 id="_1-大厂面试题精选" tabindex="-1"><a class="header-anchor" href="#_1-大厂面试题精选"><span><strong>1. 大厂面试题精选</strong></span></a></h2>
<h4 id="_1-1-redis如何实现分布式限流-令牌桶算法" tabindex="-1"><a class="header-anchor" href="#_1-1-redis如何实现分布式限流-令牌桶算法"><span><strong>1.1 Redis如何实现分布式限流（令牌桶算法）？</strong></span></a></h4>
<p>• <strong>令牌桶算法原理</strong>：</p>
<ol>
<li><strong>令牌生成</strong>：以固定速率向桶中添加令牌（如每秒10个）。</li>
<li><strong>请求处理</strong>：每个请求消耗一个令牌，桶空时拒绝请求。<br>
• <strong>Redis实现方案</strong>：</li>
</ol>
<div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- KEYS[1]: 限流Key  ARGV[1]: 令牌生成速率（个/秒）  ARGV[2]: 桶容量  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">KEYS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">]  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> rate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">])  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">])  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'TIME'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">]  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'HGETALL'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- 初始化或更新令牌桶  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> or #</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> == </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> then</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'HSET'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'tokens'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'HSET'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'last_time'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> last_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">])  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> elapsed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">last_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> new_tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">math.min</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">] + </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">elapsed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> * </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">rate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'HSET'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'tokens'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">new_tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'HSET'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'last_time'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">new_tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- 判断是否允许请求  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> >= </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> then</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'HINCRBY'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'tokens'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  -- 允许  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">  -- 拒绝  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">end</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>优化点</strong>：<br>
• <strong>集群限流</strong>：通过分片Key（如<code v-pre>rate_limit:user_1001</code>）分散压力。<br>
• <strong>熔断降级</strong>：结合Sentinel在限流后触发服务降级。</p>
<h4 id="_1-2-cluster模式下如何优雅处理节点失效" tabindex="-1"><a class="header-anchor" href="#_1-2-cluster模式下如何优雅处理节点失效"><span><strong>1.2 Cluster模式下如何优雅处理节点失效？</strong></span></a></h4>
<p>• <strong>自动恢复流程</strong>：</p>
<ol>
<li><strong>故障检测</strong>：Cluster节点通过Gossip协议检测节点下线。</li>
<li><strong>主从切换</strong>：从节点升主，更新集群拓扑。</li>
<li><strong>客户端重试</strong>：Smart Client自动处理<code v-pre>MOVED</code>/<code v-pre>ASK</code>重定向。<br>
• <strong>手动介入场景</strong>：<br>
• <strong>多节点宕机</strong>：需人工确认数据一致性后恢复。<br>
• <strong>网络分区</strong>：通过<code v-pre>CLUSTER FAILOVER FORCE</code>强制切换。<br>
• <strong>配置建议</strong>：</li>
</ol>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 设置故障转移超时时间（避免过早切换）  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">cluster-node-timeout</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 15000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># 最小从节点数  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">cluster-replica-no-failover</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> no</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-redis事务与mysql事务的acid对比" tabindex="-1"><a class="header-anchor" href="#_1-3-redis事务与mysql事务的acid对比"><span><strong>1.3 Redis事务与MySQL事务的ACID对比</strong></span></a></h4>
<table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>Redis事务</strong></th>
<th><strong>MySQL事务</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>原子性</strong></td>
<td>单命令原子，但事务内命令无回滚（仅语法错误回滚）</td>
<td>完全原子（支持回滚）</td>
</tr>
<tr>
<td><strong>一致性</strong></td>
<td>无约束（依赖业务逻辑）</td>
<td>强一致性（通过锁和日志）</td>
</tr>
<tr>
<td><strong>隔离性</strong></td>
<td>无隔离级别（所有命令串行执行）</td>
<td>支持Read Committed/Repeatable Read</td>
</tr>
<tr>
<td><strong>持久性</strong></td>
<td>依赖AOF配置（可配置为每秒同步）</td>
<td>依赖Redo Log和刷盘策略</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="_2-复杂场景设计题" tabindex="-1"><a class="header-anchor" href="#_2-复杂场景设计题"><span><strong>2. 复杂场景设计题</strong></span></a></h2>
<h4 id="_2-1-设计日活千万级的feed流系统" tabindex="-1"><a class="header-anchor" href="#_2-1-设计日活千万级的feed流系统"><span><strong>2.1 设计日活千万级的Feed流系统</strong></span></a></h4>
<p>• <strong>架构分层</strong>：</p>
<ol>
<li><strong>写扩散（Push）</strong>：大V发帖时，推送到粉丝的收件箱（Redis List）。<div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- 大V发帖时推送至粉丝收件箱  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> _</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">follower</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> in</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2"> ipairs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">followers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">do</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'LPUSH'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'feed:'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">..</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">follower</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">post_json</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'LTRIM'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'feed:'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">..</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">follower</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">999</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- 保留最新1000条  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">end</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li><strong>读扩散（Pull）</strong>：普通用户读取时，合并关注用户的收件箱。<div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">&#x3C;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">></span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> feeds </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> ArrayList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">&#x3C;></span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> followee </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">:</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75"> followees) {  </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">    List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">&#x3C;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF">></span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> posts </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">opsForList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">range</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"feed:"</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> followee, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">    feeds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">addAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(posts);</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75">}  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">// 按时间排序并分页  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">Collections</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">sort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(feeds, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">Comparator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">reverseOrder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">());</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li><strong>存储优化</strong>：<br>
◦ <strong>冷热分离</strong>：近期数据存Redis，历史数据存Elasticsearch。<br>
◦ <strong>分库分表</strong>：按用户ID哈希分16库，每库按时间分表。</li>
</ol>
<h4 id="_2-2-亿级用户实时排行榜方案" tabindex="-1"><a class="header-anchor" href="#_2-2-亿级用户实时排行榜方案"><span><strong>2.2 亿级用户实时排行榜方案</strong></span></a></h4>
<p>• <strong>存储设计</strong>：<br>
• <strong>Sorted Set</strong>：存储用户积分（<code v-pre>ZADD leaderboard 1000 &quot;user:1001&quot;</code>）。<br>
• <strong>分片策略</strong>：按范围分片（如<code v-pre>0-100万</code>、<code v-pre>100万-200万</code>）。<br>
• <strong>积分更新优化</strong>：</p>
<div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- 原子递增并更新时间戳（防止刷榜）  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> score</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'ZINCRBY'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">KEYS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">], </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">], </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">])  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'ZADD'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'leaderboard:timestamp'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">], </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">])  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">-- 超过阈值则扣减（如每分钟最多+100分）  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> score</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> > </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">]) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">then</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">'ZADD'</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">KEYS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">], </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">], </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">])  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">end</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>• <strong>查询优化</strong>：<br>
• <strong>缓存Top 100</strong>：每小时将排名结果缓存到String，降低ZRANGE压力。<br>
• <strong>异步计算</strong>：离线Job计算日榜/周榜，结果存MySQL。</p>
<hr>
<h2 id="_3-生产故障案例分析" tabindex="-1"><a class="header-anchor" href="#_3-生产故障案例分析"><span><strong>3. 生产故障案例分析</strong></span></a></h2>
<h4 id="_3-1-缓存穿透导致db雪崩复盘" tabindex="-1"><a class="header-anchor" href="#_3-1-缓存穿透导致db雪崩复盘"><span><strong>3.1 缓存穿透导致DB雪崩复盘</strong></span></a></h4>
<p>• <strong>事故背景</strong>：恶意请求大量不存在的商品ID，缓存未命中导致数据库QPS飙升。<br>
• <strong>根本原因</strong>：<br>
• 未设置空值缓存。<br>
• 未启用布隆过滤器拦截非法请求。<br>
• <strong>解决方案</strong>：</p>
<ol>
<li><strong>空值缓存</strong>：将查询为空的Key缓存5分钟。</li>
<li><strong>限流熔断</strong>：在网关层限制单个IP的请求频率。</li>
<li><strong>异步修复</strong>：通过Canal监听Binlog，预热热点数据。</li>
</ol>
<h4 id="_3-2-大促期间redis-cluster带宽打满应急处理" tabindex="-1"><a class="header-anchor" href="#_3-2-大促期间redis-cluster带宽打满应急处理"><span><strong>3.2 大促期间Redis Cluster带宽打满应急处理</strong></span></a></h4>
<p>• <strong>故障现象</strong>：某商品详情页访问量激增，Redis集群入口带宽达到10Gbps上限。<br>
• <strong>定位过程</strong>：</p>
<ol>
<li><strong>监控分析</strong>：发现<code v-pre>product:1001</code>的QPS超过50万，Value大小2MB（存储了完整商品描述）。</li>
<li><strong>热点Key</strong>：通过<code v-pre>redis-cli --hotkeys</code>确认热点Key。<br>
• <strong>应急措施</strong>：</li>
<li><strong>本地缓存</strong>：在应用层缓存商品描述，TTL=1秒。</li>
<li><strong>Value拆分</strong>：将描述信息拆分为<code v-pre>product:1001:base</code>（100字节）和<code v-pre>product:1001:detail</code>（异步加载）。</li>
<li><strong>客户端限流</strong>：限制单个服务实例的请求并发数。<br>
• <strong>后续优化</strong>：<br>
• <strong>数据压缩</strong>：使用Snappy压缩算法，Value大小减少70%。<br>
• <strong>CDN加速</strong>：静态资源（如商品图片）卸载到CDN。</li>
</ol>
<hr>
<h2 id="总结与面试技巧" tabindex="-1"><a class="header-anchor" href="#总结与面试技巧"><span><strong>总结与面试技巧</strong></span></a></h2>
<p>• <strong>问题拆解方法论</strong>：</p>
<ol>
<li><strong>明确需求</strong>：区分功能需求（如高并发读）与非功能需求（如一致性级别）。</li>
<li><strong>分层设计</strong>：从客户端、网关、服务、存储逐层优化。</li>
<li><strong>数据验证</strong>：通过压测工具（如JMeter）验证方案可行性。<br>
• <strong>高频考点延伸</strong>：<br>
• <strong>Redis vs Memcached</strong>：在数据结构、持久化、集群方案上的差异。<br>
• <strong>CAP权衡</strong>：在Redis Sentinel（AP）与Cluster（CP）之间的选择依据。<br>
• <strong>生产意识培养</strong>：<br>
• <strong>监控告警</strong>：任何方案必须配套监控（如大Key检测、慢查询分析）。<br>
• <strong>灰度发布</strong>：缓存策略变更时，先切流1%流量验证。</li>
</ol>
<p>通过系统性解析高频问题与实战案例，候选人可掌握从原理到落地的完整知识链，从容应对大厂面试与技术挑战。</p>
</div></template>


