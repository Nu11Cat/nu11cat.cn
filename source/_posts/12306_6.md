---
title: 组件/框架集成
topic: fang12306
---

## mybatis

添加依赖

```xml
<!-- 集成mybatis-->
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>3.0.0</version>
</dependency>

<!-- 集成mysql连接 -->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.22</version>
</dependency>
```

各模块配置

```properties
# 数据库连接
spring.datasource.url=jdbc:mysql://localhost:3306/train-member?characterEncoding=UTF8&autoReconnect=true&serverTimezone=Asia/Shanghai
spring.datasource.username=train
spring.datasource.password=123456
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# mybatis xml路径
mybatis.mapper-locations=classpath:/mapper/**/*.xml
logging.level.cn.nu11cat.train.member.mapper=trace
```

启动类添加

```java
@MapperScan("cn.nu11cat.train.*.mapper")
```

## mybatis生成器插件

添加插件

```xml
<build>
        <plugins>
            <!-- mybatis generator 自动生成代码插件 -->
            <plugin>
                <groupId>org.mybatis.generator</groupId>
                <artifactId>mybatis-generator-maven-plugin</artifactId>
                <version>1.4.0</version>
                <configuration>
					<!--<configurationFile>src/main/resources/generator-config-member.xml</configurationFile>-->
                    <configurationFile>src/main/resources/generator-config-business.xml</configurationFile>
					<!--<configurationFile>src/main/resources/generator-config-batch.xml</configurationFile>-->
                    <overwrite>true</overwrite>
                    <verbose>true</verbose>
                </configuration>
                <dependencies>
                    <dependency>
                        <groupId>mysql</groupId>
                        <artifactId>mysql-connector-java</artifactId>
                        <version>8.0.22</version>
                    </dependency>
                </dependencies>
            </plugin>
        </plugins>
    </build>
```

添加配置文件src/main/resources/generator-config-business.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE generatorConfiguration
        PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">

<generatorConfiguration>
    <context id="Mysql" targetRuntime="MyBatis3" defaultModelType="flat">

        <!-- 自动检查关键字，为关键字增加反引号 -->
        <property name="autoDelimitKeywords" value="true"/>
        <property name="beginningDelimiter" value="`"/>
        <property name="endingDelimiter" value="`"/>

        <!--覆盖生成XML文件-->
        <plugin type="org.mybatis.generator.plugins.UnmergeableXmlMappersPlugin" />
        <!-- 生成的实体类添加toString()方法 -->
        <plugin type="org.mybatis.generator.plugins.ToStringPlugin"/>

        <!-- 不生成注释 -->
        <commentGenerator>
            <property name="suppressAllComments" value="true"/>
        </commentGenerator>

        <!-- 配置数据源，需要根据自己的项目修改 -->
        <jdbcConnection driverClass="com.mysql.cj.jdbc.Driver"
                        connectionURL="jdbc:mysql://localhost:3306/train-business?serverTimezone=Asia/Shanghai"
                        userId="train"
                        password="123456">
        </jdbcConnection>

        <!-- domain类的位置 targetProject是相对pom.xml的路径-->
        <javaModelGenerator targetProject="../train-business/src/main/java"
                            targetPackage="cn.nu11cat.train.business.domain"/>

        <!-- mapper xml的位置 targetProject是相对pom.xml的路径 -->
        <sqlMapGenerator targetProject="../train-business/src/main/resources"
                         targetPackage="mapper"/>

        <!-- mapper类的位置 targetProject是相对pom.xml的路径 -->
        <javaClientGenerator targetProject="../train-business/src/main/java"
                             targetPackage="cn.nu11cat.train.business.mapper"
                             type="XMLMAPPER"/>

<!--        <table tableName="station" domainObjectName="Station"/>-->
<!--        <table tableName="train" domainObjectName="Train"/>-->
<!--        <table tableName="train_station" domainObjectName="TrainStation"/>-->
<!--        <table tableName="train_carriage" domainObjectName="TrainCarriage"/>-->
<!--        <table tableName="train_seat" domainObjectName="TrainSeat"/>-->
<!--        <table tableName="daily_train" domainObjectName="DailyTrain"/>-->
<!--        <table tableName="daily_train_station" domainObjectName="DailyTrainStation"/>-->
<!--        <table tableName="daily_train_carriage" domainObjectName="DailyTrainCarriage"/>-->
<!--        <table tableName="daily_train_seat" domainObjectName="DailyTrainSeat"/>-->
<!--        <table tableName="daily_train_ticket" domainObjectName="DailyTrainTicket"/>-->
<!--        <table tableName="confirm_order" domainObjectName="ConfirmOrder"/>-->
        <table tableName="sk_token" domainObjectName="SkToken"/>
    </context>
</generatorConfiguration>
```

在maven - generator - Plugins - mybatis-generator - mybatis-generator:generate双击启动

## Validation

Spring自带的校验框架

```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

在xxxxReq添加 `@NotBlank(message = "【手机号】不可为空")`

然后在controller请求参数前加上 `@Valid` ，相当于是否生效的开关

```java
@GetMapping("/query-list")
public CommonResp<PageResp<PassengerQueryResp>> queryList(@Valid PassengerQueryReq req){
    req.setMemberId(LoginMemberContext.getId());
    PageResp<PassengerQueryResp> list = passengerService.queryList(req);
    return new CommonResp<>(list);
}
```

## 雪花算法

hutool集成

common/util/SnowUtil类

```java
package cn.nu11cat.train.common.util;

import cn.hutool.core.util.IdUtil;

/**
 * 封装hutool雪花算法
 */
public class SnowUtil {

    private static long dataCenterId = 1;  //数据中心
    private static long workerId = 1;     //机器标识

    public static long getSnowflakeNextId() {
        return IdUtil.getSnowflake(workerId, dataCenterId).nextId();
    }

    public static String getSnowflakeNextIdStr() {
        return IdUtil.getSnowflake(workerId, dataCenterId).nextIdStr();
    }
}
```

在service中

```java
//新增会员
Member member1 = new Member();
//member1.setId(IdUtil.getSnowflake(1,1).nextId());
member1.setId(SnowUtil.getSnowflakeNextId());
member1.setMobile(mobile);
memberMapper.insert(member1);
return member1.getId();
```

## PageHelper分页

```xml
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper-spring-boot-starter</artifactId>
    <version>1.4.6</version>
</dependency>
```

PassengerQueryReq 继承 PageReq

接收：

```java
package cn.nu11cat.train.common.req;


import jakarta.validation.constraints.Max;
import jakarta.validation.constraints.NotNull;

public class PageReq {

    @NotNull(message = "【页码】不能为空")
    private Integer page;

    @NotNull(message = "【每页条数】不能为空")
    @Max(value = 100, message = "【每页条数】不能超过100")
    private Integer size;

    public Integer getPage() {
        return page;
    }

    public void setPage(Integer page) {
        this.page = page;
    }

    public Integer getSize() {
        return size;
    }

    public void setSize(Integer size) {
        this.size = size;
    }

    @Override
    public String toString() {
        return "PageReq{" +
                "page=" + page +
                ", size=" + size +
                '}';
    }
}
```

返回：

```java
package cn.nu11cat.train.common.resp;

import java.io.Serializable;
import java.util.List;

public class PageResp<T> implements Serializable {

    /**
     * 总条数
     */
    private Long total;

    /**
     * 当前页的列表
     */
    private List<T> list;

    public Long getTotal() {
        return total;
    }

    public void setTotal(Long total) {
        this.total = total;
    }

    public List<T> getList() {
        return list;
    }

    public void setList(List<T> list) {
        this.list = list;
    }

    @Override
    public String toString() {
        return "PageResp{" +
                "total=" + total +
                ", list=" + list +
                '}';
    }
}
```

```java
public PageResp<PassengerQueryResp> queryList(PassengerQueryReq req){
    PassengerExample passengerExample = new PassengerExample();
    PassengerExample.Criteria criteria = passengerExample.createCriteria();
    if(ObjectUtil.isNotNull(req.getMemberId())){
        criteria.andMemberIdEqualTo(req.getMemberId());
    }
    PageHelper.startPage(req.getPage(), req.getSize());
    LOG.info("查询页码：{}", req.getPage());
    LOG.info("每页条数：{}", req.getSize());

    List<Passenger> passengerList1 = passengerMapper.selectByExample(passengerExample);

    PageInfo<Passenger> pageInfo = new PageInfo<>(passengerList1);
    LOG.info("总行数：{}", pageInfo.getTotal());
    LOG.info("总页数：{}", pageInfo.getPages());

    List<PassengerQueryResp> list = BeanUtil.copyToList(passengerList1, PassengerQueryResp.class);
    PageResp<PassengerQueryResp> pageResp = new PageResp<>();
    pageResp.setTotal(pageInfo.getTotal());
    pageResp.setList(list);
    return pageResp;
}
```

## freemarker代码生成器

使用模板引擎freemarker按照模板文件生成java文件

```xml
<dependency>
    <groupId>org.freemarker</groupId>
    <artifactId>freemarker</artifactId>
</dependency>
```

train/generator

## DOM4j读取xml

```xml
<!-- 读xml -->
<dependency>
    <groupId>org.dom4j</groupId>
    <artifactId>dom4j</artifactId>
    <version>2.1.3</version>
</dependency>

<!-- https://mvnrepository.com/artifact/jaxen/jaxen -->
<dependency>
    <groupId>jaxen</groupId>
    <artifactId>jaxen</artifactId>
    <version>1.2.0</version>
</dependency>
```

generator/src/main/java/cn/nu11cat/train/generator/util/DbUtil.java

## quartz调度框架

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-quartz</artifactId>
</dependency>
```









## OpenFeign服务调用

微服务的服务间调用组件

```xml
<!--远程调用openfeign-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
<!--openfeign默认使用的是loadBalance的负载均衡器  -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-loadbalancer</artifactId>
</dependency>
```

通过train-batch/src/main/java/cn/nu11cat/train/batch/feign的类调用其他服务

被调用组件配置 `spring.application.name=business`

引入nacos配置中心之后，可以通过注解“认识”被调用组件：

```java
package cn.nu11cat.train.batch.feign;

import cn.nu11cat.train.common.resp.CommonResp;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

import java.util.Date;

@FeignClient(value = "business", fallback = BusinessFeignFallback.class)
//@FeignClient(name = "business", url = "http://127.0.0.1:8002/business")
//@FeignClient(value = "business")
public interface BusinessFeign {

    @GetMapping("/business/hello")
    String hello();

    //@GetMapping("/business/admin/daily-train/gen-daily/{date}")
    //CommonResp<Object> genDaily(@PathVariable @DateTimeFormat(pattern = "yyyy-MM-dd") Date date);

    @GetMapping("/admin/daily-train/gen-daily/{date}")
    CommonResp<Object> genDaily(@PathVariable("date") @DateTimeFormat(pattern = "yyyy-MM-dd") Date date);

}
```

并且在启动类添加：@EnableFeignClients("cn.nu11cat.train.batch.feign")



## kaptcha图形验证码





```xml
<!-- 图形验证码 升级到JDK17后，排除掉javax.servlet-api包 -->
<dependency>
    <groupId>com.github.penggle</groupId>
    <artifactId>kaptcha</artifactId>
    <version>2.3.2</version>
    <exclusions>
        <exclusion>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```



















